<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triage Pediatrique</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        h1 { text-align: center; color: #2c3e50; }
        .disclaimer {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        
        /* Mode switch */
        .mode-switch {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .mode-switch button {
            padding: 12px 30px;
            font-size: 1em;
            border: 2px solid #007bff;
            background: white;
            color: #007bff;
            cursor: pointer;
        }
        .mode-switch button:first-child { border-radius: 8px 0 0 8px; }
        .mode-switch button:last-child { border-radius: 0 8px 8px 0; }
        .mode-switch button:not(:first-child) { border-left: none; }
        .mode-switch button.active { background: #007bff; color: white; }
        
        #mode-triage, #mode-reverse, #mode-suivi { display: none; }
        #mode-triage.active, #mode-reverse.active, #mode-suivi.active { display: block; }
        
        /* Categories */
        .category {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .category h2 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            font-size: 1.2em;
        }
        .symptom-item { margin: 10px 0; }
        .symptom-item > label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
        }
        .symptom-item > label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
        .sub-options {
            display: none;
            margin-left: 35px;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }
        .sub-options.visible { display: block; }
        .sub-options label { display: block; margin: 5px 0; cursor: pointer; }
        .sub-options input[type="radio"],
        .sub-options input[type="checkbox"] { margin-right: 8px; }
        .red-flag { color: #dc3545; }
        .red-flag::after { content: " !!"; }
        
        /* Boutons */
        button#analyser {
            display: block;
            width: 100%;
            padding: 15px 30px;
            font-size: 1.2em;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 20px 0;
        }
        button#reset {
            display: block;
            width: 100%;
            padding: 10px;
            font-size: 1em;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        /* Resultats */
        #resultat { display: none; padding: 25px; border-radius: 10px; margin-top: 20px; }
        #resultat.niveau-rouge { background: #f8d7da; border: 2px solid #dc3545; }
        #resultat.niveau-orange { background: #ffe5d0; border: 2px solid #fd7e14; }
        #resultat.niveau-jaune { background: #fff3cd; border: 2px solid #ffc107; }
        #resultat.niveau-vert { background: #d4edda; border: 2px solid #28a745; }
        #resultat h3 { margin-top: 0; display: flex; align-items: center; gap: 10px; }
        
        .pathologies-probables, .conseils, .surveillance {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
        }
        .pathologies-probables h4, .conseils h4, .surveillance h4 { margin-top: 0; }
        
        /* Carte pathologie avec criteres */
        .patho-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ddd;
        }
        .patho-card.top { border: 2px solid #007bff; background: #f0f7ff; }
        .patho-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .patho-score {
            background: #007bff;
            color: white;
            padding: 3px 12px;
            border-radius: 12px;
            font-weight: bold;
        }
        .patho-desc { font-size: 0.9em; color: #666; margin-bottom: 10px; }
        
        /* Criteres colores */
        .criteres-box { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
        .critere-tag {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            display: inline-block;
        }
        .critere-attendu { background: #d4edfc; color: #1a5276; }
        .critere-exclusion { background: #fadbd8; color: #922b21; }
        .critere-match { box-shadow: 0 0 0 3px #27ae60; }
        
        /* Mode reference */
        .maladie-select {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .maladie-detail {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .maladie-detail h3 { margin-top: 0; color: #2c3e50; font-size: 1.4em; }
        .maladie-section {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
        }
        .maladie-section h4 { margin: 0 0 10px 0; font-size: 1em; }
        .maladie-section ul { margin: 0; padding-left: 20px; }
        .section-symptomes { background: #e3f2fd; border-left: 4px solid #2196f3; }
        .section-absents { background: #fff3e0; border-left: 4px solid #ff9800; }
        .section-alertes { background: #ffebee; border-left: 4px solid #f44336; }
        .section-conseils { background: #e8f5e9; border-left: 4px solid #4caf50; }
        .section-niveau {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .niveau-vert { background: #d4edda; color: #155724; }
        .niveau-jaune { background: #fff3cd; color: #856404; }
        .niveau-orange { background: #ffe5d0; color: #8a4500; }
        .niveau-rouge { background: #f8d7da; color: #721c24; }
        
        .alerte-rouge {
            background: linear-gradient(135deg, #dc3545, #c0392b);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        /* Mode Suivi */
        .suivi-header {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 20px;
        }
        .suivi-header select, .suivi-header input {
            padding: 10px;
            font-size: 1em;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .suivi-header select { flex: 1; min-width: 150px; }
        .suivi-header input[type="text"] { width: 120px; }
        .suivi-header input[type="number"] { width: 70px; }
        .suivi-header button {
            padding: 10px 15px;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn-add { background: #28a745; color: white; }
        .btn-del { background: #dc3545; color: white; }
        .btn-export { background: #17a2b8; color: white; }
        .btn-purge { background: #6c757d; color: white; }
        
        .constantes-form {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .constantes-form h3 { margin-top: 0; }
        .constantes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }
        .constante-input {
            display: flex;
            flex-direction: column;
        }
        .constante-input label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 4px;
        }
        .constante-input input, .constante-input select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        .constante-input input:focus { border-color: #007bff; outline: none; }
        
        /* EVA Wong-Baker */
        .eva-faces {
            display: flex;
            justify-content: space-between;
            gap: 5px;
        }
        .eva-face {
            flex: 1;
            text-align: center;
            padding: 5px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .eva-face:hover { background: #f0f0f0; }
        .eva-face.selected { border-color: #007bff; background: #e3f2fd; }
        .eva-face span { font-size: 1.5em; display: block; }
        .eva-face small { font-size: 0.7em; color: #666; }
        
        /* Tableau historique */
        .historique-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .historique-table th, .historique-table td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        .historique-table th {
            background: #007bff;
            color: white;
            font-weight: 500;
        }
        .historique-table tr:hover { background: #f8f9fa; }
        .val-alerte { background: #f8d7da !important; color: #721c24; font-weight: bold; }
        .val-warning { background: #fff3cd !important; color: #856404; }
        .val-ok { color: #155724; }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            background: white;
            border-radius: 10px;
        }
        
        .export-box {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Tooltip debug Ctrl+clic */
        .debug-tooltip {
            position: fixed;
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.85em;
            max-width: 350px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .debug-tooltip h4 { margin: 0 0 10px 0; color: #3498db; }
        .debug-tooltip .patho-list { margin: 0; padding-left: 15px; }
        .debug-tooltip .patho-list li { margin: 3px 0; }
        .debug-tooltip .no-patho { color: #e74c3c; font-style: italic; }
        .debug-tooltip .champ-info { color: #95a5a6; font-size: 0.9em; margin-bottom: 8px; }
    </style>
</head>
<body>

<h1>&#x1FA7A; Triage Pediatrique<br><small style="font-size:0.6em">Enfant 6-15 ans</small></h1>

<div class="disclaimer">
    <strong>&#x26A0; Cet outil ne remplace pas un avis medical.</strong><br>
    En cas d'urgence vitale, appelez le <strong>15</strong> ou le <strong>112</strong>.<br>
    <small style="color: #856404;">Outil d'aide a l'observation parentale - Non valide cliniquement - Traumatologie : urgences de base uniquement</small>
</div>

<div class="mode-switch">
    <button class="active" onclick="switchMode('triage')">&#x1F50D; Triage</button>
    <button onclick="switchMode('reverse')">&#x1F4D6; Reference</button>
    <button onclick="switchMode('suivi')">&#x1F4CA; Suivi 24h</button>
</div>

<div id="mode-triage" class="active">

    <div class="category">
        <h2>&#x2764; Etat General</h2>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="fievre" onchange="toggleSub(this)"> Fievre</label>
            <div class="sub-options" id="sub-fievre">
                <strong>Temperature :</strong><br>
                <label><input type="radio" name="temp" value="38"> 38 - 38.5C</label>
                <label><input type="radio" name="temp" value="38.5"> 38.5 - 39C</label>
                <label><input type="radio" name="temp" value="39"> 39 - 40C</label>
                <label class="red-flag"><input type="radio" name="temp" value="40"> &gt; 40C</label>
                <hr>
                <strong>Duree :</strong><br>
                <label><input type="radio" name="fievre-duree" value="1-2j"> 1-2 jours</label>
                <label><input type="radio" name="fievre-duree" value="3-4j"> 3-4 jours</label>
                <label><input type="radio" name="fievre-duree" value="5j-plus"> = 5 jours</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="fatigue" onchange="toggleSub(this)"> Fatigue inhabituelle</label>
            <div class="sub-options" id="sub-fatigue">
                <label><input type="radio" name="fatigue-level" value="legere"> Legere</label>
                <label><input type="radio" name="fatigue-level" value="marquee"> Marquee</label>
                <label class="red-flag"><input type="radio" name="fatigue-level" value="prostration"> Prostration</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="appetit"> Perte d'appetit</label>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="frissons"> Frissons / Sueurs</label>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="courbatures"> Courbatures intenses</label>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="douleur-yeux"> Douleur derriere les yeux</label>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="paleur" onchange="toggleSub(this)"> Paleur / Teint anormal</label>
            <div class="sub-options" id="sub-paleur">
                <label><input type="radio" name="paleur-type" value="pale"> Pale</label>
                <label><input type="radio" name="paleur-type" value="gris"> Teint gris</label>
                <label class="red-flag"><input type="radio" name="paleur-type" value="marbrures"> Marbrures</label>
            </div>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="douleurThorax"> Douleur thoracique</label>
        </div>
    </div>

    <div class="category" style="border-left: 4px solid #17a2b8;">
        <h2>&#x1F4CF; Constantes vitales (si mesurees)</h2>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="hasSpo2" onchange="toggleSub(this)"> SpO2 (saturation)</label>
            <div class="sub-options" id="sub-hasSpo2">
                <label><input type="radio" name="spo2-val" value="95"> = 95% (normale)</label>
                <label><input type="radio" name="spo2-val" value="92"> 92-94%</label>
                <label class="red-flag"><input type="radio" name="spo2-val" value="90"> &lt; 92%</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="hasFc" onchange="toggleSub(this)"> Frequence cardiaque</label>
            <div class="sub-options" id="sub-hasFc">
                <strong>Ã‚ge :</strong><br>
                <label><input type="radio" name="fc-age" value="6-8"> 6-8 ans (N: 70-110)</label>
                <label><input type="radio" name="fc-age" value="9-12"> 9-12 ans (N: 65-105)</label>
                <label><input type="radio" name="fc-age" value="13-15"> 13-15 ans (N: 60-100)</label>
                <hr>
                <label>FC mesuree : <input type="number" id="fc-value" min="40" max="220" style="width:80px"> bpm</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="hasFr" onchange="toggleSub(this)"> Frequence respiratoire</label>
            <div class="sub-options" id="sub-hasFr">
                <strong>Ã‚ge :</strong><br>
                <label><input type="radio" name="fr-age" value="6-8"> 6-8 ans (N: 18-24)</label>
                <label><input type="radio" name="fr-age" value="9-12"> 9-12 ans (N: 16-22)</label>
                <label><input type="radio" name="fr-age" value="13-15"> 13-15 ans (N: 12-20)</label>
                <hr>
                <label>FR mesuree : <input type="number" id="fr-value" min="8" max="60" style="width:80px"> /min</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="hasTa" onchange="toggleSub(this)"> Tension arterielle</label>
            <div class="sub-options" id="sub-hasTa">
                <label>Systolique : <input type="number" id="ta-sys" min="60" max="200" style="width:80px"> mmHg</label>
                <label>Diastolique : <input type="number" id="ta-dia" min="30" max="120" style="width:80px"> mmHg</label>
                <p style="font-size:0.8em;color:#666;margin-top:5px">Normal 6-15 ans : 90-120 / 55-80</p>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="hasGlycemie" onchange="toggleSub(this)"> Glycemie capillaire</label>
            <div class="sub-options" id="sub-hasGlycemie">
                <label>Valeur : <input type="number" id="glycemie-val" min="0.2" max="6" step="0.1" style="width:80px"> g/L</label>
                <p style="font-size:0.8em;color:#666;margin-top:5px">Normal : 0.7-1.1 g/L â€¢ Hypo &lt; 0.6 â€¢ Hyper &gt; 1.26</p>
            </div>
        </div>
    </div>

    <div class="category">
        <h2>&#x1F4A8; ORL / Respiratoire</h2>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="toux" onchange="toggleSub(this)"> Toux</label>
            <div class="sub-options" id="sub-toux">
                <strong>Type :</strong><br>
                <label><input type="radio" name="toux-type" value="seche"> Seche</label>
                <label><input type="radio" name="toux-type" value="grasse"> Grasse</label>
                <label><input type="radio" name="toux-type" value="aboyante"> Aboyante (rauque)</label>
                <label><input type="radio" name="toux-type" value="quinteuse"> Quinteuse</label>
                <label><input type="radio" name="toux-type" value="eternuements"> Eternuements</label>
                <hr>
                <strong>Duree :</strong><br>
                <label><input type="radio" name="toux-duree" value="recent"> Recente (&lt; 1 semaine)</label>
                <label><input type="radio" name="toux-duree" value="prolongee"> Prolongee (1-3 sem)</label>
                <label><input type="radio" name="toux-duree" value="chronique"> Chronique (&gt; 3 sem)</label>
                <hr>
                <strong>Si quinteuse :</strong><br>
                <label><input type="checkbox" name="toux-quinte" value="chantCoq"> Reprise inspiratoire (chant du coq)</label>
                <label><input type="checkbox" name="toux-quinte" value="vomissement"> Vomissements apres quinte</label>
                <label><input type="checkbox" name="toux-quinte" value="cyanose"> Cyanose pendant quinte</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="nez" onchange="toggleSub(this)"> Nez qui coule</label>
            <div class="sub-options" id="sub-nez">
                <label><input type="radio" name="nez-type" value="clair"> Clair</label>
                <label><input type="radio" name="nez-type" value="jaune"> Jaune/vert epais</label>
                <label><input type="radio" name="nez-type" value="sang"> Avec sang</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="gorge" onchange="toggleSub(this)"> Mal de gorge</label>
            <div class="sub-options" id="sub-gorge">
                <label><input type="radio" name="gorge-type" value="douleur"> Douleur simple</label>
                <label><input type="radio" name="gorge-type" value="avaler"> Difficulte a avaler</label>
                <label class="red-flag"><input type="radio" name="gorge-type" value="bave"> Bave / impossible d'avaler</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="voix"> Voix enrouee / eteinte</label>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="respiration" onchange="toggleSub(this)"> Difficultes respiratoires</label>
            <div class="sub-options" id="sub-respiration">
                <label><input type="radio" name="respi-type" value="rapide"> Respiration rapide</label>
                <label><input type="radio" name="respi-type" value="sifflante"> Sifflements</label>
                <label class="red-flag"><input type="radio" name="respi-type" value="tirage"> Tirage (creuse sous cotes)</label>
                <label class="red-flag"><input type="radio" name="respi-type" value="cyanose"> Levres bleues</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="oreille" onchange="toggleSub(this)"> Douleur d'oreille</label>
            <div class="sub-options" id="sub-oreille">
                <label><input type="checkbox" id="oreilleEcoul"> Ecoulement</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="anosmie"> Perte odorat / gout</label>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="difficulteParler"> Difficulte a parler / voix faible</label>
        </div>
    </div>

    <div class="category">
        <h2>&#x1F922; Digestif</h2>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="vomissements" onchange="toggleSub(this)"> Vomissements</label>
            <div class="sub-options" id="sub-vomissements">
                <strong>Type :</strong><br>
                <label><input type="radio" name="vomi-type" value="alimentaire"> Alimentaires</label>
                <label><input type="radio" name="vomi-type" value="bilieux"> Verdatres (bilieux)</label>
                <label class="red-flag"><input type="radio" name="vomi-type" value="sang"> Avec sang</label>
                <hr>
                <strong>Frequence :</strong><br>
                <label><input type="radio" name="vomi-freq" value="quelques"> Quelques episodes</label>
                <label><input type="radio" name="vomi-freq" value="repetes"> Repetes</label>
                <label class="red-flag"><input type="radio" name="vomi-freq" value="incoercible"> Incoercibles</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="diarrhee" onchange="toggleSub(this)"> Diarrhee</label>
            <div class="sub-options" id="sub-diarrhee">
                <strong>Type :</strong><br>
                <label><input type="radio" name="diarrhee-type" value="liquide"> Liquide</label>
                <label><input type="radio" name="diarrhee-type" value="glaires"> Avec glaires</label>
                <label class="red-flag"><input type="radio" name="diarrhee-type" value="sang"> Avec sang</label>
                <hr>
                <strong>Couleur :</strong><br>
                <label><input type="radio" name="diarrhee-couleur" value="normale"> Normale</label>
                <label><input type="radio" name="diarrhee-couleur" value="pale"> Pale/decoloree</label>
                <label class="red-flag"><input type="radio" name="diarrhee-couleur" value="sang"> Sanglante</label>
                <label class="red-flag"><input type="radio" name="diarrhee-couleur" value="noire"> Noire</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="nausees"> Nausees</label>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="douleurAbdo" onchange="toggleSub(this)"> Douleur abdominale</label>
            <div class="sub-options" id="sub-douleurAbdo">
                <strong>Localisation :</strong><br>
                <label><input type="radio" name="abdo-loc" value="diffuse"> Diffuse</label>
                <label><input type="radio" name="abdo-loc" value="periombilicale"> Autour nombril</label>
                <label><input type="radio" name="abdo-loc" value="fid"> Bas-ventre droit</label>
                <label><input type="radio" name="abdo-loc" value="epigastre"> Estomac</label>
                <hr>
                <label><input type="checkbox" name="abdo-carac" value="constante"> Douleur constante</label>
                <label><input type="checkbox" name="abdo-carac" value="crampes"> Crampes</label>
                <label><input type="checkbox" name="abdo-carac" value="migration"> Migration de la douleur</label>
                <label class="red-flag"><input type="checkbox" name="abdo-carac" value="defense"> Ventre dur (defense)</label>
                <hr>
                <strong>Signes appendice :</strong><br>
                <label><input type="checkbox" name="abdo-append" value="blumberg"> Douleur au relachement</label>
                <label><input type="checkbox" name="abdo-append" value="psoitis"> Douleur extension jambe</label>
                <label><input type="checkbox" name="abdo-append" value="rovsing"> Douleur cote oppose</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="constipation"> Constipation / Arret des gaz</label>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="deshydratation" onchange="toggleSub(this)"> Signes de deshydratation</label>
            <div class="sub-options" id="sub-deshydratation">
                <label><input type="checkbox" name="desh" value="soif"> Soif intense</label>
                <label><input type="checkbox" name="desh" value="bouche"> Bouche seche</label>
                <label class="red-flag"><input type="checkbox" name="desh" value="pli"> Pli cutane persistant</label>
                <label class="red-flag"><input type="checkbox" name="desh" value="yeux"> Yeux creux</label>
                <label class="red-flag"><input type="checkbox" name="desh" value="pasurines"> Pas d'urines &gt; 8h</label>
            </div>
        </div>
    </div>

    <div class="category">
        <h2>&#x1F3A8; Cutane</h2>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="eruption" onchange="toggleSub(this)"> Eruption cutanee</label>
            <div class="sub-options" id="sub-eruption">
                <strong>Type :</strong><br>
                <label><input type="radio" name="eruption-type" value="macules"> Taches rouges plates</label>
                <label><input type="radio" name="eruption-type" value="papules"> Boutons en relief</label>
                <label><input type="radio" name="eruption-type" value="vesicules"> Petites cloques (avec liquide)</label>
                <label><input type="radio" name="eruption-type" value="urticaire"> Plaques qui grattent</label>
                <label class="red-flag"><input type="radio" name="eruption-type" value="purpura"> Ne s'efface PAS a la pression</label>
                <hr>
                <strong>Localisation :</strong><br>
                <label><input type="checkbox" name="eruption-loc" value="visage"> Visage</label>
                <label><input type="checkbox" name="eruption-loc" value="tronc"> Tronc</label>
                <label><input type="checkbox" name="eruption-loc" value="membres"> Membres</label>
                <label><input type="checkbox" name="eruption-loc" value="palmoplantaire"> Paumes/plantes</label>
                <hr>
                <label><input type="checkbox" id="eruptionGratte"> Demangeaisons</label>
                <hr>
                <strong>Texture :</strong><br>
                <label><input type="checkbox" name="eruption-texture" value="rugueuse"> Rugueuse (papier de verre)</label>
                <label><input type="checkbox" name="eruption-texture" value="desquamation"> Peau qui pele</label>
                <hr>
                <strong>Evolution :</strong><br>
                <label><input type="radio" name="eruption-evolution" value="centrifuge"> Du centre vers exterieur</label>
                <label><input type="radio" name="eruption-evolution" value="centripete"> De l'exterieur vers centre</label>
                <label><input type="radio" name="eruption-evolution" value="simultanee"> Apparition simultanee</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="aphtes"> Aphtes / lesions buccales</label>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="oedeme" onchange="toggleSub(this)"> Gonflement (oedeme)</label>
            <div class="sub-options" id="sub-oedeme">
                <label><input type="radio" name="oedeme-loc" value="visage"> Visage</label>
                <label class="red-flag"><input type="radio" name="oedeme-loc" value="levres"> Levres/langue</label>
                <label><input type="radio" name="oedeme-loc" value="membres"> Membres</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="ictere"> Jaunisse (yeux/peau jaunes)</label>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="saignements" onchange="toggleSub(this)"> Saignements spontanes</label>
            <div class="sub-options" id="sub-saignements">
                <label><input type="checkbox" name="saign" value="nez"> Nez</label>
                <label><input type="checkbox" name="saign" value="gencives"> Gencives</label>
                <label><input type="checkbox" name="saign" value="ecchymoses"> Bleus spontanes</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="plaie" onchange="toggleSub(this)"> Plaie / Griffure</label>
            <div class="sub-options" id="sub-plaie">
                <strong>Type :</strong><br>
                <label><input type="radio" name="plaie-type" value="superficielle"> Superficielle (egratignure)</label>
                <label><input type="radio" name="plaie-type" value="coupure"> Coupure nette</label>
                <label><input type="radio" name="plaie-type" value="contuse"> Contuse (bords irreguliers)</label>
                <label class="red-flag"><input type="radio" name="plaie-type" value="profonde"> Profonde (graisse/muscle visible)</label>
                <label class="red-flag"><input type="radio" name="plaie-type" value="morsure"> Morsure animale/humaine</label>
                <hr>
                <strong>Saignement :</strong><br>
                <label><input type="radio" name="plaie-saignement" value="minime"> Minime (s'arrete seul)</label>
                <label><input type="radio" name="plaie-saignement" value="modere"> Modere (compression 10 min)</label>
                <label class="red-flag"><input type="radio" name="plaie-saignement" value="abondant"> Abondant (sang rouge vif, jet)</label>
                <label class="red-flag"><input type="radio" name="plaie-saignement" value="arteriel"> Arteriel (jet saccade)</label>
                <hr>
                <strong>Localisation :</strong><br>
                <label><input type="checkbox" name="plaie-loc" value="visage"> Visage</label>
                <label><input type="checkbox" name="plaie-loc" value="main"> Main / doigts</label>
                <label><input type="checkbox" name="plaie-loc" value="articulation"> Sur articulation</label>
                <label><input type="checkbox" name="plaie-loc" value="cuirchevelu"> Cuir chevelu</label>
                <label><input type="checkbox" name="plaie-loc" value="membre"> Membre</label>
                <hr>
                <strong>Signes associes :</strong><br>
                <label><input type="checkbox" id="plaieCorpsEtranger"> Corps etranger visible</label>
                <label><input type="checkbox" id="plaieSale"> Plaie souilee (terre, rouille)</label>
                <label class="red-flag"><input type="checkbox" id="plaieMobiliteReduite"> Perte de mobilite/sensibilite</label>
            </div>
        </div>
    </div>

    <div class="category">
        <h2>&#x1F9E0; Neurologique</h2>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="cephalee" onchange="toggleSub(this)"> Maux de tete</label>
            <div class="sub-options" id="sub-cephalee">
                <label><input type="radio" name="cephalee-type" value="modere"> Moderes</label>
                <label><input type="radio" name="cephalee-type" value="intense"> Intenses</label>
                <label class="red-flag"><input type="radio" name="cephalee-type" value="brutal"> Brutal et intense ("pire de ma vie")</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label class="red-flag"><input type="checkbox" id="raideurNuque" onchange="toggleSub(this)"> Raideur de nuque</label>
            <div class="sub-options" id="sub-raideurNuque">
                <strong>Signes meninges specifiques :</strong><br>
                <label class="red-flag"><input type="checkbox" id="kernig"> Signe de Kernig (douleur quand on tend la jambe, enfant couche)</label>
                <label class="red-flag"><input type="checkbox" id="brudzinski"> Signe de Brudzinski (jambes se plient quand on penche la tete)</label>
            </div>
        </div>
        <div class="symptom-item">
            <label class="red-flag"><input type="checkbox" id="convulsions"> Convulsions</label>
        </div>
        <div class="symptom-item">
            <label class="red-flag"><input type="checkbox" id="confusion"> Confusion / somnolence anormale</label>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="vertiges"> Vertiges</label>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="photophobie"> Gene a la lumiere</label>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="visionTrouble"> Vision trouble / double</label>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="paupieresTombantes"> Paupieres tombantes</label>
        </div>
        <div class="symptom-item">
            <label class="red-flag"><input type="checkbox" id="faiblesseMusculaire"> Faiblesse musculaire</label>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="paresthesies"> Fourmillements / engourdissements</label>
        </div>
    </div>

    <div class="category">
        <h2>&#x2754; Autres signes</h2>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="ganglions" onchange="toggleSub(this)"> Ganglions</label>
            <div class="sub-options" id="sub-ganglions">
                <label><input type="radio" name="ganglions-loc" value="cou"> Cou</label>
                <label><input type="radio" name="ganglions-loc" value="aisselles"> Aisselles</label>
                <label><input type="radio" name="ganglions-loc" value="aines"> Aines</label>
                <label><input type="radio" name="ganglions-loc" value="multiples"> Plusieurs zones</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="yeux" onchange="toggleSub(this)"> Probleme aux yeux</label>
            <div class="sub-options" id="sub-yeux">
                <label><input type="checkbox" name="yeux-type" value="rouge"> Rouges</label>
                <label><input type="checkbox" name="yeux-type" value="colles"> Colles / secretions</label>
                <label><input type="checkbox" name="yeux-type" value="larmoie"> Larmoiement</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="langue" onchange="toggleSub(this)"> Aspect de la langue</label>
            <div class="sub-options" id="sub-langue">
                <label><input type="radio" name="langue-type" value="saburrale"> Blanche/chargee</label>
                <label><input type="radio" name="langue-type" value="framboise"> Rouge vif "framboisee"</label>
                <label><input type="radio" name="langue-type" value="seche"> Tres seche</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="levresFissures"> Levres rouges, fissurees</label>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="douleurArticulaire" onchange="toggleSub(this)"> Douleurs articulaires</label>
            <div class="sub-options" id="sub-douleurArticulaire">
                <label><input type="radio" name="artic-intensite" value="legere"> Legeres</label>
                <label><input type="radio" name="artic-intensite" value="moderee"> Moderees</label>
                <label><input type="radio" name="artic-intensite" value="intense"> Intenses</label>
            </div>
        </div>
    </div>

    <div class="category">
        <h2>&#x1F6BD; Urinaire</h2>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="urinaire" onchange="toggleSub(this)"> Problemes urinaires</label>
            <div class="sub-options" id="sub-urinaire">
                <label><input type="checkbox" name="urinaire-types" value="brulure"> Brulures mictionnelles</label>
                <label><input type="checkbox" name="urinaire-types" value="frequent"> Envies frequentes</label>
                <label><input type="checkbox" name="urinaire-types" value="urgence"> Urgences mictionnelles</label>
                <label class="red-flag"><input type="checkbox" name="urinaire-types" value="sang"> Sang dans urines</label>
            </div>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="urinesCouleur" onchange="toggleSub(this)"> Urines anormales</label>
            <div class="sub-options" id="sub-urinesCouleur">
                <label><input type="radio" name="urines-couleur" value="fonce"> Foncees (the)</label>
                <label><input type="radio" name="urines-couleur" value="trouble"> Troubles</label>
                <label class="red-flag"><input type="radio" name="urines-couleur" value="sang"> Sanglantes</label>
            </div>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="douleurLombaire"> Douleur lombaire (dos)</label>
        </div>
    </div>

    <div class="category">
        <h2>&#x1F9B4; Osteo-articulaire</h2>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="douleurMembre" onchange="toggleSub(this)"> Douleur membre</label>
            <div class="sub-options" id="sub-douleurMembre">
                <label><input type="checkbox" name="membre-signes" value="gonfle"> Gonfle</label>
                <label><input type="checkbox" name="membre-signes" value="rouge"> Rouge/chaud</label>
                <label><input type="checkbox" name="membre-signes" value="boiterie"> Boiterie</label>
            </div>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="douleurEpaule"> Douleur epaule</label>
        </div>
    </div>

    <div class="category" style="border-left: 4px solid #e74c3c;">
        <h2>&#x1F915; Traumatologie</h2>
        <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">
            &#x26A0; Pour tout traumatisme grave, appeler le 15 ou consulter aux urgences.
        </p>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="traumaCrane" onchange="toggleSub(this)"> Traumatisme cranien (choc a la tete)</label>
            <div class="sub-options" id="sub-traumaCrane">
                <label class="red-flag"><input type="checkbox" id="traumaPCI"> Perte de connaissance (meme breve)</label>
                <label><input type="checkbox" id="traumaAmnesia"> Ne se souvient pas du choc</label>
            </div>
        </div>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="traumaMembre" onchange="toggleSub(this)"> Traumatisme d'un membre</label>
            <div class="sub-options" id="sub-traumaMembre">
                <strong>Signes observes :</strong><br>
                <label class="red-flag"><input type="checkbox" id="traumaDeformation"> Deformation visible</label>
                <label class="red-flag"><input type="checkbox" id="traumaOuvert"> Plaie avec os visible</label>
                <label><input type="checkbox" id="traumaInstabilite"> Articulation instable / "lache"</label>
                <label><input type="checkbox" id="traumaCraquement"> Craquement entendu</label>
                <label><input type="checkbox" id="traumaGonflement"> Gonflement rapide (&lt; 1h)</label>
                <label><input type="checkbox" id="traumaHematome"> Hematome / bleu important</label>
                <label><input type="checkbox" id="traumaImpotence"> Impossibilite totale de bouger</label>
                <label><input type="checkbox" id="traumaAppuiPossible"> Appui/mouvement possible mais douloureux</label>
                <hr>
                <strong>Zone touchee :</strong><br>
                <label><input type="checkbox" name="trauma-zone" value="epaule"> Epaule</label>
                <label><input type="checkbox" name="trauma-zone" value="coude"> Coude</label>
                <label><input type="checkbox" name="trauma-zone" value="poignet"> Poignet</label>
                <label><input type="checkbox" name="trauma-zone" value="doigt"> Doigt</label>
                <label><input type="checkbox" name="trauma-zone" value="hanche"> Hanche</label>
                <label><input type="checkbox" name="trauma-zone" value="genou"> Genou</label>
                <label><input type="checkbox" name="trauma-zone" value="cheville"> Cheville</label>
                <hr>
                <strong>Mecanisme :</strong><br>
                <label><input type="radio" name="trauma-mecanisme" value="chute"> Chute</label>
                <label><input type="radio" name="trauma-mecanisme" value="torsion"> Torsion / faux mouvement</label>
                <label><input type="radio" name="trauma-mecanisme" value="choc"> Choc direct</label>
                <label><input type="radio" name="trauma-mecanisme" value="etirement"> Etirement / traction</label>
            </div>
        </div>
    </div>

    <div class="category">
        <h2>&#x1F6B9; Genital (garcon)</h2>
        
        <div class="symptom-item">
            <label class="red-flag"><input type="checkbox" id="douleurTesticule" onchange="toggleSub(this)"> Douleur testiculaire</label>
            <div class="sub-options" id="sub-douleurTesticule">
                <strong>Debut :</strong><br>
                <label class="red-flag"><input type="radio" name="testicule-debut" value="brutal"> Brutal</label>
                <label><input type="radio" name="testicule-debut" value="progressif"> Progressif</label>
                <hr>
                <label><input type="checkbox" name="testicule-signes" value="gonfle"> Gonfle</label>
                <label><input type="checkbox" name="testicule-signes" value="haut"> Remonte</label>
                <label><input type="checkbox" name="testicule-signes" value="rouge"> Rouge</label>
            </div>
        </div>
    </div>

    <div class="category">
        <h2>&#x1F6BA; Gynecologique</h2>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="douleurPelvienne" onchange="toggleSub(this)"> Douleur pelvienne</label>
            <div class="sub-options" id="sub-douleurPelvienne">
                <strong>Debut :</strong><br>
                <label class="red-flag"><input type="radio" name="pelvien-debut" value="brutal"> Brutal</label>
                <label><input type="radio" name="pelvien-debut" value="progressif"> Progressif</label>
            </div>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="metrorragies"> Saignements vaginaux anormaux</label>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="retardRegles"> Retard de regles</label>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="grossessePossible"> Grossesse possible</label>
        </div>
    </div>

    <div class="category" style="border-left: 4px solid #20c997;">
        <h2>&#x1F4CB; Contexte / Terrain</h2>
        
        <div class="symptom-item">
            <label><input type="checkbox" id="repasSuspect"> Repas suspect &lt; 48h</label>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="conserveMaison"> Conserve maison</label>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="collectivite"> Cas groupes (ecole, famille)</label>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="baignade"> Baignade riviere recente</label>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="drepanocytose"> Drepanocytose connue</label>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="asthme" onchange="toggleSub(this)"> Asthme connu</label>
            <div class="sub-options" id="sub-asthme">
                <strong>Declencheurs recents :</strong><br>
                <label><input type="checkbox" name="asthme-trigger" value="effort"> Effort physique</label>
                <label><input type="checkbox" name="asthme-trigger" value="allergie"> Contact allergene (pollen, poussiere, animal)</label>
                <label><input type="checkbox" name="asthme-trigger" value="infection"> Infection respiratoire</label>
                <label><input type="checkbox" name="asthme-trigger" value="froid"> Air froid</label>
            </div>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="immunodepression"> Immunodeprime</label>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="zonePalu" onchange="toggleSub(this)"> Sejour zone impaludee</label>
            <div class="sub-options" id="sub-zonePalu">
                <label><input type="radio" name="palu-zone" value="afrique"> Afrique</label>
                <label><input type="radio" name="palu-zone" value="asie"> Asie SE</label>
                <label><input type="radio" name="palu-zone" value="amazonie"> Amazonie</label>
            </div>
        </div>
        <div class="symptom-item">
            <label><input type="checkbox" id="vaccins" onchange="toggleSub(this)"> Statut vaccinal</label>
            <div class="sub-options" id="sub-vaccins">
                <label><input type="radio" name="vaccin-statut" value="ajour"> A jour</label>
                <label><input type="radio" name="vaccin-statut" value="incomplet"> Incomplet</label>
                <label><input type="radio" name="vaccin-statut" value="inconnu"> Inconnu</label>
            </div>
        </div>
    </div>

    <button id="analyser" onclick="analyser()">&#x1F50E; ANALYSER</button>
    <button id="exporter" onclick="exporterSymptomes()" style="display:block;width:100%;padding:12px;font-size:1em;background:#17a2b8;color:white;border:none;border-radius:8px;cursor:pointer;margin-bottom:10px;">&#x1F4CB; Exporter symptomes</button>
    <button id="reset" onclick="resetForm()">? Reinitialiser</button>
    
    <div id="resultat"></div>
</div>

<div id="mode-reverse">
    <select class="maladie-select" id="maladie-select" onchange="afficherMaladie()">
        <option value="">&#x1F4D6; Choisissez une pathologie</option>
    </select>
    <div id="maladie-detail"></div>
</div>

<div id="mode-suivi">
    <!-- Gestion patients -->
    <div class="suivi-header">
        <select id="patient-select" onchange="chargerPatient()">
            <option value="">&#x1F464; Selectionner un patient</option>
        </select>
        <input type="text" id="new-patient-prenom" placeholder="Prenom">
        <input type="text" id="new-patient-initiale" placeholder="M." maxlength="2" style="width:50px">
        <input type="number" id="new-patient-age" placeholder="Ã‚ge" min="6" max="15">
        <button class="btn-add" onclick="ajouterPatient()">+ Ajouter</button>
        <button class="btn-del" onclick="supprimerPatient()">>&#x1F5D1;</button>
    </div>
    
    <!-- Formulaire saisie constantes -->
    <div id="constantes-form-container" style="display:none;">
        <div class="constantes-form">
            <h3>&#x1F4DD; Nouvelle mesure pour <span id="patient-nom-display"></span></h3>
            <div class="constantes-grid">
                <div class="constante-input">
                    <label>&#x1F321; Temperature (C)</label>
                    <input type="number" id="c-temp" step="0.1" min="35" max="42" placeholder="37.5">
                </div>
                <div class="constante-input">
                    <label>&#x1F493; FC (bpm)</label>
                    <input type="number" id="c-fc" min="40" max="220" placeholder="80">
                </div>
                <div class="constante-input">
                    <label>&#x1F4A8; FR (/min)</label>
                    <input type="number" id="c-fr" min="8" max="60" placeholder="18">
                </div>
                <div class="constante-input">
                    <label>&#x1F9EA; SpO2 (%)</label>
                    <input type="number" id="c-spo2" min="70" max="100" placeholder="98">
                </div>
                <div class="constante-input">
                    <label>&#x1F4C8; TA sys (mmHg)</label>
                    <input type="number" id="c-ta-sys" min="60" max="200" placeholder="110">
                </div>
                <div class="constante-input">
                    <label>&#x1F4C9; TA dia (mmHg)</label>
                    <input type="number" id="c-ta-dia" min="30" max="120" placeholder="70">
                </div>
                <div class="constante-input">
                    <label>&#x1F36C; Glycemie (g/L)</label>
                    <input type="number" id="c-glycemie" step="0.01" min="0.2" max="6" placeholder="0.9">
                </div>
                <div class="constante-input">
                    <label>&#x1F6BD; Derniere miction</label>
                    <input type="time" id="c-miction">
                </div>
                <div class="constante-input">
                    <label>&#x1F4A7; Hydratation (mL)</label>
                    <input type="number" id="c-hydratation" min="0" max="2000" step="50" placeholder="200">
                </div>
            </div>
            
            <!-- EVA Douleur -->
            <div style="margin-top:15px;">
                <label style="font-size:0.85em;color:#666;">&#x1F915; Douleur (EVA Wong-Baker)</label>
                <div class="eva-faces" id="eva-container">
                    <div class="eva-face" data-val="0" onclick="selectEva(this)"><span>&#x1F600;</span><small>0</small></div>
                    <div class="eva-face" data-val="2" onclick="selectEva(this)"><span>&#x1F642;</span><small>2</small></div>
                    <div class="eva-face" data-val="4" onclick="selectEva(this)"><span>&#x1F610;</span><small>4</small></div>
                    <div class="eva-face" data-val="6" onclick="selectEva(this)"><span>&#x1F641;</span><small>6</small></div>
                    <div class="eva-face" data-val="8" onclick="selectEva(this)"><span>&#x1F62D;</span><small>8</small></div>
                    <div class="eva-face" data-val="10" onclick="selectEva(this)"><span>&#x1F631;</span><small>10</small></div>
                </div>
            </div>
            
            <button id="btn-enregistrer" style="margin-top:20px;" onclick="enregistrerConstantes()">&#x1F4BE; Enregistrer</button>
        </div>
        
        <!-- Historique -->
        <h3>&#x1F4C8; Historique des mesures</h3>
        <div id="historique-container"></div>
        
        <!-- Actions -->
        <div style="display:flex;gap:10px;margin-top:15px;flex-wrap:wrap;">
            <button class="btn-export" onclick="exporterSuivi()">&#x1F4E4; Exporter pour medecin</button>
            <button class="btn-purge" onclick="purgerPatient()">&#x1F5D1; Purger historique</button>
        </div>
        <div id="export-container"></div>
    </div>
    
    <div id="no-patient-msg" class="no-data">
        <p>&#x1F464; Selectionnez ou ajoutez un patient pour commencer le suivi.</p>
    </div>
</div>




<script>



// ============================================
// MALADIES DB - REFERENTIEL BIJECTIF COMPLET
// 68 maladies avec mapping HTML
// ============================================

const maladiesDB = {

    // ============================================
    // ORL / RESPIRATOIRE
    // ============================================

    rhinopharyngite: {
        nom: "Rhinopharyngite (rhume)",
        description: "Infection virale benigne des voies respiratoires superieures. Tres frequente, guerit spontanement en 7-10 jours.",
        niveau: "vert",
        criteres: [
            { texte: "Nez qui coule", champ: "nez", op: "==", val: true },
            { texte: "Eternuements", champ: "touxType", op: "==", val: "eternuements" },
            { texte: "Toux legere", champ: "toux", op: "==", val: true },
            { texte: "Fievre moderee (< 38.5C)", champ: "temp", op: "<", val: 38.5 },
            { texte: "Mal de gorge leger", champ: "gorge", op: "==", val: true },
            { texte: "Mal de gorge leger", champ: "gorgeType", op: "==", val: "douleur" },
            { texte: "Legere fatigue", champ: "fatigue", op: "==", val: true },
            { texte: "Legere fatigue", champ: "fatigueLevel", op: "==", val: "legere" }
        ],
        exclusions: [
            { texte: "Fievre elevee (> 39C)", champ: "temp", op: ">=", val: 39 },
            { texte: "Difficultes respiratoires", champ: "respiration", op: "==", val: true },
            { texte: "Raideur de nuque", champ: "raideurNuque", op: "==", val: true },
            { texte: "Prostration", champ: "fatigueLevel", op: "==", val: "prostration" }
        ],
        urgence: null,
        alertes: [
            "Fievre > 38.5C persistant plus de 48-72h",
            "Douleur d'oreille (otite secondaire)",
            "Difficultes respiratoires",
            "Refus de boire"
        ],
        conseils: [
            "Hydratation reguliere",
            "Lavage de nez au serum physiologique",
            "Repos",
            "Paracetamol si fievre ou inconfort"
        ],
        nonFaire: [
            "Antibiotiques (inefficaces contre les virus)"
        ]
    },

    angine: {
        nom: "Angine",
        description: "Infection des amygdales, virale (70-80%) ou bacterienne (streptocoque). Le test rapide (TROD) en pharmacie permet de differencier.",
        niveau: "jaune",
        criteres: [
            { texte: "Mal de gorge intense", champ: "gorge", op: "==", val: true },
            { texte: "Difficulte a avaler", champ: "gorgeType", op: "==", val: "avaler" },
            { texte: "Fievre", champ: "fievre", op: "==", val: true },
            { texte: "Fievre (38-39C)", champ: "temp", op: ">=", val: 38 },
            { texte: "Ganglions du cou", champ: "ganglions", op: "==", val: true },
            { texte: "Ganglions du cou", champ: "ganglionsLoc", op: "==", val: "cou" },
            { texte: "Perte d'appetit", champ: "appetit", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Toux", champ: "toux", op: "==", val: true },
            { texte: "Nez qui coule", champ: "nez", op: "==", val: true },
            { texte: "Impossibilite d'avaler / bave", champ: "gorgeType", op: "==", val: "bave" }
        ],
        urgence: {
            condition: (data) => data.gorgeType === 'bave' && data.fievre,
            message: "Impossibilite de deglutir / bave - SUSPICION EPIGLOTTITE - URGENCE"
        },
        alertes: [
            "Impossibilite de deglutir / bave ? epiglottite = URGENCE",
            "Difficultes respiratoires",
            "Gonflement du cou important",
            "Fievre persistante malgre traitement"
        ],
        conseils: [
            "Test rapide streptocoque (TROD) en pharmacie",
            "Si TROD positif ? consultation pour antibiotiques",
            "Paracetamol pour la douleur et fievre",
            "Alimentation froide/tiede (moins douloureux)"
        ],
        nonFaire: [
            "Antibiotiques sans test positif"
        ]
    },

    otite: {
        nom: "Otite moyenne aigue",
        description: "Infection de l'oreille moyenne, tres frequente chez l'enfant. Souvent complication d'un rhume.",
        niveau: "jaune",
        criteres: [
            { texte: "Douleur d'oreille", champ: "oreille", op: "==", val: true },
            { texte: "Fievre", champ: "fievre", op: "==", val: true },
            { texte: "Ecoulement oreille", champ: "oreilleEcoul", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Raideur de nuque", champ: "raideurNuque", op: "==", val: true },
            { texte: "Eruption cutanee", champ: "eruption", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.oreille && data.raideurNuque,
            message: "Otite + raideur nuque - ELIMINER MASTOÃDITE/MENINGITE"
        },
        alertes: [
            "Gonflement/rougeur derriere l'oreille (mastoidite)",
            "Fievre tres elevee persistante",
            "Troubles de l'equilibre importants",
            "Paralysie du visage"
        ],
        conseils: [
            "Consultation medicale recommandee",
            "Paracetamol pour la douleur",
            "Position semi-assise pour dormir",
            "Ne pas mettre d'eau dans l'oreille"
        ],
        nonFaire: [
            "Mettre des gouttes sans avis medical (si tympan perfore)"
        ]
    },

    laryngite: {
        nom: "Laryngite",
        description: "Inflammation du larynx avec oedeme. Toux caracteristique 'aboyante'. Souvent nocturne.",
        niveau: "orange",
        criteres: [
            { texte: "Toux aboyante", champ: "touxType", op: "==", val: "aboyante" },
            { texte: "Voix enrouee/eteinte", champ: "voix", op: "==", val: true },
            { texte: "Difficultes respiratoires", champ: "respiration", op: "==", val: true },
            { texte: "Fievre moderee", champ: "fievre", op: "==", val: true },
            { texte: "Rhume prealable", champ: "nez", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Bave / impossibilite d'avaler", champ: "gorgeType", op: "==", val: "bave" },
            { texte: "Fievre tres elevee", champ: "temp", op: ">=", val: 39.5 }
        ],
        urgence: {
            condition: (data) => data.touxType === 'aboyante' && (data.respiType === 'tirage' || data.respiType === 'cyanose'),
            message: "Laryngite severe avec tirage/cyanose - URGENCE RESPIRATOIRE"
        },
        alertes: [
            "Difficultes respiratoires marquees",
            "Tirage (creuse sous les cotes)",
            "Cyanose (levres bleues)",
            "Enfant qui bave, ne peut pas avaler ? URGENCE (epiglottite)",
            "Agitation ou prostration"
        ],
        conseils: [
            "Calmer l'enfant (l'agitation aggrave)",
            "Air frais (ouvrir fenetre, sortir quelques minutes)",
            "Air humide (salle de bain avec eau chaude)",
            "Position assise ou semi-assise",
            "Consulter si difficultes respiratoires"
        ],
        nonFaire: [
            "Allonger l'enfant a plat",
            "Paniquer (ca aggrave)"
        ]
    },

    bronchite: {
        nom: "Bronchite",
        description: "Inflammation des bronches, le plus souvent virale. Guerit spontanement en 2-3 semaines.",
        niveau: "jaune",
        criteres: [
            { texte: "Toux grasse", champ: "touxType", op: "==", val: "grasse" },
            { texte: "Fievre moderee", champ: "fievre", op: "==", val: true },
            { texte: "Fatigue", champ: "fatigue", op: "==", val: true },
            { texte: "Sifflements respiratoires", champ: "respiType", op: "==", val: "sifflante" }
        ],
        exclusions: [
            { texte: "Fievre tres elevee persistante", champ: "temp", op: ">=", val: 39 },
            { texte: "Difficultes respiratoires marquees", champ: "respiType", op: "==", val: "tirage" }
        ],
        urgence: null,
        alertes: [
            "Fievre > 39C persistant > 48h",
            "Difficultes respiratoires",
            "Douleur thoracique au repos",
            "Crachats sanglants"
        ],
        conseils: [
            "Hydratation +++",
            "Repos",
            "Paracetamol si fievre",
            "Humidifier l'air ambiant"
        ],
        nonFaire: [
            "Antibiotiques (inefficaces si viral)",
            "Antitussifs si toux grasse (la toux evacue les secretions)"
        ]
    },

    crise_asthme: {
        nom: "Crise d'asthme",
        description: "Obstruction bronchique reversible. Frequente chez l'enfant. Peut etre grave si non traitee.",
        niveau: "orange",
        criteres: [
            { texte: "Asthme connu", champ: "asthme", op: "==", val: true },
            { texte: "Sifflements respiratoires", champ: "respiType", op: "==", val: "sifflante" },
            { texte: "Difficultes respiratoires", champ: "respiration", op: "==", val: true },
            { texte: "Toux", champ: "toux", op: "==", val: true },
            { texte: "Declencheur identifie", champ: "asthmeTriggers", op: "!=", val: [] }
        ],
        exclusions: [
            { texte: "Fievre elevee", champ: "temp", op: ">=", val: 38.5 }
        ],
        urgence: {
            condition: (data) => data.asthme && (data.respiType === 'tirage' || data.respiType === 'cyanose' || data.difficulteParler),
            message: "CRISE D'ASTHME SEVERE - SAMU 15 - Salbutamol + corticoides"
        },
        alertes: [
            "Difficulte a parler (phrases courtes)",
            "Tirage intercostal",
            "Cyanose (levres bleues)",
            "SpO2 &lt; 92%",
            "Pas d'amelioration apres bronchodilatateur",
            "Agitation ou prostration"
        ],
        conseils: [
            "Bronchodilatateur (Ventoline) : 2-4 bouffees avec chambre d'inhalation",
            "Position assise",
            "Calmer l'enfant",
            "Si pas d'amelioration en 20 min ? Urgences",
            "Consulter medecin dans les 48h apres crise"
        ],
        nonFaire: [
            "Allonger l'enfant",
            "Donner des sedatifs",
            "Retarder le traitement"
        ]
    },

    pneumonie: {
        nom: "Pneumonie",
        description: "Infection du poumon, bacterienne ou virale. Necessite une evaluation medicale et souvent des antibiotiques.",
        niveau: "orange",
        criteres: [
            { texte: "Fievre elevee (> 39C)", champ: "temp", op: ">=", val: 39 },
            { texte: "Toux", champ: "toux", op: "==", val: true },
            { texte: "Respiration rapide", champ: "respiType", op: "==", val: "rapide" },
            { texte: "Difficultes respiratoires", champ: "respiration", op: "==", val: true },
            { texte: "Fatigue marquee", champ: "fatigueLevel", op: "in", val: ["marquee", "prostration"] },
            { texte: "Frissons", champ: "frissons", op: "==", val: true },
            { texte: "Douleur thoracique", champ: "douleurThorax", op: "==", val: true }
        ],
        exclusions: [],
        urgence: {
            condition: (data) => data.temp >= 40 && (data.respiType === 'tirage' || data.respiType === 'cyanose'),
            message: "Pneumonie severe - Hospitalisation urgente"
        },
        alertes: [
            "Difficultes respiratoires importantes",
            "Cyanose (levres/ongles bleus)",
            "SpO2 < 94%",
            "Prostration",
            "Refus de boire"
        ],
        conseils: [
            "Consultation medicale necessaire",
            "Radio pulmonaire souvent indiquee",
            "Antibiotiques si bacterienne",
            "Surveillance etroite"
        ],
        nonFaire: []
    },

    grippe: {
        nom: "Grippe (Influenza)",
        description: "Infection virale saisonniere. Debut brutal avec fievre elevee et courbatures intenses.",
        niveau: "jaune",
        criteres: [
            { texte: "Fievre elevee brutale (> 39C)", champ: "temp", op: ">=", val: 39 },
            { texte: "Frissons intenses", champ: "frissons", op: "==", val: true },
            { texte: "Courbatures intenses", champ: "courbatures", op: "==", val: true },
            { texte: "Maux de tete", champ: "cephalee", op: "==", val: true },
            { texte: "Fatigue intense", champ: "fatigueLevel", op: "in", val: ["marquee", "prostration"] },
            { texte: "Toux seche", champ: "touxType", op: "==", val: "seche" },
            { texte: "Mal de gorge", champ: "gorge", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Douleur retro-orbitaire", champ: "douleurYeux", op: "==", val: true },
            { texte: "Eruption cutanee", champ: "eruption", op: "==", val: true }
        ],
        urgence: null,
        alertes: [
            "Difficultes respiratoires",
            "Douleur thoracique",
            "Confusion",
            "Fievre persistante > 5 jours"
        ],
        conseils: [
            "Repos au lit",
            "Hydratation abondante",
            "Paracetamol pour fievre et douleurs",
            "Isolement pour eviter contagion"
        ],
        nonFaire: [
            "Aspirine chez l'enfant (syndrome de Reye)"
        ]
    },

    covid: {
        nom: "COVID-19",
        description: "Infection respiratoire par SARS-CoV-2. Formes generalement benignes chez l'enfant mais surveillance necessaire.",
        niveau: "jaune",
        criteres: [
            { texte: "Fievre", champ: "fievre", op: "==", val: true },
            { texte: "Toux", champ: "toux", op: "==", val: true },
            { texte: "Fatigue", champ: "fatigue", op: "==", val: true },
            { texte: "Perte d'odorat/gout", champ: "anosmie", op: "==", val: true },
            { texte: "Maux de tete", champ: "cephalee", op: "==", val: true },
            { texte: "Courbatures", champ: "courbatures", op: "==", val: true },
            { texte: "Mal de gorge", champ: "gorge", op: "==", val: true },
            { texte: "Diarrhee", champ: "diarrhee", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Douleur retro-orbitaire", champ: "douleurYeux", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.respiration && data.spo2Val === '90',
            message: "COVID avec desaturation - Hospitalisation"
        },
        alertes: [
            "Difficultes respiratoires",
            "Douleur thoracique",
            "Confusion",
            "Eruption cutanee + fievre persistante (MIS-C)"
        ],
        conseils: [
            "Test de depistage",
            "Isolement",
            "Repos et hydratation",
            "Paracetamol si fievre"
        ],
        nonFaire: []
    },

    coqueluche: {
        nom: "Coqueluche",
        description: "Infection bacterienne respiratoire tres contagieuse. Toux quinteuse caracteristique pendant plusieurs semaines.",
        niveau: "orange",
        criteres: [
            { texte: "Toux en quintes", champ: "touxType", op: "==", val: "quinteuse" },
            { texte: "Chant du coq", champ: "touxQuinte", op: "contains", val: "chant" },
            { texte: "Vomissements declenches par toux", champ: "touxQuinte", op: "contains", val: "vomit" },
            { texte: "Toux > 2 semaines", champ: "touxDuree", op: "==", val: "plus2sem" },
            { texte: "Vaccins incomplets", champ: "vaccinStatut", op: "in", val: ["incomplet", "inconnu"] }
        ],
        exclusions: [
            { texte: "Fievre elevee", champ: "temp", op: ">=", val: 38.5 }
        ],
        urgence: {
            condition: (data) => data.touxQuinte && data.touxQuinte.includes('cyanose'),
            message: "Cyanose pendant quintes - COQUELUCHE MALIGNE - URGENCE"
        },
        alertes: [
            "Cyanose (bleu) pendant les quintes",
            "Apnees",
            "Difficultes alimentaires",
            "Epuisement"
        ],
        conseils: [
            "Consultation pour confirmation (PCR)",
            "Antibiotiques (azithromycine) reduisent la contagiosite",
            "Eviction scolaire 5 jours apres debut antibiotiques",
            "Verifier vaccination entourage"
        ],
        nonFaire: [
            "Antitussifs (inefficaces)",
            "Envoyer a l'ecole sans traitement"
        ]
    },

    // ============================================
    // DIGESTIF
    // ============================================

    gastro: {
        nom: "Gastro-enterite",
        description: "Infection digestive virale ou bacterienne. Tres contagieuse. Guerit en 2-5 jours.",
        niveau: "jaune",
        criteres: [
            { texte: "Vomissements", champ: "vomissements", op: "==", val: true },
            { texte: "Diarrhee liquide", champ: "diarrhee", op: "==", val: true },
            { texte: "Diarrhee liquide", champ: "diarrheeType", op: "==", val: "liquide" },
            { texte: "Douleurs abdominales crampes", champ: "douleurAbdo", op: "==", val: true },
            { texte: "Douleurs abdominales crampes", champ: "abdoCarac", op: "contains", val: "crampes" },
            { texte: "Fievre moderee", champ: "fievre", op: "==", val: true },
            { texte: "Nausees", champ: "nausees", op: "==", val: true },
            { texte: "Perte d'appetit", champ: "appetit", op: "==", val: true },
            { texte: "Signes de deshydratation", champ: "deshydratation", op: "==", val: true },
            { texte: "Deshydratation severe (pli cutane, yeux creux)", champ: "deshSignes", op: "contains", val: "pli" }
        ],
        exclusions: [
            { texte: "Sang dans selles", champ: "diarrheeCouleur", op: "in", val: ["sang", "noire"] },
            { texte: "Douleur localisee en bas a droite", champ: "abdoLoc", op: "==", val: "fid" }
        ],
        urgence: {
            condition: (data) => data.deshydratation && data.deshSignes && data.deshSignes.length >= 3,
            message: "Deshydratation severe - Rehydratation urgente"
        },
        alertes: [
            "Signes de deshydratation (pli cutane, yeux creux, pas d'urines &gt; 8h)",
            "Vomissements incoercibles (ne garde rien)",
            "Sang dans les selles ou vomissements",
            "Douleur abdominale qui se localise",
            "Fievre elevee persistante"
        ],
        conseils: [
            "Rehydratation +++ (SRO en pharmacie)",
            "Petites quantites frequentes",
            "Reprendre alimentation progressive",
            "Hygiene des mains stricte"
        ],
        nonFaire: [
            "Boissons sucrees type soda (aggrave diarrhee)",
            "Anti-diarrheiques sans avis medical"
        ]
    },

    tiac: {
        nom: "Toxi-infection alimentaire (TIAC)",
        description: "Intoxication par aliments contamines. Debut 6-48h apres ingestion.",
        niveau: "orange",
        criteres: [
            { texte: "Vomissements", champ: "vomissements", op: "==", val: true },
            { texte: "Diarrhee", champ: "diarrhee", op: "==", val: true },
            { texte: "Douleurs abdominales intenses", champ: "douleurAbdo", op: "==", val: true },
            { texte: "Fievre", champ: "fievre", op: "==", val: true },
            { texte: "Repas suspect", champ: "repasSuspect", op: "==", val: true },
            { texte: "Cas groupes", champ: "collectivite", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Symptomes neurologiques", champ: "visionTrouble", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.visionTrouble && data.faiblesseMusculaire,
            message: "Signes neurologiques - SUSPICION BOTULISME - URGENCE"
        },
        alertes: [
            "Deshydratation severe",
            "Sang abondant dans les selles",
            "Fievre tres elevee",
            "Signes neurologiques (vision trouble, faiblesse) ? botulisme"
        ],
        conseils: [
            "Rehydratation prioritaire",
            "Conserver les restes alimentaires suspects",
            "Consultation medicale recommandee",
            "Signalement si cas groupes"
        ],
        nonFaire: [
            "Anti-diarrheiques (retiennent les toxines)"
        ]
    },

    appendicite: {
        nom: "Appendicite",
        description: "Inflammation de l'appendice. Urgence chirurgicale. Le diagnostic precoce est crucial.",
        niveau: "orange",
        criteres: [
            { texte: "Douleur FID", champ: "abdoLoc", op: "==", val: "fid" },
            { texte: "Migration douleur", champ: "abdoCarac", op: "contains", val: "migration" },
            { texte: "Douleur qui augmente", champ: "abdoCarac", op: "contains", val: "augmente" },
            { texte: "Vomissements APRES la douleur", champ: "abdoAppend", op: "contains", val: "vomi-apres" },
            { texte: "Perte d'appetit", champ: "abdoAppend", op: "contains", val: "anorexie" },
            { texte: "Fievre moderee", champ: "fievre", op: "==", val: true },
            { texte: "Marche courbe", champ: "abdoAppend", op: "contains", val: "marche" },
            { texte: "Position chien de fusil", champ: "abdoAppend", op: "contains", val: "couche" }
        ],
        exclusions: [
            { texte: "Diarrhee importante", champ: "diarrheeType", op: "==", val: "explosive" }
        ],
        urgence: {
            condition: (data) => data.abdoLoc === 'fid' && data.abdoCarac && data.abdoCarac.includes('defense'),
            message: "Appendicite avec defense - Chirurgie urgente"
        },
        alertes: [
            "Ventre dur (defense abdominale)",
            "Douleur au relachement (rebond)",
            "Fievre qui augmente",
            "Aggravation rapide"
        ],
        conseils: [
            "Consultation urgente necessaire",
            "NE PAS faire manger ni boire",
            "NE PAS donner de laxatifs",
            "NE PAS appliquer de chaleur sur le ventre"
        ],
        nonFaire: [
            "Attendre en cas de doute",
            "Donner a manger ou a boire",
            "Laxatifs",
            "Chaleur sur le ventre"
        ]
    },

    occlusion: {
        nom: "Occlusion intestinale",
        description: "Arret du transit intestinal. Urgence chirurgicale.",
        niveau: "rouge",
        criteres: [
            { texte: "Douleurs abdominales intenses", champ: "douleurAbdo", op: "==", val: true },
            { texte: "Vomissements bilieux", champ: "vomiType", op: "==", val: "bilieux" },
            { texte: "Vomissements repetes", champ: "vomiFreq", op: "in", val: ["repete", "incoercible"] },
            { texte: "Arret selles et gaz", champ: "constipation", op: "==", val: true },
            { texte: "Ventre ballonne", champ: "abdoCarac", op: "contains", val: "ballonne" }
        ],
        exclusions: [
            { texte: "Diarrhee", champ: "diarrhee", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.vomiType === 'bilieux' && data.constipation,
            message: "Vomissements bilieux + arret transit - OCCLUSION - Chirurgie urgente"
        },
        alertes: [
            "Tous les symptomes ci-dessus constituent une urgence"
        ],
        conseils: [
            "Urgences immediatement",
            "NE RIEN donner a manger ni a boire"
        ],
        nonFaire: [
            "Attendre",
            "Alimentation ou boisson",
            "Laxatifs"
        ]
    },

    hepatite: {
        nom: "Hepatite virale",
        description: "Infection du foie. Peut etre asymptomatique ou severe.",
        niveau: "orange",
        criteres: [
            { texte: "Jaunisse (ictere)", champ: "ictere", op: "==", val: true },
            { texte: "Fatigue intense", champ: "fatigueLevel", op: "in", val: ["marquee", "prostration"] },
            { texte: "Perte d'appetit", champ: "appetit", op: "==", val: true },
            { texte: "Nausees", champ: "nausees", op: "==", val: true },
            { texte: "Douleur sous cotes droites", champ: "abdoLoc", op: "==", val: "hcd" },
            { texte: "Urines foncees", champ: "urinesCouleur", op: "==", val: "fonce" },
            { texte: "Selles decolorees", champ: "diarrheeCouleur", op: "==", val: "pale" }
        ],
        exclusions: [],
        urgence: {
            condition: (data) => data.ictere && data.confusion,
            message: "Ictere + confusion - HEPATITE FULMINANTE - Urgence vitale"
        },
        alertes: [
            "Confusion (encephalopathie hepatique)",
            "Saignements spontanes",
            "Jaunisse intense d'aggravation rapide"
        ],
        conseils: [
            "Consultation medicale necessaire",
            "Repos strict",
            "Hygiene rigoureuse (hepatite A tres contagieuse)",
            "Eviter medicaments hepatotoxiques"
        ],
        nonFaire: [
            "Paracetamol a fortes doses (hepatotoxique)",
            "Alcool"
        ]
    },

    invagination: {
        nom: "Invagination intestinale aigue",
        description: "Penetration d'un segment intestinal dans le segment d'aval. Urgence chirurgicale ou reduction par lavement.",
        niveau: "orange",
        criteres: [
            { texte: "Crises douloureuses paroxystiques", champ: "abdoCarac", op: "contains", val: "crampes" },
            { texte: "Paleur pendant crises", champ: "paleur", op: "==", val: true },
            { texte: "Vomissements", champ: "vomissements", op: "==", val: true },
            { texte: "Refus alimentaire", champ: "appetit", op: "==", val: true },
            { texte: "Selles gelee de groseille", champ: "diarrheeCouleur", op: "==", val: "sang" }
        ],
        exclusions: [
            { texte: "Fievre au debut", champ: "fievre", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.abdoCarac && data.abdoCarac.includes('crampes') && data.diarrheeCouleur === 'sang',
            message: "Crises + rectorragies - INVAGINATION - Echographie urgente"
        },
        alertes: [
            "Rectorragies = invagination evoluee",
            "Signes de choc = necrose intestinale"
        ],
        conseils: [
            "Echographie abdominale urgente (image en cocarde)",
            "Lavement therapeutique si < 24h et pas de complication",
            "Chirurgie si echec ou complication"
        ],
        nonFaire: [
            "Attendre les rectorragies pour evoquer le diagnostic"
        ]
    },

    volvulus: {
        nom: "Volvulus",
        description: "Torsion d'une anse intestinale. Occlusion + ischemie. Urgence chirurgicale absolue.",
        niveau: "rouge",
        criteres: [
            { texte: "Douleur abdominale brutale intense", champ: "douleurAbdo", op: "==", val: true },
            { texte: "Vomissements bilieux", champ: "vomiType", op: "==", val: "bilieux" },
            { texte: "Arret des matieres/gaz", champ: "constipation", op: "==", val: true },
            { texte: "Ballonnement", champ: "abdoCarac", op: "contains", val: "ballonne" },
            { texte: "Defense", champ: "abdoCarac", op: "contains", val: "defense" }
        ],
        exclusions: [
            { texte: "Diarrhee", champ: "diarrhee", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.vomiType === 'bilieux' && data.constipation,
            message: "Vomissements bilieux + arret transit - VOLVULUS - Chirurgie immediate"
        },
        alertes: [
            "Tous ces signes = chirurgie urgente",
            "Signes de choc = ischemie avancee"
        ],
        conseils: [
            "Chirurgie urgente",
            "Ne rien donner per os"
        ],
        nonFaire: [
            "Attendre",
            "Alimentation"
        ]
    },

    ischemie_mesenterique: {
        nom: "Ischemie mesenterique",
        description: "Necrose intestinale par occlusion vasculaire. Rare en pediatrie. Douleur disproportionnee vs examen.",
        niveau: "rouge",
        criteres: [
            { texte: "Douleur abdominale INTENSE", champ: "douleurAbdo", op: "==", val: true },
            { texte: "Douleur constante", champ: "abdoCarac", op: "contains", val: "constante" },
            { texte: "Prostration", champ: "fatigueLevel", op: "==", val: "prostration" },
            { texte: "Rectorragies", champ: "diarrheeCouleur", op: "in", val: ["sang", "noire"] },
            { texte: "Vomissements", champ: "vomissements", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Defense (au debut)", champ: "abdoCarac", op: "contains", val: "defense" }
        ],
        urgence: {
            condition: (data) => data.douleurAbdo && data.fatigueLevel === 'prostration' && !data.fievre,
            message: "Douleur disproportionnee - ISCHEMIE MESENTERIQUE - Chirurgie urgente"
        },
        alertes: [
            "Douleur disproportionnee = signe majeur",
            "Acidose lactique"
        ],
        conseils: [
            "Angioscanner mesenterique",
            "Chirurgie / radiologie interventionnelle",
            "Reanimation"
        ],
        nonFaire: [
            "Se fier au ventre souple pour eliminer le diagnostic"
        ]
    },

    pancreatite_aigue: {
        nom: "Pancreatite aigue",
        description: "Inflammation aigue du pancreas. Formes severes avec necrose = urgence.",
        niveau: "orange",
        criteres: [
            { texte: "Douleur epigastrique intense", champ: "abdoLoc", op: "==", val: "estomac" },
            { texte: "Douleur constante", champ: "abdoCarac", op: "contains", val: "constante" },
            { texte: "Vomissements persistants", champ: "vomiFreq", op: "==", val: "incoercible" },
            { texte: "Position antalgique", champ: "abdoAppend", op: "contains", val: "couche" },
            { texte: "Fievre", champ: "fievre", op: "==", val: true },
            { texte: "Ictere possible", champ: "ictere", op: "==", val: true }
        ],
        exclusions: [],
        urgence: {
            condition: (data) => data.abdoLoc === 'estomac' && data.vomiFreq === 'incoercible' && data.confusion,
            message: "Pancreatite avec confusion - Forme grave - Reanimation"
        },
        alertes: [
            "Defaillance d'organe (choc, IRA, SDRA)",
            "Necrose pancreatique",
            "Surinfection"
        ],
        conseils: [
            "Lipase > 3N confirme le diagnostic",
            "Scanner si forme severe",
            "Jeune strict",
            "Rehydratation",
            "Antalgiques"
        ],
        nonFaire: [
            "Alimentation precoce si forme severe"
        ]
    },

    // ============================================
    // CUTANE / ERUPTIF
    // ============================================

    varicelle: {
        nom: "Varicelle",
        description: "Infection virale tres contagieuse. Benigne chez l'enfant immunocompetent.",
        niveau: "vert",
        criteres: [
            { texte: "Eruption vesiculeuse", champ: "eruptionType", op: "==", val: "vesicules" },
            { texte: "Lesions d'ages differents", champ: "eruption", op: "==", val: true },
            { texte: "Demangeaisons intenses", champ: "eruptionGratte", op: "==", val: true },
            { texte: "Localisation tronc", champ: "eruptionLoc", op: "contains", val: "tronc" },
            { texte: "Fievre moderee", champ: "fievre", op: "==", val: true },
            { texte: "Fatigue", champ: "fatigue", op: "==", val: true },
            { texte: "Immunodeprime (gravite ++)", champ: "immunodepression", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Localisation mains/pieds predominante", champ: "eruptionLoc", op: "contains", val: "mains" },
            { texte: "Fievre elevee persistante", champ: "temp", op: ">=", val: 39 }
        ],
        urgence: {
            condition: (data) => data.eruptionType === 'vesicules' && data.immunodepression,
            message: "Varicelle sur terrain immunodeprime - Hospitalisation"
        },
        alertes: [
            "Surinfection des lesions (pus, rougeur etendue, fievre)",
            "Difficultes respiratoires",
            "Troubles neurologiques",
            "Lesions dans les yeux"
        ],
        conseils: [
            "Eviction scolaire jusqu'a croutes (environ 7 jours)",
            "Antihistaminique pour les demangeaisons",
            "Ongles courts et propres",
            "Bains courts a l'eau tiede",
            "Paracetamol si fievre"
        ],
        nonFaire: [
            "Aspirine (syndrome de Reye)",
            "Ibuprofene (risque de complications cutanees)",
            "Gratter (cicatrices)"
        ]
    },

    pmb: {
        nom: "Syndrome pieds-mains-bouche",
        description: "Infection virale (Coxsackie). Tres contagieuse. Benigne. Guerit en 7-10 jours.",
        niveau: "vert",
        criteres: [
            { texte: "Vesicules mains", champ: "eruptionLoc", op: "contains", val: "mains" },
            { texte: "Vesicules pieds", champ: "eruptionLoc", op: "contains", val: "pieds" },
            { texte: "Aphtes bouche", champ: "aphtes", op: "==", val: true },
            { texte: "Eruption fesses", champ: "eruptionLoc", op: "contains", val: "fesses" },
            { texte: "Fievre moderee", champ: "fievre", op: "==", val: true },
            { texte: "Refus de manger", champ: "appetit", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Vesicules sur tronc", champ: "eruptionLoc", op: "contains", val: "tronc" }
        ],
        urgence: null,
        alertes: [
            "Deshydratation (refus de boire)",
            "Fievre elevee persistante",
            "Signes neurologiques (rare)"
        ],
        conseils: [
            "Alimentation froide et liquide",
            "Eviter aliments acides ou sales",
            "Paracetamol",
            "Eviction de collectivite jusqu'a guerison des lesions"
        ],
        nonFaire: [
            "Forcer a manger"
        ]
    },

    urticaire: {
        nom: "Urticaire / Reaction allergique",
        description: "Reaction cutanee allergique ou non. Generalement benigne mais surveiller signes de gravite.",
        niveau: "jaune",
        criteres: [
            { texte: "Plaques rouges en relief", champ: "eruptionType", op: "==", val: "urticaire" },
            { texte: "Demangeaisons intenses", champ: "eruptionGratte", op: "==", val: true },
            { texte: "Apparition rapide", champ: "eruption", op: "==", val: true },
            { texte: "Gonflement possible", champ: "oedeme", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Difficultes respiratoires", champ: "respiration", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.eruption && (data.respiration || data.oedemeLoc === 'levres'),
            message: "Urticaire + oedeme/gene respiratoire - ANAPHYLAXIE - Adrenaline"
        },
        alertes: [
            "Gonflement des levres/langue/gorge ? URGENCE",
            "Difficultes respiratoires ? URGENCE",
            "Malaise, chute de tension ? URGENCE"
        ],
        conseils: [
            "Antihistaminique",
            "Identifier l'allergene si possible",
            "Consultation si recidive ou etendu"
        ],
        nonFaire: []
    },

    scarlatine: {
        nom: "Scarlatine",
        description: "Angine streptococcique avec eruption cutanee. Necessite antibiotiques.",
        niveau: "jaune",
        criteres: [
            { texte: "Angine avec fievre elevee", champ: "gorge", op: "==", val: true },
            { texte: "Fievre elevee", champ: "temp", op: ">=", val: 38.5 },
            { texte: "Eruption granitee", champ: "eruptionTexture", op: "contains", val: "granite" },
            { texte: "Langue framboisee", champ: "langueType", op: "==", val: "framboise" },
            { texte: "Ganglions", champ: "ganglions", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Toux", champ: "toux", op: "==", val: true },
            { texte: "Eruption vesiculeuse", champ: "eruptionType", op: "==", val: "vesicules" }
        ],
        urgence: null,
        alertes: [
            "Douleurs articulaires (RAA)",
            "Urines foncees / rares (glomerulonephrite)"
        ],
        conseils: [
            "Consultation medicale necessaire",
            "Antibiotiques indispensables (penicilline/amoxicilline)",
            "Eviction scolaire 48h apres debut antibiotiques"
        ],
        nonFaire: []
    },

    roseole: {
        nom: "Roseole (Exantheme subit)",
        description: "Infection virale benigne. Fievre elevee 3-4 jours puis eruption a la chute de la fievre.",
        niveau: "vert",
        criteres: [
            { texte: "Fievre elevee (39-40C) pendant 3-4 jours", champ: "temp", op: ">=", val: 39 },
            { texte: "Etat general conserve malgre fievre", champ: "fatigueLevel", op: "!=", val: "prostration" },
            { texte: "Eruption APRES chute fievre", champ: "eruptionEvolution", op: "==", val: "apres-fievre" },
            { texte: "Eruption tronc", champ: "eruptionLoc", op: "contains", val: "tronc" }
        ],
        exclusions: [
            { texte: "Toux", champ: "toux", op: "==", val: true },
            { texte: "Eruption pendant la fievre", champ: "eruptionEvolution", op: "==", val: "avec-fievre" }
        ],
        urgence: null,
        alertes: [
            "Convulsions febriles (assez frequentes avec cette infection)"
        ],
        conseils: [
            "Antipyretiques pendant la phase febrile",
            "Pas de traitement specifique",
            "Rassurer : benin, guerison spontanee"
        ],
        nonFaire: []
    },

    rougeole: {
        nom: "Rougeole",
        description: "Infection virale tres contagieuse. Complications possibles graves. Maladie a declaration obligatoire.",
        niveau: "orange",
        criteres: [
            { texte: "Fievre elevee", champ: "temp", op: ">=", val: 38.5 },
            { texte: "Conjonctivite", champ: "yeuxTypes", op: "contains", val: "rouge" },
            { texte: "Rhinite", champ: "nez", op: "==", val: true },
            { texte: "Toux", champ: "toux", op: "==", val: true },
            { texte: "Eruption descendante", champ: "eruptionEvolution", op: "==", val: "descend" },
            { texte: "Vaccins incomplets", champ: "vaccinStatut", op: "in", val: ["incomplet", "inconnu"] }
        ],
        exclusions: [],
        urgence: {
            condition: (data) => data.eruption && data.confusion,
            message: "Rougeole + troubles conscience - ENCEPHALITE - Urgence"
        },
        alertes: [
            "Encephalite (confusion, convulsions)",
            "Pneumonie",
            "Surinfection bacterienne"
        ],
        conseils: [
            "Isolement strict",
            "Declaration obligatoire ARS",
            "Verifier vaccination entourage",
            "Vitamine A (OMS)"
        ],
        nonFaire: [
            "Envoyer en collectivite"
        ]
    },

    // ============================================
    // PLAIES / GRIFFURES
    // ============================================

    plaie_simple: {
        nom: "Plaie simple",
        description: "Plaie superficielle, propre, saignement minime. Desinfection et pansement a domicile.",
        niveau: "vert",
        criteres: [
            { texte: "Plaie", champ: "plaie", op: "==", val: true },
            { texte: "Superficielle", champ: "plaieType", op: "in", val: ["superficielle", "coupure"] },
            { texte: "Saignement minime", champ: "plaieSaignement", op: "==", val: "minime" }
        ],
        exclusions: [
            { texte: "Plaie profonde", champ: "plaieType", op: "in", val: ["profonde", "morsure"] },
            { texte: "Saignement abondant", champ: "plaieSaignement", op: "in", val: ["abondant", "arteriel"] },
            { texte: "Corps etranger", champ: "plaieCorpsEtranger", op: "==", val: true },
            { texte: "Perte mobilite/sensibilite", champ: "plaieMobiliteReduite", op: "==", val: true }
        ],
        urgence: null,
        alertes: [
            "Rougeur croissante autour de la plaie (infection)",
            "Fievre dans les 48-72h",
            "Pus ou ecoulement",
            "Stries rouges (lymphangite)"
        ],
        conseils: [
            "Laver a l'eau et au savon",
            "Desinfecter : Chlorhexidine ou Betadine dermique (pas alcool, pas eau oxygenee)",
            "Pansement propre",
            "Verifier vaccination tetanos"
        ],
        nonFaire: [
            "Alcool (brule les tissus)",
            "Eau oxygenee (retarde cicatrisation)",
            "Eosin (masque signes infection)"
        ]
    },

    plaie_suturer: {
        nom: "Plaie a suturer",
        description: "Plaie nette, beante, necessite fermeture (points, agrafes ou colle).",
        niveau: "jaune",
        criteres: [
            { texte: "Plaie", champ: "plaie", op: "==", val: true },
            { texte: "Coupure nette", champ: "plaieType", op: "==", val: "coupure" },
            { texte: "Saignement modere", champ: "plaieSaignement", op: "in", val: ["modere", "abondant"] },
            { texte: "Visage", champ: "plaieLoc", op: "contains", val: "visage" },
            { texte: "Main/doigts", champ: "plaieLoc", op: "contains", val: "main" }
        ],
        exclusions: [
            { texte: "Morsure", champ: "plaieType", op: "==", val: "morsure" },
            { texte: "Plaie souilee", champ: "plaieSale", op: "==", val: true }
        ],
        urgence: null,
        alertes: [
            "Suture dans les 6h (visage 12-24h)",
            "Main/doigt : verifier tendons et nerfs"
        ],
        conseils: [
            "Compression 10-15 min",
            "Consultation urgences ou medecin",
            "Indications colle/Steri-Strip : plaie < 3cm, nette, peu profonde, pas sur articulation",
            "Agrafes : cuir chevelu, zones peu mobiles",
            "Points : visage, main, articulations"
        ],
        nonFaire: [
            "Coller une plaie profonde ou souilee",
            "Suturer une morsure (risque infection)"
        ]
    },

    plaie_hemorragique: {
        nom: "Plaie hemorragique",
        description: "Saignement abondant ou arteriel. Urgence vitale si non controle.",
        niveau: "rouge",
        criteres: [
            { texte: "Plaie", champ: "plaie", op: "==", val: true },
            { texte: "Saignement abondant/arteriel", champ: "plaieSaignement", op: "in", val: ["abondant", "arteriel"] }
        ],
        exclusions: [],
        urgence: {
            condition: (data) => data.plaieSaignement === 'arteriel',
            message: "HEMORRAGIE ARTERIELLE - Compression + SAMU 15"
        },
        alertes: [
            "Sang rouge vif en jet saccade = arteriel",
            "Garrot en dernier recours si compression inefficace",
            "NOTER L'HEURE de pose du garrot ++"
        ],
        conseils: [
            "Compression directe forte (10-15 min sans relacher)",
            "Surelegation du membre",
            "Appeler 15 si arteriel ou non controle",
            "Garrot : uniquement si compression impossible, noter heure"
        ],
        nonFaire: [
            "Relacher la compression pour regarder",
            "Garder un garrot > 2h sans avis medical"
        ]
    },

    plaie_morsure: {
        nom: "Morsure animale/humaine",
        description: "Risque infectieux majeur. Ne jamais suturer. Antibioprophylaxie souvent necessaire.",
        niveau: "orange",
        criteres: [
            { texte: "Morsure", champ: "plaieType", op: "==", val: "morsure" }
        ],
        exclusions: [],
        urgence: {
            condition: (data) => data.plaieType === 'morsure' && data.plaieLoc && data.plaieLoc.includes('visage'),
            message: "Morsure visage - Urgences pour evaluation"
        },
        alertes: [
            "Chat : infection dans 50% des cas (Pasteurella)",
            "Chien : risque moindre mais possible",
            "Humain : tres septique",
            "Rage : verifier statut animal si inconnu"
        ],
        conseils: [
            "Lavage abondant eau + savon 15 min",
            "Betadine moussante",
            "Consultation sous 24h pour antibiotiques",
            "Verifier tetanos",
            "Signaler animal mordeur (rage)"
        ],
        nonFaire: [
            "Suturer (sauf visage par specialiste)",
            "Mettre colle ou Steri-Strip"
        ]
    },

    // ============================================
    // ARBOVIROSES (TROPICAL)
    // ============================================

    dengue: {
        nom: "Dengue",
        description: "Arbovirose transmise par moustique (Aedes). Endemique aux Antilles. Surveillance J3-J7 cruciale.",
        niveau: "orange",
        criteres: [
            { texte: "Fievre elevee brutale (> 39C)", champ: "temp", op: ">=", val: 39 },
            { texte: "Douleur retro-orbitaire", champ: "douleurYeux", op: "==", val: true },
            { texte: "Cephalees intenses", champ: "cephaleeType", op: "in", val: ["intense", "brutal"] },
            { texte: "Courbatures intenses", champ: "courbatures", op: "==", val: true },
            { texte: "Fatigue marquee", champ: "fatigueLevel", op: "in", val: ["marquee", "prostration"] },
            { texte: "Eruption cutanee J2-J5", champ: "eruption", op: "==", val: true },
            { texte: "Nausees", champ: "nausees", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Toux importante", champ: "toux", op: "==", val: true },
            { texte: "Douleurs articulaires predominantes", champ: "articIntensite", op: "==", val: "intense" }
        ],
        urgence: {
            condition: (data) => data.saignements || (data.douleurAbdo && data.abdoLoc === 'estomac') || data.extremitesFroides,
            message: "Dengue avec signes d'alarme - Hospitalisation"
        },
        alertes: [
            "Douleur abdominale intense",
            "Vomissements persistants",
            "Saignements (gencives, nez, ecchymoses)",
            "Agitation ou lethargie",
            "Extremites froides",
            "Chute brutale de la fievre + malaise ? dengue severe"
        ],
        conseils: [
            "Paracetamol UNIQUEMENT",
            "Hydratation +++",
            "Repos",
            "Protection anti-moustiques (eviter transmission)",
            "Surveillance etroite J3-J7"
        ],
        nonFaire: [
            "Aspirine (risque hemorragique)",
            "Ibuprofene (risque hemorragique)",
            "AINS"
        ]
    },

    chikungunya: {
        nom: "Chikungunya",
        description: "Arbovirose transmise par moustique. Douleurs articulaires intenses et invalidantes.",
        niveau: "jaune",
        criteres: [
            { texte: "Fievre elevee brutale", champ: "temp", op: ">=", val: 38.5 },
            { texte: "Douleurs articulaires intenses", champ: "douleurArticulaire", op: "==", val: true },
            { texte: "Douleurs articulaires intenses", champ: "articIntensite", op: "==", val: "intense" },
            { texte: "Gonflements articulaires", champ: "membreSignes", op: "contains", val: "gonfle" },
            { texte: "Eruption cutanee", champ: "eruption", op: "==", val: true },
            { texte: "Cephalees", champ: "cephalee", op: "==", val: true },
            { texte: "Courbatures", champ: "courbatures", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Douleur retro-orbitaire marquee", champ: "douleurYeux", op: "==", val: true }
        ],
        urgence: null,
        alertes: [
            "Signes neurologiques",
            "Deshydratation",
            "Formes severes chez le petit enfant"
        ],
        conseils: [
            "Paracetamol UNIQUEMENT",
            "Hydratation",
            "Repos",
            "Protection anti-moustiques"
        ],
        nonFaire: [
            "Aspirine",
            "Ibuprofene",
            "AINS (a eviter initialement)"
        ]
    },

    leptospirose: {
        nom: "Leptospirose",
        description: "Infection bacterienne liee a l'eau/boue contaminee par urines de rongeurs. Frequente apres baignade en riviere.",
        niveau: "orange",
        criteres: [
            { texte: "Fievre elevee", champ: "temp", op: ">=", val: 39 },
            { texte: "Cephalees intenses", champ: "cephaleeType", op: "==", val: "intense" },
            { texte: "Courbatures intenses (mollets++)", champ: "courbatures", op: "==", val: true },
            { texte: "Conjonctivite", champ: "yeuxTypes", op: "contains", val: "rouge" },
            { texte: "Jaunisse", champ: "ictere", op: "==", val: true },
            { texte: "Baignade riviere/mare", champ: "baignade", op: "==", val: true }
        ],
        exclusions: [],
        urgence: {
            condition: (data) => data.ictere && data.deshSignes && data.deshSignes.includes('pasurines'),
            message: "Leptospirose ictero-hemorragique - Urgence vitale"
        },
        alertes: [
            "Jaunisse (atteinte hepatique)",
            "Oligurie (peu d'urines ? atteinte renale)",
            "Saignements",
            "Confusion"
        ],
        conseils: [
            "Consultation medicale rapide",
            "Antibiotiques necessaires",
            "Signaler la baignade au medecin"
        ],
        nonFaire: []
    },

    paludisme: {
        nom: "Paludisme (acces palustre)",
        description: "Infection parasitaire (Plasmodium) transmise par moustique anophele. Urgence diagnostique et therapeutique.",
        niveau: "rouge",
        criteres: [
            { texte: "Sejour zone impaludee < 2 mois", champ: "zonePalu", op: "==", val: true },
            { texte: "Fievre avec frissons intenses", champ: "fievre", op: "==", val: true },
            { texte: "Frissons intenses", champ: "frissons", op: "==", val: true },
            { texte: "Cephalees", champ: "cephalee", op: "==", val: true },
            { texte: "Courbatures", champ: "courbatures", op: "==", val: true },
            { texte: "Vomissements", champ: "vomissements", op: "==", val: true },
            { texte: "Diarrhee", champ: "diarrhee", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Eruption cutanee", champ: "eruption", op: "==", val: true },
            { texte: "Toux importante", champ: "toux", op: "==", val: true },
            { texte: "Douleur retro-orbitaire", champ: "douleurYeux", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.zonePalu && data.fievre && (data.confusion || data.convulsions || data.fatigueLevel === 'prostration'),
            message: "PALUDISME GRAVE - Artesunate IV - Urgence vitale"
        },
        alertes: [
            "Confusion / troubles de conscience ? PALUDISME GRAVE",
            "Convulsions ? PALUDISME GRAVE",
            "Prostration ? PALUDISME GRAVE",
            "Ictere",
            "Urines foncees / rares",
            "Saignements"
        ],
        conseils: [
            "Frottis-goutte epaisse EN URGENCE (resultat < 2h)",
            "Hospitalisation si P. falciparum",
            "Artesunate IV si forme grave",
            "Toute fievre au retour de zone d'endemie = paludisme jusqu'a preuve du contraire"
        ],
        nonFaire: [
            "Attendre pour faire le diagnostic",
            "Traiter en ambulatoire sans certitude"
        ]
    },

    // ============================================
    // AUTRES INFECTIONS
    // ============================================

    mononucleose: {
        nom: "Mononucleose infectieuse",
        description: "Infection virale (EBV). 'Maladie du baiser'. Fatigue prolongee frequente. Rate fragile.",
        niveau: "jaune",
        criteres: [
            { texte: "Fatigue intense et prolongee", champ: "fatigueLevel", op: "in", val: ["marquee", "prostration"] },
            { texte: "Ganglions gonfles multiples", champ: "ganglions", op: "==", val: true },
            { texte: "Ganglions gonfles multiples", champ: "ganglionsLoc", op: "==", val: "multiple" },
            { texte: "Angine", champ: "gorge", op: "==", val: true },
            { texte: "Fievre prolongee", champ: "fievreDuree", op: "==", val: "5j-plus" },
            { texte: "Perte d'appetit", champ: "appetit", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Signes respiratoires importants", champ: "respiration", op: "==", val: true }
        ],
        urgence: null,
        alertes: [
            "Douleur brutale flanc gauche (rupture rate)",
            "Difficultes respiratoires (gros ganglions)",
            "Jaunisse"
        ],
        conseils: [
            "Repos +++",
            "PAS de sport de contact pendant 4-6 semaines (rate fragile)",
            "Paracetamol",
            "La fatigue peut durer plusieurs semaines"
        ],
        nonFaire: [
            "Sports de contact",
            "Ampicilline/amoxicilline (eruption quasi constante)"
        ]
    },

    cystite: {
        nom: "Cystite (infection urinaire basse)",
        description: "Infection de la vessie. Plus frequente chez les filles. Sans fievre (sinon = pyelonephrite).",
        niveau: "jaune",
        criteres: [
            { texte: "Brulures en urinant", champ: "urinaireTypes", op: "contains", val: "brulure" },
            { texte: "Envies frequentes d'uriner", champ: "urinaireTypes", op: "contains", val: "frequent" },
            { texte: "Urines troubles", champ: "urinaireTypes", op: "contains", val: "trouble" },
            { texte: "Urines malodorantes", champ: "urinaireTypes", op: "contains", val: "odeur" }
        ],
        exclusions: [
            { texte: "Fievre", champ: "fievre", op: "==", val: true },
            { texte: "Douleur lombaire", champ: "douleurLombaire", op: "==", val: true }
        ],
        urgence: null,
        alertes: [
            "Apparition de fievre",
            "Douleur lombaire",
            "Sang dans les urines abondant"
        ],
        conseils: [
            "Consultation medicale pour analyse d'urines",
            "Boire beaucoup",
            "Uriner frequemment"
        ],
        nonFaire: [
            "Se retenir d'uriner"
        ]
    },

    pyelonephrite: {
        nom: "Pyelonephrite",
        description: "Infection du rein. Plus grave que la cystite. Necessite antibiotiques et parfois hospitalisation.",
        niveau: "orange",
        criteres: [
            { texte: "Fievre elevee", champ: "temp", op: ">=", val: 38.5 },
            { texte: "Douleur lombaire", champ: "douleurLombaire", op: "==", val: true },
            { texte: "Frissons", champ: "frissons", op: "==", val: true },
            { texte: "Signes urinaires", champ: "urinaire", op: "==", val: true },
            { texte: "Nausees/vomissements", champ: "nausees", op: "==", val: true },
            { texte: "Fatigue", champ: "fatigue", op: "==", val: true }
        ],
        exclusions: [],
        urgence: {
            condition: (data) => data.douleurLombaire && data.fievre && data.confusion,
            message: "Pyelonephrite compliquee - Hospitalisation"
        },
        alertes: [
            "Fievre tres elevee persistante",
            "Vomissements empechant traitement oral",
            "Alteration etat general"
        ],
        conseils: [
            "Consultation medicale urgente",
            "Antibiotiques indispensables",
            "Bilan sanguin et ECBU"
        ],
        nonFaire: []
    },

    herpangine: {
        nom: "Herpangine",
        description: "Infection virale proche du pieds-mains-bouche. Ulcerations uniquement dans la bouche/gorge.",
        niveau: "jaune",
        criteres: [
            { texte: "Vesicules/ulcerations gorge", champ: "aphtes", op: "==", val: true },
            { texte: "Fievre elevee", champ: "temp", op: ">=", val: 39 },
            { texte: "Mal de gorge intense", champ: "gorge", op: "==", val: true },
            { texte: "Refus de manger", champ: "appetit", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Eruption mains/pieds", champ: "eruptionLoc", op: "contains", val: "mains" }
        ],
        urgence: null,
        alertes: [
            "Deshydratation",
            "Fievre persistante > 5 jours"
        ],
        conseils: [
            "Alimentation froide et liquide",
            "Paracetamol",
            "Eviter acide et sale"
        ],
        nonFaire: []
    },

    conjonctivite: {
        nom: "Conjonctivite",
        description: "Inflammation de la conjonctive. Virale, bacterienne ou allergique.",
        niveau: "vert",
        criteres: [
            { texte: "Å’il rouge", champ: "yeuxTypes", op: "contains", val: "rouge" },
            { texte: "Larmoiement", champ: "yeuxTypes", op: "contains", val: "larmoie" },
            { texte: "Paupieres collees", champ: "yeuxTypes", op: "contains", val: "colles" },
            { texte: "Yeux", champ: "yeux", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Douleur intense", champ: "cephaleeType", op: "==", val: "intense" },
            { texte: "Photophobie intense", champ: "photophobie", op: "==", val: true }
        ],
        urgence: null,
        alertes: [
            "Douleur oculaire intense",
            "Baisse de vision",
            "Atteinte d'un seul oeil avec douleur",
            "Photophobie marquee"
        ],
        conseils: [
            "Nettoyage au serum physiologique",
            "Consultation si purulent (possible collyre antibiotique)",
            "Lavage des mains frequent",
            "Ne pas partager les linges"
        ],
        nonFaire: [
            "Mettre des collyres sans avis medical"
        ]
    },

    // ============================================
    // OPHTALMOLOGIQUES
    // ============================================

    herpes_oculaire: {
        nom: "Herpes oculaire (keratite herpetique)",
        description: "Infection de la cornee par HSV. URGENCE CECITANTE. Traitement antiviral < 24h imperatif.",
        niveau: "rouge",
        criteres: [
            { texte: "Å’il rouge unilateral", champ: "yeuxTypes", op: "contains", val: "rouge" },
            { texte: "Photophobie intense", champ: "photophobie", op: "==", val: true },
            { texte: "Larmoiement", champ: "yeuxTypes", op: "contains", val: "larmoie" },
            { texte: "Vesicules visage", champ: "eruptionType", op: "==", val: "vesicules" },
            { texte: "Vesicules visage", champ: "eruptionLoc", op: "contains", val: "visage" }
        ],
        exclusions: [
            { texte: "Secretions purulentes", champ: "yeuxTypes", op: "contains", val: "colles" }
        ],
        urgence: {
            condition: (data) => data.yeux && data.photophobie && data.eruptionType === 'vesicules' && data.eruptionLoc && data.eruptionLoc.includes('visage'),
            message: "HERPES OCULAIRE - Ophtalmo < 24h - Risque cecite"
        },
        alertes: [
            "TOUTE suspicion = urgence ophtalmologique < 24h",
            "Baisse de vision = keratite profonde",
            "Recidives frequentes"
        ],
        conseils: [
            "Consultation ophtalmologique URGENTE",
            "Aciclovir pommade ophtalmique ou Valaciclovir PO",
            "NE JAMAIS donner de corticoides locaux sans avis ophtalmo"
        ],
        nonFaire: [
            "Corticoides locaux (aggravation majeure)",
            "Attendre",
            "Traiter comme conjonctivite banale"
        ]
    },

    zona_ophtalmique: {
        nom: "Zona ophtalmique (V1)",
        description: "Reactivation VZV dans le territoire V1. Si atteinte du nez = atteinte oculaire quasi certaine.",
        niveau: "rouge",
        criteres: [
            { texte: "Eruption vesiculeuse hemifront", champ: "eruptionType", op: "==", val: "vesicules" },
            { texte: "Eruption visage", champ: "eruptionLoc", op: "contains", val: "visage" },
            { texte: "Cephalees", champ: "cephalee", op: "==", val: true },
            { texte: "Å’il rouge", champ: "yeuxTypes", op: "contains", val: "rouge" },
            { texte: "Photophobie", champ: "photophobie", op: "==", val: true },
            { texte: "Å’deme palpebral", champ: "oedeme", op: "==", val: true },
            { texte: "Å’deme palpebral", champ: "oedemeLoc", op: "==", val: "oeil" }
        ],
        exclusions: [],
        urgence: {
            condition: (data) => data.eruptionType === 'vesicules' && data.eruptionLoc && data.eruptionLoc.includes('visage') && data.yeux,
            message: "ZONA V1 - Valaciclovir < 72h - Ophtalmo urgent"
        },
        alertes: [
            "Signe de Hutchinson (nez) = atteinte oculaire quasi certaine",
            "Baisse de vision",
            "Uveite, keratite, retinite possibles"
        ],
        conseils: [
            "Valaciclovir 1g x3/j pendant 7 jours - DANS LES 72H du debut",
            "Consultation ophtalmologique systematique si atteinte peri-oculaire",
            "Antalgiques (douleurs intenses)"
        ],
        nonFaire: [
            "Retarder le traitement antiviral",
            "Corticoides sans couverture antivirale"
        ]
    },

    cellulite_orbitaire: {
        nom: "Cellulite orbitaire",
        description: "Infection des tissus orbitaires. Complication de sinusite. Urgence vitale (extension cerebrale possible).",
        niveau: "rouge",
        criteres: [
            { texte: "Fievre elevee", champ: "temp", op: ">=", val: 38.5 },
            { texte: "Å’deme palpebral important", champ: "oedeme", op: "==", val: true },
            { texte: "Å’deme palpebral important", champ: "oedemeLoc", op: "==", val: "oeil" },
            { texte: "Å’il rouge", champ: "yeuxTypes", op: "contains", val: "rouge" }
        ],
        exclusions: [],
        urgence: {
            condition: (data) => data.fievre && data.oedeme && data.oedemeLoc === 'oeil' && data.cephaleeType === 'intense',
            message: "CELLULITE ORBITAIRE - Scanner + ATB IV urgent"
        },
        alertes: [
            "Exophtalmie + ophtalmoplegie = cellulite orbitaire",
            "Troubles de conscience = extension intracranienne",
            "Baisse de vision = compression nerf optique"
        ],
        conseils: [
            "Hospitalisation urgente",
            "Scanner orbites + crane",
            "Antibiotherapie IV",
            "Avis ORL (drainage sinusien possible)"
        ],
        nonFaire: [
            "Traiter en ambulatoire",
            "Attendre l'evolution"
        ]
    },

    // ============================================
    // ORL / VOIES AERIENNES CRITIQUES
    // ============================================

    epiglottite: {
        nom: "Epiglottite",
        description: "Infection bacterienne de l'epiglotte. Obstruction rapide des voies aeriennes. URGENCE VITALE.",
        niveau: "rouge",
        criteres: [
            { texte: "Fievre elevee brutale", champ: "temp", op: ">=", val: 39 },
            { texte: "Hypersialorrhee (bave)", champ: "gorgeType", op: "==", val: "bave" },
            { texte: "Voix etouffee", champ: "voix", op: "==", val: true },
            { texte: "Dyspnee", champ: "respiration", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Toux aboyante", champ: "touxType", op: "==", val: "aboyante" }
        ],
        urgence: {
            condition: (data) => data.gorgeType === 'bave' && data.fievre && data.voix,
            message: "EPIGLOTTITE - SAMU - NE PAS examiner gorge - NE PAS allonger"
        },
        alertes: [
            "TOUS ces signes = URGENCE VITALE",
            "Risque d'obstruction complete brutale"
        ],
        conseils: [
            "APPELER LE 15 IMMEDIATEMENT",
            "NE PAS examiner la gorge (risque de spasme larynge fatal)",
            "NE PAS allonger l'enfant",
            "Laisser en position assise",
            "Intubation en conditions securisees au bloc"
        ],
        nonFaire: [
            "Examiner la gorge avec un abaisse-langue",
            "Allonger l'enfant",
            "Tenter de faire boire",
            "Retarder l'appel au SAMU"
        ]
    },

    abces_retropharynge: {
        nom: "Abces retropharynge",
        description: "Collection purulente en arriere du pharynx. Risque d'obstruction et de mediastinite.",
        niveau: "rouge",
        criteres: [
            { texte: "Fievre elevee", champ: "temp", op: ">=", val: 38.5 },
            { texte: "Dysphagie importante", champ: "gorgeType", op: "==", val: "avaler" },
            { texte: "Torticolis/raideur nuque", champ: "raideurNuque", op: "==", val: true },
            { texte: "Voix modifiee", champ: "voix", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Photophobie", champ: "photophobie", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.fievre && data.gorge && data.raideurNuque && !data.photophobie,
            message: "ABCES RETROPHARYNGE - Scanner cervical - ATB IV"
        },
        alertes: [
            "Dyspnee = compression voies aeriennes",
            "Mediastinite si extension"
        ],
        conseils: [
            "Scanner cervical urgent",
            "Antibiotherapie IV",
            "Drainage chirurgical souvent necessaire"
        ],
        nonFaire: [
            "Ponction a l'aveugle"
        ]
    },

    angine_ludwig: {
        nom: "Angine de Ludwig",
        description: "Cellulite du plancher buccal. Risque d'asphyxie par oedeme larynge. Souvent origine dentaire.",
        niveau: "rouge",
        criteres: [
            { texte: "Tumefaction sous-mandibulaire", champ: "oedeme", op: "==", val: true },
            { texte: "Hypersialorrhee", champ: "gorgeType", op: "==", val: "bave" },
            { texte: "Fievre", champ: "fievre", op: "==", val: true },
            { texte: "Dyspnee", champ: "respiration", op: "==", val: true }
        ],
        exclusions: [],
        urgence: {
            condition: (data) => data.gorge && data.gorgeType === 'bave' && data.respiration,
            message: "ANGINE DE LUDWIG - Risque asphyxie - SAMU"
        },
        alertes: [
            "Dyspnee = obstruction imminente",
            "Extension cervicale rapide",
            "Mediastinite"
        ],
        conseils: [
            "Urgence vitale - SAMU",
            "Securisation voies aeriennes prioritaire",
            "Antibiotherapie IV",
            "Drainage chirurgical"
        ],
        nonFaire: [
            "Attendre"
        ]
    },

    // ============================================
    // CARDIOVASCULAIRES
    // ============================================

    myocardite: {
        nom: "Myocardite",
        description: "Inflammation du muscle cardiaque, souvent post-virale. Peut evoluer vers insuffisance cardiaque ou troubles du rythme.",
        niveau: "orange",
        criteres: [
            { texte: "Fatigue intense post-virale", champ: "fatigueLevel", op: "in", val: ["marquee", "prostration"] },
            { texte: "Dyspnee d'effort puis repos", champ: "respiration", op: "==", val: true },
            { texte: "Dyspnee d'effort puis repos", champ: "respiType", op: "==", val: "rapide" },
            { texte: "Douleur thoracique", champ: "douleurThorax", op: "==", val: true },
            { texte: "Malaises", champ: "vertiges", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Toux productive", champ: "touxType", op: "==", val: "grasse" },
            { texte: "Fievre elevee", champ: "temp", op: ">=", val: 38.5 }
        ],
        urgence: {
            condition: (data) => data.fatigueLevel === 'prostration' && data.respiration && !data.toux && !data.fievre,
            message: "MYOCARDITE suspectee - ECG + Troponine urgent"
        },
        alertes: [
            "Syncope",
            "Dyspnee de repos",
            "Troubles du rythme",
            "Insuffisance cardiaque"
        ],
        conseils: [
            "ECG + Troponine + BNP",
            "Echographie cardiaque",
            "Hospitalisation si confirme",
            "Repos strict +++ (risque mort subite a l'effort)"
        ],
        nonFaire: [
            "Sport pendant plusieurs mois",
            "Negliger une fatigue anormale post-virale"
        ]
    },

    pericardite: {
        nom: "Pericardite / Tamponnade",
        description: "Inflammation du pericarde. Si epanchement abondant = tamponnade = urgence vitale.",
        niveau: "orange",
        criteres: [
            { texte: "Douleur thoracique", champ: "douleurThorax", op: "==", val: true },
            { texte: "Fievre moderee", champ: "fievre", op: "==", val: true },
            { texte: "Dyspnee", champ: "respiration", op: "==", val: true }
        ],
        exclusions: [],
        urgence: {
            condition: (data) => data.respiration && data.fatigueLevel === 'prostration' && data.extremitesFroides,
            message: "TAMPONNADE suspectee - Echographie urgente"
        },
        alertes: [
            "Tamponnade : dyspnee + turgescence jugulaire + hypotension + pouls paradoxal",
            "Choc cardiogenique"
        ],
        conseils: [
            "ECG (sus-decalage ST diffus, sous-decalage PR)",
            "Echographie cardiaque urgente",
            "AINS ou Colchicine si simple",
            "Drainage si tamponnade"
        ],
        nonFaire: []
    },

    endocardite: {
        nom: "Endocardite infectieuse",
        description: "Infection des valves cardiaques. Fievre prolongee inexpliquee = evoquer systematiquement.",
        niveau: "orange",
        criteres: [
            { texte: "Fievre prolongee > 5 jours", champ: "fievreDuree", op: "==", val: "5j-plus" },
            { texte: "Fatigue", champ: "fatigue", op: "==", val: true },
            { texte: "Ganglions", champ: "ganglions", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Toux", champ: "toux", op: "==", val: true },
            { texte: "Rhinite", champ: "nez", op: "==", val: true },
            { texte: "Angine", champ: "gorge", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.fievreDuree === '5j-plus' && data.confusion,
            message: "Fievre prolongee + confusion - ENDOCARDITE ? - Hemocultures"
        },
        alertes: [
            "Insuffisance cardiaque",
            "Emboles cerebraux (AVC)",
            "Emboles spleniques, renaux"
        ],
        conseils: [
            "Hemocultures multiples AVANT antibiotherapie",
            "Echographie cardiaque (ETO si besoin)",
            "Antibiotherapie prolongee IV",
            "Avis cardio-chirurgical"
        ],
        nonFaire: [
            "Antibiotherapie avant hemocultures (sauf sepsis severe)"
        ]
    },

    // ============================================
    // NEUROLOGIQUES
    // ============================================

    meningite: {
        nom: "Meningite",
        description: "Infection des meninges. URGENCE VITALE. Tout retard peut etre fatal.",
        niveau: "rouge",
        criteres: [
            { texte: "Fievre elevee", champ: "temp", op: ">=", val: 38.5 },
            { texte: "Cephalees intenses", champ: "cephaleeType", op: "in", val: ["intense", "brutal"] },
            { texte: "Raideur de nuque", champ: "raideurNuque", op: "==", val: true },
            { texte: "Signe de Kernig", champ: "kernig", op: "==", val: true },
            { texte: "Signe de Brudzinski", champ: "brudzinski", op: "==", val: true },
            { texte: "Photophobie", champ: "photophobie", op: "==", val: true },
            { texte: "Vomissements en jet", champ: "vomissements", op: "==", val: true },
            { texte: "Confusion/somnolence", champ: "confusion", op: "==", val: true },
            { texte: "Purpura", champ: "eruptionType", op: "==", val: "purpura" }
        ],
        exclusions: [],
        urgence: {
            condition: (data) => data.raideurNuque && data.fievre && (data.confusion || data.eruptionType === 'purpura' || data.kernig || data.brudzinski),
            message: "MENINGITE - SAMU immediat - Si purpura : C3G sur place"
        },
        alertes: [
            "TOUS ces symptomes sont des alertes",
            "Purpura = URGENCE ABSOLUE (appeler 15)",
            "Signes de Kernig/Brudzinski = haute specificite"
        ],
        conseils: [
            "APPELER LE 15 IMMEDIATEMENT",
            "Ne pas attendre"
        ],
        nonFaire: [
            "Attendre",
            "Essayer de traiter soi-meme"
        ]
    },

    encephalite_herpes: {
        nom: "Encephalite herpetique",
        description: "Infection cerebrale par HSV. Mortalite > 70% sans traitement. TRAITER AVANT CONFIRMATION.",
        niveau: "rouge",
        criteres: [
            { texte: "Fievre", champ: "fievre", op: "==", val: true },
            { texte: "Confusion/troubles comportement", champ: "confusion", op: "==", val: true },
            { texte: "Convulsions", champ: "convulsions", op: "==", val: true },
            { texte: "Cephalees", champ: "cephaleeType", op: "in", val: ["intense", "brutal"] }
        ],
        exclusions: [
            { texte: "Raideur de nuque franche", champ: "raideurNuque", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.fievre && data.confusion && data.convulsions,
            message: "ENCEPHALITE HERPETIQUE - Aciclovir IV AVANT resultats"
        },
        alertes: [
            "TOUS ces signes = URGENCE ABSOLUE",
            "Evolution rapide vers coma"
        ],
        conseils: [
            "Aciclovir IV IMMEDIATEMENT - AVANT resultats",
            "PL + IRM + EEG",
            "Ne pas attendre confirmation pour traiter",
            "Reanimation souvent necessaire"
        ],
        nonFaire: [
            "Attendre la PCR pour traiter",
            "Retarder l'aciclovir"
        ]
    },

    guillain_barre: {
        nom: "Syndrome de Guillain-Barre",
        description: "Polyradiculonevrite aigue post-infectieuse. Paralysie ascendante. Risque de paralysie respiratoire.",
        niveau: "orange",
        criteres: [
            { texte: "Infection recente (1-4 sem avant)", champ: "diarrhee", op: "==", val: true },
            { texte: "Paresthesies extremites", champ: "paresthesies", op: "==", val: true },
            { texte: "Faiblesse musculaire ascendante", champ: "faiblesseMusculaire", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Fievre", champ: "fievre", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.faiblesseMusculaire && data.respiration,
            message: "Guillain-Barre avec atteinte respiratoire - Reanimation"
        },
        alertes: [
            "Atteinte respiratoire (capacite vitale < 60%)",
            "Troubles de deglutition",
            "Dysautonomie (variations tension/pouls)"
        ],
        conseils: [
            "Hospitalisation systematique",
            "Surveillance capacite vitale repetee",
            "Immunoglobulines IV ou plasmapherese",
            "Reanimation si atteinte respiratoire"
        ],
        nonFaire: [
            "Corticoides (inefficaces)",
            "Traiter en ambulatoire"
        ]
    },

    htic: {
        nom: "Hypertension intracranienne (HTIC)",
        description: "Augmentation de la pression dans le crane. Causes multiples : tumeur, hydrocephalie...",
        niveau: "rouge",
        criteres: [
            { texte: "Cephalees matinales", champ: "cephalee", op: "==", val: true },
            { texte: "Vomissements en jet", champ: "vomiFreq", op: "==", val: "incoercible" },
            { texte: "Troubles visuels", champ: "visionTrouble", op: "==", val: true },
            { texte: "Troubles de conscience", champ: "confusion", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Fievre", champ: "fievre", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.cephalee && data.vomissements && data.confusion && !data.fievre,
            message: "HTIC - Scanner URGENT - NE PAS faire de PL"
        },
        alertes: [
            "Troubles de conscience",
            "Anisocorie (mydriase unilaterale) = engagement",
            "Triade de Cushing (HTA + bradycardie + troubles respi)"
        ],
        conseils: [
            "Scanner cerebral URGENT",
            "NE PAS faire de PL si suspicion HTIC",
            "Position demi-assise",
            "Traitement selon cause"
        ],
        nonFaire: [
            "PL si HTIC suspectee (risque d'engagement)",
            "Retarder l'imagerie"
        ]
    },

    avc_pediatrique: {
        nom: "AVC pediatrique",
        description: "Rare mais existe. Retard diagnostic frequent car 'ca n'arrive pas aux enfants'.",
        niveau: "rouge",
        criteres: [
            { texte: "Deficit neurologique brutal", champ: "faiblesseMusculaire", op: "==", val: true },
            { texte: "Cephalee brutale intense", champ: "cephaleeType", op: "==", val: "brutal" },
            { texte: "Troubles de conscience", champ: "confusion", op: "==", val: true },
            { texte: "Convulsions", champ: "convulsions", op: "==", val: true },
            { texte: "Troubles visuels", champ: "visionTrouble", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Fievre", champ: "fievre", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.cephaleeType === 'brutal' && data.confusion && !data.fievre,
            message: "AVC - Imagerie URGENTE - Thrombolyse si < 4h30"
        },
        alertes: [
            "Tous ces signes = imagerie urgente"
        ],
        conseils: [
            "IRM cerebrale en urgence (ou scanner si IRM non dispo)",
            "Thrombolyse possible si < 4h30 (selon protocole)",
            "Recherche etiologique (cardiopathie, drepanocytose, SAPL...)"
        ],
        nonFaire: [
            "Retarder car 'c'est un enfant, ca ne peut pas etre un AVC'"
        ]
    },

    // ============================================
    // INFECTIEUSES GRAVES
    // ============================================

    sepsis_choc: {
        nom: "Sepsis / Choc septique",
        description: "Reponse inflammatoire systemique a une infection. Mortalite elevee. Chaque heure compte.",
        niveau: "rouge",
        criteres: [
            { texte: "Fievre (ou hypothermie)", champ: "fievre", op: "==", val: true },
            { texte: "Extremites froides", champ: "extremitesFroides", op: "==", val: true },
            { texte: "Douleur HCD", champ: "abdoLoc", op: "==", val: "hcd" },
            { texte: "Ictere", champ: "ictere", op: "==", val: true }
        ],
        exclusions: [],
        urgence: {
            condition: (data) => data.abdoLoc === 'hcd' && data.ictere,
            message: "Intox paracetamol suspectee - NAC < 8h - Paracetamolemie H4"
        },
        alertes: [
            "Delai > 8h = efficacite antidote reduite",
            "Paracetamolemie H4"
        ],
        conseils: [
            "N-acetylcysteine (NAC) le plus tot possible",
            "Efficace meme apres 8h (moins bien)",
            "Paracetamolemie a H4",
            "Charbon active si < 1h"
        ],
        nonFaire: [
            "Se rassurer car 'pas de symptomes'",
            "Attendre les symptomes pour traiter"
        ]
    },

    intox_co: {
        nom: "Intoxication au monoxyde de carbone (CO)",
        description: "Gaz inodore. Cephalees + nausees touchant plusieurs personnes = evocateur. Urgence vitale.",
        niveau: "rouge",
        criteres: [
            { texte: "Cephalees", champ: "cephalee", op: "==", val: true },
            { texte: "Vertiges", champ: "vertiges", op: "==", val: true },
            { texte: "Nausees/vomissements", champ: "vomissements", op: "==", val: true },
            { texte: "Confusion", champ: "confusion", op: "==", val: true },
            { texte: "Cas groupes", champ: "collectivite", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Fievre", champ: "fievre", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.cephalee && data.vertiges && data.collectivite && !data.fievre,
            message: "INTOX CO - Evacuer - O2 100% - SAMU"
        },
        alertes: [
            "Perte de connaissance",
            "Troubles du rythme",
            "Grossesse = urgence absolue"
        ],
        conseils: [
            "Evacuer les lieux, aerer",
            "Appeler les secours (15, 18)",
            "Oxygene 100% MHC",
            "Caisson hyperbare si formes graves"
        ],
        nonFaire: [
            "Rester dans les locaux"
        ]
    },

    // ============================================
    // URGENCES PEDIATRIQUES SPECIFIQUES
    // ============================================

    kawasaki: {
        nom: "Maladie de Kawasaki",
        description: "Vascularite febrile aigue. Risque de complications coronariennes si non traitee. Urgence diagnostique.",
        niveau: "orange",
        criteres: [
            { texte: "Fievre = 5 jours", champ: "fievreDuree", op: "==", val: "5j-plus" },
            { texte: "Conjonctivite bilaterale", champ: "yeuxTypes", op: "contains", val: "rouge" },
            { texte: "Levres fissurees", champ: "levresFissures", op: "==", val: true },
            { texte: "Langue framboisee", champ: "langueType", op: "==", val: "framboise" },
            { texte: "Eruption cutanee", champ: "eruption", op: "==", val: true },
            { texte: "Ganglions cervicaux", champ: "ganglions", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Toux", champ: "toux", op: "==", val: true },
            { texte: "Rhinite", champ: "nez", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.fievreDuree === '5j-plus' && data.yeux && (data.levresFissures || data.langueType === 'framboise'),
            message: "KAWASAKI - Hospitalisation - Immunoglobulines - Risque coronarien"
        },
        alertes: [
            "Tous ces symptomes necessitent une hospitalisation",
            "Risque d'anevrismes coronariens"
        ],
        conseils: [
            "Hospitalisation pour bilan et traitement (immunoglobulines)",
            "Echocardiographie systematique"
        ],
        nonFaire: [
            "Attendre que la fievre passe"
        ]
    },

    anaphylaxie: {
        nom: "Reaction anaphylactique",
        description: "Reaction allergique severe generalisee. URGENCE VITALE. Peut evoluer tres rapidement.",
        niveau: "rouge",
        criteres: [
            { texte: "Urticaire/eruption generalisee", champ: "eruption", op: "==", val: true },
            { texte: "Gonflement visage/levres/langue", champ: "oedeme", op: "==", val: true },
            { texte: "Gonflement visage/levres/langue", champ: "oedemeLoc", op: "in", val: ["visage", "levres"] },
            { texte: "Difficultes respiratoires", champ: "respiration", op: "==", val: true },
            { texte: "Malaise/vertige", champ: "vertiges", op: "==", val: true },
            { texte: "Nausees/vomissements", champ: "nausees", op: "==", val: true },
            { texte: "Paleur", champ: "paleur", op: "==", val: true }
        ],
        exclusions: [],
        urgence: {
            condition: (data) => data.eruption && (data.respiration || (data.oedeme && data.oedemeLoc === 'levres')),
            message: "ANAPHYLAXIE - ADRENALINE IM - SAMU"
        },
        alertes: [
            "TOUS ces symptomes sont des alertes majeures"
        ],
        conseils: [
            "APPELER LE 15 IMMEDIATEMENT",
            "Adrenaline si stylo disponible (Anapen, EpiPen)",
            "Position allongee jambes surelevees (sauf si gene respiratoire)",
            "Ne jamais laisser seul"
        ],
        nonFaire: [
            "Attendre",
            "Faire asseoir ou debout si malaise"
        ]
    },

    // ============================================
    // URGENCES CHIRURGICALES SPECIFIQUES
    // ============================================

    torsion_testiculaire: {
        nom: "Torsion testiculaire",
        description: "Rotation du testicule sur son axe vasculaire. URGENCE CHIRURGICALE < 6h sinon necrose.",
        niveau: "rouge",
        criteres: [
            { texte: "Douleur testiculaire", champ: "douleurTesticule", op: "==", val: true },
            { texte: "Debut brutal", champ: "testiculeDebut", op: "==", val: "brutal" },
            { texte: "Testicule remonte", champ: "testiculeSignes", op: "contains", val: "haut" },
            { texte: "Testicule gonfle", champ: "testiculeSignes", op: "contains", val: "gonfle" },
            { texte: "Nausees/vomissements", champ: "nausees", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Fievre", champ: "fievre", op: "==", val: true },
            { texte: "Brulures urinaires", champ: "urinaireTypes", op: "contains", val: "brulure" }
        ],
        urgence: {
            condition: (data) => data.douleurTesticule && data.testiculeDebut === 'brutal',
            message: "TORSION TESTICULAIRE - Chirurgie < 6h - URGENCE ABSOLUE"
        },
        alertes: [
            "Delai < 6h pour sauver le testicule",
            "Douleur brutale + testicule ascensionne = torsion jusqu'a preuve du contraire"
        ],
        conseils: [
            "Urgences chirurgicales IMMEDIATES",
            "Ne pas manger ni boire (chirurgie probable)",
            "Echographie-doppler si doute mais ne doit pas retarder la chirurgie"
        ],
        nonFaire: [
            "Attendre",
            "Traiter comme infection",
            "Retarder pour examens"
        ]
    },

    geu: {
        nom: "Grossesse extra-uterine (GEU)",
        description: "Grossesse implantee hors de l'uterus. Risque de rupture hemorragique. Urgence vitale potentielle.",
        niveau: "rouge",
        criteres: [
            { texte: "Retard de regles", champ: "retardRegles", op: "==", val: true },
            { texte: "Grossesse possible", champ: "grossessePossible", op: "==", val: true },
            { texte: "Douleur pelvienne", champ: "douleurPelvienne", op: "==", val: true },
            { texte: "Douleur brutale", champ: "pelvienDebut", op: "==", val: "brutal" },
            { texte: "Saignements vaginaux", champ: "metrorragies", op: "==", val: true },
            { texte: "Malaise/vertiges", champ: "vertiges", op: "==", val: true },
            { texte: "Paleur", champ: "paleur", op: "==", val: true }
        ],
        exclusions: [],
        urgence: {
            condition: (data) => data.grossessePossible && data.douleurPelvienne && (data.vertiges || data.paleur),
            message: "GEU ROMPUE suspectee - SAMU - Choc hemorragique possible"
        },
        alertes: [
            "Douleur pelvienne + retard regles + malaise = GEU jusqu'a preuve du contraire",
            "Choc hemorragique si rupture",
            "Douleur scapulaire (epaule) = signe de rupture"
        ],
        conseils: [
            "Test de grossesse IMMEDIAT",
            "Echographie pelvienne urgente",
            "Bilan sanguin (ÃŸHCG, NFS, groupe)",
            "Voie veineuse si instable"
        ],
        nonFaire: [
            "Rassurer sans test de grossesse",
            "Attendre si instable"
        ]
    },

    botulisme: {
        nom: "Botulisme",
        description: "Intoxication par toxine de Clostridium botulinum. Paralysie descendante. Urgence vitale.",
        niveau: "rouge",
        criteres: [
            { texte: "Conserve maison", champ: "conserveMaison", op: "==", val: true },
            { texte: "Vision trouble/double", champ: "visionTrouble", op: "==", val: true },
            { texte: "Paupieres tombantes", champ: "paupieresTombantes", op: "==", val: true },
            { texte: "Difficulte a parler", champ: "difficulteParler", op: "==", val: true },
            { texte: "Difficulte a avaler", champ: "gorgeType", op: "==", val: "avaler" },
            { texte: "Faiblesse musculaire", champ: "faiblesseMusculaire", op: "==", val: true },
            { texte: "Constipation", champ: "constipation", op: "==", val: true }
        ],
        exclusions: [
            { texte: "Fievre", champ: "fievre", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.conserveMaison && (data.visionTrouble || data.paupieresTombantes || data.difficulteParler),
            message: "BOTULISME - Antitoxine urgente - Reanimation"
        },
        alertes: [
            "Paralysie descendante (yeux ? gorge ? membres ? respiration)",
            "Risque de paralysie respiratoire",
            "Pas de fievre (? infection)"
        ],
        conseils: [
            "Reanimation - surveillance respiratoire",
            "Antitoxine botulique",
            "Signalement obligatoire (ARS)",
            "Conserver les aliments suspects"
        ],
        nonFaire: [
            "Faire vomir (toxine deja absorbee)",
            "Sous-estimer les signes oculaires"
        ]
    },

    // ============================================
    // HEMATOLOGIQUES
    // ============================================

    crise_vasoocclusive: {
        nom: "Crise vaso-occlusive (drepanocytose)",
        description: "Obstruction vasculaire par globules rouges falciformes. Douleurs intenses. Urgence chez le drepanocytaire.",
        niveau: "orange",
        criteres: [
            { texte: "Drepanocytose connue", champ: "drepanocytose", op: "==", val: true },
            { texte: "Douleurs osseuses intenses", champ: "douleurMembre", op: "==", val: true },
            { texte: "Douleur thoracique", champ: "douleurThorax", op: "==", val: true },
            { texte: "Douleur abdominale", champ: "douleurAbdo", op: "==", val: true },
            { texte: "Fievre", champ: "fievre", op: "==", val: true }
        ],
        exclusions: [],
        urgence: {
            condition: (data) => data.drepanocytose && (data.respiration || data.temp >= 38.5 || data.fatigueLevel === 'prostration'),
            message: "CVO compliquee - Syndrome thoracique aigu ? - Hospitalisation urgente"
        },
        alertes: [
            "Fievre > 38.5C = infection sur asplenie fonctionnelle",
            "Dyspnee = syndrome thoracique aigu",
            "Priapisme (erection douloureuse prolongee)",
            "AVC (deficit neurologique)"
        ],
        conseils: [
            "Hyperhydratation",
            "Antalgiques palier 2-3 (morphine souvent necessaire)",
            "Oxygenotherapie si SpO2 < 95%",
            "Antibiotherapie si fievre"
        ],
        nonFaire: [
            "Sous-estimer la douleur",
            "Retarder les antalgiques"
        ]
    },

    pti: {
        nom: "Purpura thrombopenique (PTI)",
        description: "Destruction auto-immune des plaquettes. Saignements spontanes. Generalement benin mais surveiller.",
        niveau: "orange",
        criteres: [
            { texte: "Saignements spontanes", champ: "saignements", op: "==", val: true },
            { texte: "Saignements de nez", champ: "saignSignes", op: "contains", val: "nez" },
            { texte: "Saignements des gencives", champ: "saignSignes", op: "contains", val: "gencives" },
            { texte: "Ecchymoses spontanees", champ: "saignSignes", op: "contains", val: "ecchymoses" },
            { texte: "Purpura petechial", champ: "eruptionType", op: "==", val: "purpura" }
        ],
        exclusions: [
            { texte: "Fievre", champ: "fievre", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.saignements && data.cephalee,
            message: "PTI + cephalees - Hemorragie cerebrale ? - Scanner urgent"
        },
        alertes: [
            "Cephalees intenses = hemorragie cerebrale ?",
            "Sang dans urines ou selles",
            "Saignement ne s'arretant pas"
        ],
        conseils: [
            "NFS en urgence (plaquettes)",
            "Eviter traumatismes",
            "Corticoides si plaquettes tres basses",
            "Immunoglobulines si hemorragie active"
        ],
        nonFaire: [
            "Aspirine / AINS",
            "Sports de contact",
            "Injections intramusculaires"
        ]
    },

    arthrite_septique: {
        nom: "Arthrite septique",
        description: "Infection bacterienne d'une articulation. Urgence chirurgicale pour lavage articulaire.",
        niveau: "orange",
        criteres: [
            { texte: "Douleur articulaire", champ: "douleurMembre", op: "==", val: true },
            { texte: "Articulation gonflee", champ: "membreSignes", op: "contains", val: "gonfle" },
            { texte: "Articulation rouge/chaude", champ: "membreSignes", op: "contains", val: "rouge" },
            { texte: "Boiterie", champ: "membreSignes", op: "contains", val: "boiterie" },
            { texte: "Fievre", champ: "fievre", op: "==", val: true },
            { texte: "Refus d'appui", champ: "douleurMembre", op: "==", val: true }
        ],
        exclusions: [],
        urgence: {
            condition: (data) => data.fievre && data.douleurMembre && data.membreSignes && data.membreSignes.includes('gonfle'),
            message: "ARTHRITE SEPTIQUE - Ponction + ATB IV urgents"
        },
        alertes: [
            "Articulation chaude, gonflee, douloureuse + fievre = septique jusqu'a preuve du contraire",
            "Destruction articulaire rapide si non traitee"
        ],
        conseils: [
            "Ponction articulaire urgente (diagnostic + traitement)",
            "Antibiotherapie IV apres ponction",
            "Immobilisation",
            "Lavage chirurgical souvent necessaire"
        ],
        nonFaire: [
            "AINS seuls sans bilan",
            "Retarder la ponction"
        ]
    },

    // ============================================
    // TRAUMATOLOGIE (urgences de base)
    // ============================================

    tc_pci: {
        nom: "Traumatisme cranien avec PCI",
        description: "Choc a la tete avec perte de connaissance initiale. Risque d'hematome intracranien.",
        niveau: "rouge",
        criteres: [
            { texte: "Traumatisme cranien", champ: "traumaCrane", op: "==", val: true },
            { texte: "Perte de connaissance", champ: "traumaPCI", op: "==", val: true },
            { texte: "Amnesie du choc", champ: "traumaAmnesia", op: "==", val: true },
            { texte: "Confusion", champ: "confusion", op: "==", val: true },
            { texte: "Vomissements repetes", champ: "vomiFreq", op: "in", val: ["repetes", "incoercible"] },
            { texte: "Cephalees intenses", champ: "cephaleeType", op: "in", val: ["intense", "brutal"] }
        ],
        exclusions: [],
        urgence: {
            condition: (data) => data.traumaCrane && (data.traumaPCI || data.confusion || data.convulsions),
            message: "TC avec PCI/confusion - Scanner cerebral urgent"
        },
        alertes: [
            "Intervalle libre puis aggravation = hematome extradural",
            "Vomissements repetes",
            "Anisocorie (pupilles asymetriques)",
            "Convulsions post-traumatiques"
        ],
        conseils: [
            "Scanner cerebral si PCI > 1 min ou signes d'alerte",
            "Surveillance 24-48h",
            "Reveiller toutes les 2-3h la premiere nuit"
        ],
        nonFaire: [
            "Laisser dormir sans surveillance",
            "Donner des sedatifs"
        ]
    },

    fracture: {
        nom: "Fracture",
        description: "Rupture osseuse. Deformation visible et/ou craquement au moment du choc. Immobilisation urgente.",
        niveau: "orange",
        criteres: [
            { texte: "Traumatisme membre", champ: "traumaMembre", op: "==", val: true },
            { texte: "Deformation visible", champ: "traumaDeformation", op: "==", val: true },
            { texte: "Plaie avec os visible", champ: "traumaOuvert", op: "==", val: true },
            { texte: "Craquement entendu", champ: "traumaCraquement", op: "==", val: true },
            { texte: "Impossibilite totale de bouger", champ: "traumaImpotence", op: "==", val: true },
            { texte: "Gonflement rapide", champ: "traumaGonflement", op: "==", val: true },
            { texte: "Choc direct ou chute", champ: "traumaMecanisme", op: "in", val: ["chute", "choc"] }
        ],
        exclusions: [
            { texte: "Appui/mouvement possible", champ: "traumaAppuiPossible", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.traumaDeformation || data.traumaOuvert,
            message: "Fracture deplacee/ouverte - Urgences chirurgicales"
        },
        alertes: [
            "Fracture ouverte (os visible) = urgence absolue",
            "Paleur/froideur du membre = atteinte vasculaire",
            "Fourmillements = atteinte nerveuse"
        ],
        conseils: [
            "Immobiliser le membre en l'etat",
            "Glacer (poche de glace protegee)",
            "Ne pas tenter de reduire",
            "Radio en urgence"
        ],
        nonFaire: [
            "Mobiliser le membre",
            "Tenter de remettre en place"
        ]
    },

    luxation: {
        nom: "Luxation",
        description: "Deboitement articulaire complet. Articulation deformee, en position anormale. Reduction urgente.",
        niveau: "orange",
        criteres: [
            { texte: "Traumatisme membre", champ: "traumaMembre", op: "==", val: true },
            { texte: "Deformation visible", champ: "traumaDeformation", op: "==", val: true },
            { texte: "Impossibilite totale de bouger", champ: "traumaImpotence", op: "==", val: true },
            { texte: "Articulation instable", champ: "traumaInstabilite", op: "==", val: true },
            { texte: "Douleur epaule", champ: "douleurEpaule", op: "==", val: true },
            { texte: "Epaule touchee", champ: "traumaZone", op: "contains", val: "epaule" },
            { texte: "Chute ou traction", champ: "traumaMecanisme", op: "in", val: ["chute", "etirement"] }
        ],
        exclusions: [
            { texte: "Appui/mouvement possible", champ: "traumaAppuiPossible", op: "==", val: true }
        ],
        urgence: {
            condition: (data) => data.traumaDeformation && data.traumaImpotence,
            message: "Luxation probable - Reduction urgente < 6h"
        },
        alertes: [
            "Deformation = luxation = urgence",
            "Impossibilite totale de bouger",
            "Paleur/froideur = compression vasculaire"
        ],
        conseils: [
            "Immobiliser en position antalgique",
            "Ne pas tenter de reduire soi-meme",
            "Urgences pour reduction sous sedation",
            "Radio avant et apres reduction"
        ],
        nonFaire: [
            "Tenter de remettre en place",
            "Forcer le mouvement"
        ]
    },

    entorse: {
        nom: "Entorse",
        description: "Etirement ou dechirure partielle des ligaments. Articulation en place mais douloureuse et gonflee.",
        niveau: "jaune",
        criteres: [
            { texte: "Traumatisme membre", champ: "traumaMembre", op: "==", val: true },
            { texte: "Torsion / faux mouvement", champ: "traumaMecanisme", op: "==", val: "torsion" },
            { texte: "Gonflement", champ: "traumaGonflement", op: "==", val: true },
            { texte: "Hematome / bleu", champ: "traumaHematome", op: "==", val: true },
            { texte: "Appui possible mais douloureux", champ: "traumaAppuiPossible", op: "==", val: true },
            { texte: "Cheville touchee", champ: "traumaZone", op: "contains", val: "cheville" }
        ],
        exclusions: [
            { texte: "Deformation visible", champ: "traumaDeformation", op: "==", val: true },
            { texte: "Impossibilite totale de bouger", champ: "traumaImpotence", op: "==", val: true },
            { texte: "Instabilite articulaire", champ: "traumaInstabilite", op: "==", val: true }
        ],
        urgence: null,
        alertes: [
            "Gonflement tres important = entorse grave",
            "Instabilite = rupture ligamentaire",
            "Craquement + instabilite = gravite ++"
        ],
        conseils: [
            "GREC : Glace, Repos, Elevation, Compression",
            "Attelle ou contention",
            "Radio si doute sur fracture",
            "Consultation sous 48-72h si pas d'amelioration"
        ],
        nonFaire: [
            "Marcher si tres gonfle",
            "Chaleur les premiers jours",
            "Masser la zone"
        ]
    },

    rupture_ligamentaire: {
        nom: "Rupture ligamentaire",
        description: "Dechirure complete d'un ligament. Articulation instable, sensation de lachage.",
        niveau: "orange",
        criteres: [
            { texte: "Traumatisme membre", champ: "traumaMembre", op: "==", val: true },
            { texte: "Articulation instable / lache", champ: "traumaInstabilite", op: "==", val: true },
            { texte: "Craquement entendu", champ: "traumaCraquement", op: "==", val: true },
            { texte: "Gonflement rapide", champ: "traumaGonflement", op: "==", val: true },
            { texte: "Hematome important", champ: "traumaHematome", op: "==", val: true },
            { texte: "Torsion / faux mouvement", champ: "traumaMecanisme", op: "==", val: "torsion" },
            { texte: "Genou touche", champ: "traumaZone", op: "contains", val: "genou" }
        ],
        exclusions: [
            { texte: "Deformation visible", champ: "traumaDeformation", op: "==", val: true }
        ],
        urgence: null,
        alertes: [
            "Craquement + instabilite = rupture probable",
            "Genou : LCA, LCP, menisque",
            "Cheville : ligament lateral externe"
        ],
        conseils: [
            "Immobilisation stricte",
            "Consultation orthopedique rapide",
            "IRM souvent necessaire",
            "Chirurgie parfois indiquee"
        ],
        nonFaire: [
            "Reprendre le sport",
            "Sous-estimer l'instabilite"
        ]
    }

};

// ============================================
// MOTEUR DE SCORING GENERIQUE
// ============================================

function evaluer(data, critere) {
    const v = data[critere.champ];
    
    // Gestion des valeurs vides/absentes
    if (v === null || v === undefined || v === '') {
        if (critere.op === '==' && critere.val === false) return true;
        if (critere.op === '!=' && critere.val === true) return true;
        return false;
    }
    
    switch (critere.op) {
        case '==': return v === critere.val;
        case '!=': return v !== critere.val;
        case '>=': return parseFloat(v) >= critere.val;
        case '<=': return parseFloat(v) <= critere.val;
        case '>': return parseFloat(v) > critere.val;
        case '<': return parseFloat(v) < critere.val;
        case 'in': return critere.val.includes(v);
        case 'contains': return Array.isArray(v) && v.includes(critere.val);
    }
    return false;
}

// Red flags : criteres critiques ponderes x3
const RED_FLAGS = {
    // Champs booleens
    raideurNuque: true,
    kernig: true,
    brudzinski: true,
    convulsions: true,
    confusion: true,
    faiblesseMusculaire: true,
    // Valeurs specifiques
    eruptionType: ['purpura'],
    respiType: ['tirage', 'cyanose'],
    paleurType: ['marbrures'],
    gorgeType: ['bave'],
    fatigueLevel: ['prostration'],
    vomiType: ['sang'],
    diarrheeType: ['sang'],
    diarrheeCouleur: ['sang', 'noire'],
    testiculeDebut: ['brutal'],
    cephaleeType: ['brutal']
};

function estRedFlag(critere, data) {
    const champ = critere.champ;
    const val = critere.val;
    
    // Si c'est un champ booleen red flag
    if (RED_FLAGS[champ] === true && val === true) {
        return true;
    }
    
    // Si c'est une valeur specifique red flag
    if (Array.isArray(RED_FLAGS[champ])) {
        if (typeof val === 'string' && RED_FLAGS[champ].includes(val)) {
            return true;
        }
        // Pour les operateurs 'in' avec des valeurs red flag
        if (critere.op === 'in' && Array.isArray(val)) {
            return val.some(v => RED_FLAGS[champ].includes(v));
        }
    }
    
    // Temperature >= 40
    if (champ === 'temp' && critere.op === '>=' && val >= 40) {
        return true;
    }
    
    return false;
}

function scorerMaladie(data, maladie) {
    let score = 0;
    let scoreMax = 0;
    let matches = [];
    
    // Criteres positifs avec ponderation
    for (const c of maladie.criteres) {
        const poids = estRedFlag(c, data) ? 3 : 1;
        scoreMax += poids;
        
        if (evaluer(data, c)) {
            score += poids;
            matches.push(c.texte);
        }
    }
    
    // Exclusions (diminuent le score de 1)
    for (const e of maladie.exclusions || []) {
        if (evaluer(data, e)) {
            score--;
            matches.push('(-) ' + e.texte);
        }
    }
    
    return {
        score: Math.max(0, score),
        max: scoreMax,
        pourcent: scoreMax > 0 ? Math.round(100 * Math.max(0, score) / scoreMax) : 0,
        matches: matches
    };
}

function scorer(data) {
    const resultats = [];
    const drapeaux = [];
    
    for (const [id, m] of Object.entries(maladiesDB)) {
        const r = scorerMaladie(data, m);
        
        // Seulement si score > 0
        if (r.score > 0) {
            resultats.push({
                id: id,
                nom: m.nom,
                niveau: m.niveau,
                description: m.description,
                score: r.score,
                max: r.max,
                pourcent: r.pourcent,
                matches: r.matches,
                alertes: m.alertes,
                conseils: m.conseils,
                nonFaire: m.nonFaire
            });
        }
        
        // Verification urgences (red flags)
        if (m.urgence && m.urgence.condition(data)) {
            drapeaux.push({
                niveau: m.niveau,
                maladie: m.nom,
                message: m.urgence.message
            });
        }
    }
    
    // Tri par pourcentage decroissant
    resultats.sort((a, b) => b.pourcent - a.pourcent);
    
    return { resultats, drapeaux };
}

// Export pour utilisation
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { maladiesDB, evaluer, scorerMaladie, scorer };
}








// === SWITCH MODE ===
function switchMode(mode) {
    document.querySelectorAll('.mode-switch button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('#mode-triage, #mode-reverse, #mode-suivi').forEach(d => d.classList.remove('active'));
    document.getElementById('mode-' + mode).classList.add('active');
    event.target.classList.add('active');
    if (mode === 'suivi') initSuivi();
}

// === TOGGLE SUB-OPTIONS ===
function toggleSub(checkbox) {
    const subId = 'sub-' + checkbox.id;
    const subDiv = document.getElementById(subId);
    if (subDiv) subDiv.classList.toggle('visible', checkbox.checked);
}

// === COLLECTE DONNEES ===
function getVal(name) {
    const el = document.querySelector(`input[name="${name}"]:checked`);
    return el ? el.value : null;
}
function isChecked(id) {
    const el = document.getElementById(id);
    return el ? el.checked : false;
}
function getCheckedValues(name) {
    const els = document.querySelectorAll(`input[name="${name}"]:checked`);
    return Array.from(els).map(e => e.value);
}

function collecterDonnees() {
    return {
        // Etat general
        fievre: isChecked('fievre'),
        temp: getVal('temp') ? parseFloat(getVal('temp')) : null,
        fievreDuree: getVal('fievre-duree'),
        fatigue: isChecked('fatigue'),
        fatigueLevel: getVal('fatigue-level'),
        appetit: isChecked('appetit'),
        frissons: isChecked('frissons'),
        courbatures: isChecked('courbatures'),
        douleurYeux: isChecked('douleur-yeux'),
        paleur: isChecked('paleur'),
        paleurType: getVal('paleur-type'),
        douleurThorax: isChecked('douleurThorax'),
        
        // Constantes vitales
        hasSpo2: isChecked('hasSpo2'),
        spo2Val: getVal('spo2-val'),
        hasFc: isChecked('hasFc'),
        fcAge: getVal('fc-age'),
        fcValue: document.getElementById('fc-value')?.value || null,
        hasFr: isChecked('hasFr'),
        frAge: getVal('fr-age'),
        frValue: document.getElementById('fr-value')?.value || null,
        hasTa: isChecked('hasTa'),
        taSys: document.getElementById('ta-sys')?.value || null,
        taDia: document.getElementById('ta-dia')?.value || null,
        hasGlycemie: isChecked('hasGlycemie'),
        glycemieVal: document.getElementById('glycemie-val')?.value || null,
        
        // ORL/Respi
        toux: isChecked('toux'),
        touxType: getVal('toux-type'),
        touxDuree: getVal('toux-duree'),
        touxQuinte: getCheckedValues('toux-quinte'),
        nez: isChecked('nez'),
        nezType: getVal('nez-type'),
        gorge: isChecked('gorge'),
        gorgeType: getVal('gorge-type'),
        voix: isChecked('voix'),
        respiration: isChecked('respiration'),
        respiType: getVal('respi-type'),
        oreille: isChecked('oreille'),
        oreilleEcoul: isChecked('oreilleEcoul'),
        anosmie: isChecked('anosmie'),
        difficulteParler: isChecked('difficulteParler'),
        
        // Digestif
        vomissements: isChecked('vomissements'),
        vomiType: getVal('vomi-type'),
        vomiFreq: getVal('vomi-freq'),
        diarrhee: isChecked('diarrhee'),
        diarrheeType: getVal('diarrhee-type'),
        diarrheeCouleur: getVal('diarrhee-couleur'),
        nausees: isChecked('nausees'),
        douleurAbdo: isChecked('douleurAbdo'),
        abdoLoc: getVal('abdo-loc'),
        abdoCarac: getCheckedValues('abdo-carac'),
        abdoAppend: getCheckedValues('abdo-append'),
        constipation: isChecked('constipation'),
        deshydratation: isChecked('deshydratation'),
        deshSignes: getCheckedValues('desh'),
        
        // Cutane
        eruption: isChecked('eruption'),
        eruptionType: getVal('eruption-type'),
        eruptionLoc: getCheckedValues('eruption-loc'),
        eruptionGratte: isChecked('eruptionGratte'),
        eruptionTexture: getCheckedValues('eruption-texture'),
        eruptionEvolution: getVal('eruption-evolution'),
        aphtes: isChecked('aphtes'),
        oedeme: isChecked('oedeme'),
        oedemeLoc: getVal('oedeme-loc'),
        ictere: isChecked('ictere'),
        saignements: isChecked('saignements'),
        saignSignes: getCheckedValues('saign'),
        plaie: isChecked('plaie'),
        plaieType: getVal('plaie-type'),
        plaieSaignement: getVal('plaie-saignement'),
        plaieLoc: getCheckedValues('plaie-loc'),
        plaieCorpsEtranger: isChecked('plaieCorpsEtranger'),
        plaieSale: isChecked('plaieSale'),
        plaieMobiliteReduite: isChecked('plaieMobiliteReduite'),
        
        // Neuro
        cephalee: isChecked('cephalee'),
        cephaleeType: getVal('cephalee-type'),
        raideurNuque: isChecked('raideurNuque'),
        kernig: isChecked('kernig'),
        brudzinski: isChecked('brudzinski'),
        convulsions: isChecked('convulsions'),
        confusion: isChecked('confusion'),
        vertiges: isChecked('vertiges'),
        photophobie: isChecked('photophobie'),
        visionTrouble: isChecked('visionTrouble'),
        paupieresTombantes: isChecked('paupieresTombantes'),
        faiblesseMusculaire: isChecked('faiblesseMusculaire'),
        paresthesies: isChecked('paresthesies'),
        
        // Autres
        ganglions: isChecked('ganglions'),
        ganglionsLoc: getVal('ganglions-loc'),
        yeux: isChecked('yeux'),
        yeuxTypes: getCheckedValues('yeux-type'),
        langue: isChecked('langue'),
        langueType: getVal('langue-type'),
        levresFissures: isChecked('levresFissures'),
        douleurArticulaire: isChecked('douleurArticulaire'),
        articIntensite: getVal('artic-intensite'),
        
        // Urinaire
        urinaire: isChecked('urinaire'),
        urinaireTypes: getCheckedValues('urinaire-types'),
        urinesCouleur: getVal('urines-couleur'),
        douleurLombaire: isChecked('douleurLombaire'),
        
        // Osteo
        douleurMembre: isChecked('douleurMembre'),
        membreSignes: getCheckedValues('membre-signes'),
        douleurEpaule: isChecked('douleurEpaule'),
        
        // Genital garcon
        douleurTesticule: isChecked('douleurTesticule'),
        testiculeDebut: getVal('testicule-debut'),
        testiculeSignes: getCheckedValues('testicule-signes'),
        
        // Gyneco
        douleurPelvienne: isChecked('douleurPelvienne'),
        pelvienDebut: getVal('pelvien-debut'),
        metrorragies: isChecked('metrorragies'),
        retardRegles: isChecked('retardRegles'),
        grossessePossible: isChecked('grossessePossible'),
        
        // Contexte
        repasSuspect: isChecked('repasSuspect'),
        conserveMaison: isChecked('conserveMaison'),
        collectivite: isChecked('collectivite'),
        baignade: isChecked('baignade'),
        drepanocytose: isChecked('drepanocytose'),
        asthme: isChecked('asthme'),
        asthmeTriggers: getCheckedValues('asthme-trigger'),
        immunodepression: isChecked('immunodepression'),
        zonePalu: isChecked('zonePalu'),
        paluZone: getVal('palu-zone'),
        vaccinStatut: getVal('vaccin-statut'),
        
        // Traumatologie
        traumaCrane: isChecked('traumaCrane'),
        traumaPCI: isChecked('traumaPCI'),
        traumaAmnesia: isChecked('traumaAmnesia'),
        traumaMembre: isChecked('traumaMembre'),
        traumaDeformation: isChecked('traumaDeformation'),
        traumaOuvert: isChecked('traumaOuvert'),
        traumaInstabilite: isChecked('traumaInstabilite'),
        traumaCraquement: isChecked('traumaCraquement'),
        traumaGonflement: isChecked('traumaGonflement'),
        traumaHematome: isChecked('traumaHematome'),
        traumaImpotence: isChecked('traumaImpotence'),
        traumaAppuiPossible: isChecked('traumaAppuiPossible'),
        traumaZone: getCheckedValues('trauma-zone'),
        traumaMecanisme: getVal('trauma-mecanisme')
    };
}

// === MAPPING CHAMPS DB -> DONNEES UTILISATEUR ===
// Pour savoir si un critere de la DB est coche par l'utilisateur
function champEstCoche(data, critere) {
    return evaluer(data, critere);
}

// === ANALYSER ===
function analyser() {
    const data = collecterDonnees();
    console.log('Donnees:', data);
    
    // Verifier qu'il y a au moins un symptome
    const hasSymptom = Object.values(data).some(v => v === true || (Array.isArray(v) && v.length > 0) || (typeof v === 'number'));
    if (!hasSymptom) {
        alert('Veuillez cocher au moins un symptome.');
        return;
    }
    
    // Utiliser le scorer de maladiesDB.js
    const { resultats, drapeaux } = scorer(data);
    
    // IDs des maladies avec drapeau d'urgence
    const maladiesAvecDrapeau = new Set(drapeaux.map(d => {
        // Trouver l'ID de la maladie depuis son nom
        for (const [id, m] of Object.entries(maladiesDB)) {
            if (m.nom === d.maladie) return id;
        }
        return null;
    }).filter(Boolean));
    
    // Filtrer selon seuil : 2/3, 3/4, 4/5+
    // SAUF si la maladie a un drapeau d'urgence
    const resultatsFiltres = resultats.filter(r => {
        // Toujours garder les maladies avec drapeau
        if (maladiesAvecDrapeau.has(r.id)) return true;
        
        const nbCriteres = r.max;
        const nbMatchsPositifs = r.matches.filter(m => !m.startsWith('(-)')).length;
        if (nbCriteres <= 3) return nbMatchsPositifs >= 2;
        if (nbCriteres === 4) return nbMatchsPositifs >= 3;
        return nbMatchsPositifs >= 4; // 5 criteres ou plus
    });
    
    afficherResultat(resultatsFiltres, drapeaux, data);
}

// === TRIAGE OFFICIEL (CTAS / ESI / FRENCH) ===
function calculerTriageOfficiel(data, drapeaux) {
    
    // Analyse des constantes vitales
    let fcAlerte = null;
    if (data.hasFc && data.fcValue && data.fcAge) {
        const fc = parseInt(data.fcValue);
        const fcMax = { '6-8': 110, '9-12': 105, '13-15': 100 };
        const fcMin = { '6-8': 70, '9-12': 65, '13-15': 60 };
        if (fc > 170 || fc < 50) fcAlerte = 'rouge';
        else if (fc > fcMax[data.fcAge] + 30 || fc < fcMin[data.fcAge] - 10) fcAlerte = 'orange';
    }
    
    let frAlerte = null;
    if (data.hasFr && data.frValue && data.frAge) {
        const fr = parseInt(data.frValue);
        const frMax = { '6-8': 24, '9-12': 22, '13-15': 20 };
        if (fr > 40 || fr < 10) frAlerte = 'rouge';
        else if (fr > frMax[data.frAge] + 8) frAlerte = 'orange';
    }
    
    let taAlerte = null;
    if (data.hasTa && data.taSys) {
        const sys = parseInt(data.taSys);
        if (sys < 70 || sys > 180) taAlerte = 'rouge';
        else if (sys < 85 || sys > 140) taAlerte = 'orange';
    }
    
    let glycemieAlerte = null;
    if (data.hasGlycemie && data.glycemieVal) {
        const gly = parseFloat(data.glycemieVal);
        if (gly < 0.4 || gly > 4) glycemieAlerte = 'rouge';
        else if (gly < 0.6 || gly > 2.5) glycemieAlerte = 'orange';
    }
    
    // ===== CTAS (Canadian Triage and Acuity Scale) =====
    let ctas = 5;
    let ctasRaison = "Pas de critere de gravite identifie";
    
    // CTAS 1 - Reanimation
    if (drapeaux.length > 0 ||
        data.convulsions ||
        data.respiType === 'cyanose' ||
        data.fatigueLevel === 'prostration' ||
        data.confusion ||
        (data.faiblesseMusculaire && data.respiration) ||
        (data.hasSpo2 && data.spo2Val === '90') ||
        fcAlerte === 'rouge' || frAlerte === 'rouge' || taAlerte === 'rouge' || glycemieAlerte === 'rouge') {
        ctas = 1;
        ctasRaison = "Detresse vitale / Drapeau rouge critique";
    }
    // CTAS 2 - Tres urgent
    else if (
        data.respiType === 'tirage' ||
        (data.hasSpo2 && data.spo2Val === '92') ||
        data.cephaleeType === 'brutal' ||
        data.paleurType === 'marbrures' ||
        data.gorgeType === 'bave' ||
        (data.fievre && data.temp >= 40 && data.fatigueLevel === 'marquee') ||
        (data.fievre && data.raideurNuque) ||
        (data.fievre && data.eruptionType === 'purpura') ||
        (data.abdoCarac && data.abdoCarac.includes('defense')) ||
        (data.saignements && data.fievre) ||
        fcAlerte === 'orange' || frAlerte === 'orange' || taAlerte === 'orange' || glycemieAlerte === 'orange') {
        ctas = 2;
        ctasRaison = "Signes de gravite necessitant evaluation rapide";
    }
    // CTAS 3 - Urgent
    else if (
        (data.fievre && data.temp >= 39) ||
        data.deshydratation ||
        data.vomiFreq === 'incoercible' ||
        data.respiType === 'rapide' || data.respiType === 'sifflante' ||
        data.touxType === 'aboyante' ||
        (data.douleurAbdo && data.abdoLoc === 'fid') ||
        (data.douleurLombaire && data.fievre) ||
        data.ictere) {
        ctas = 3;
        ctasRaison = "Symptomes necessitant evaluation dans les 30 min";
    }
    // CTAS 4 - Moins urgent
    else if (
        (data.fievre && data.temp >= 38) ||
        data.toux || data.nez || data.gorge ||
        data.oreille ||
        data.vomissements || data.diarrhee ||
        data.douleurAbdo ||
        data.eruption ||
        data.urinaire) {
        ctas = 4;
        ctasRaison = "Symptomes stables, evaluation dans l'heure";
    }
    
    // ===== ESI (Emergency Severity Index, USA) =====
    let esi = 5;
    let esiRaison = "Consultation simple, peu de ressources";
    
    // ESI 1 - Intervention immediate
    if (drapeaux.length > 0 ||
        data.convulsions ||
        data.respiType === 'cyanose' ||
        data.fatigueLevel === 'prostration' ||
        (data.faiblesseMusculaire && data.respiration) ||
        (data.hasSpo2 && data.spo2Val === '90') ||
        fcAlerte === 'rouge' || frAlerte === 'rouge' || taAlerte === 'rouge' || glycemieAlerte === 'rouge') {
        esi = 1;
        esiRaison = "Intervention vitale immediate requise";
    }
    // ESI 2 - Haut risque
    else if (
        data.confusion ||
        data.respiType === 'tirage' ||
        (data.hasSpo2 && data.spo2Val === '92') ||
        data.cephaleeType === 'brutal' ||
        (data.abdoCarac && data.abdoCarac.includes('defense')) ||
        (data.fievre && data.temp >= 40) ||
        data.paleurType === 'marbrures' ||
        data.gorgeType === 'bave' ||
        fcAlerte === 'orange' || frAlerte === 'orange' || taAlerte === 'orange' || glycemieAlerte === 'orange') {
        esi = 2;
        esiRaison = "Haut risque, ne doit pas attendre";
    }
    // ESI 3 - Multiple ressources
    else if (
        (data.fievre && data.temp >= 39) ||
        data.deshydratation ||
        (data.douleurAbdo && (data.abdoLoc === 'fid' || (data.abdoCarac && data.abdoCarac.includes('migration')))) ||
        (data.douleurLombaire && data.fievre) ||
        data.respiration ||
        data.ictere ||
        (data.membreSignes && data.membreSignes.includes('gonfle') && data.fievre)) {
        esi = 3;
        esiRaison = "Plusieurs examens/ressources probables";
    }
    // ESI 4 - Une ressource
    else if (
        data.fievre ||
        data.oreille ||
        data.gorge ||
        data.urinaire ||
        data.eruption ||
        data.vomissements || data.diarrhee) {
        esi = 4;
        esiRaison = "Une ressource (exam/prescription) probable";
    }
    
    // ===== FRENCH (SAMU / SFMU) =====
    let french = 4;
    let frenchRaison = "Consultation de medecine generale";
    
    // P1 - Urgence absolue
    if (drapeaux.length > 0 ||
        data.convulsions ||
        data.respiType === 'cyanose' ||
        data.fatigueLevel === 'prostration' ||
        data.confusion ||
        (data.fievre && data.raideurNuque) ||
        (data.fievre && data.eruptionType === 'purpura') ||
        (data.faiblesseMusculaire && data.respiration) ||
        (data.oedemeLoc === 'levres' && data.respiration) ||
        (data.hasSpo2 && data.spo2Val === '90') ||
        fcAlerte === 'rouge' || frAlerte === 'rouge' || taAlerte === 'rouge' || glycemieAlerte === 'rouge') {
        french = 1;
        frenchRaison = "Urgence vitale - SAMU 15";
    }
    // P2 - Urgence vraie
    else if (
        data.respiType === 'tirage' ||
        (data.abdoCarac && data.abdoCarac.includes('defense')) ||
        (data.fievre && data.temp >= 40) ||
        data.paleurType === 'marbrures' ||
        data.cephaleeType === 'brutal' ||
        data.gorgeType === 'bave' ||
        (data.saignements && data.fievre) ||
        (data.hasSpo2 && data.spo2Val === '92') ||
        fcAlerte === 'orange' || frAlerte === 'orange' || taAlerte === 'orange' || glycemieAlerte === 'orange') {
        french = 2;
        frenchRaison = "Urgence vraie - Consultation immediate";
    }
    // P3 - Urgence relative
    else if (
        (data.fievre && data.temp >= 39) ||
        data.deshydratation ||
        data.vomiFreq === 'incoercible' ||
        data.touxType === 'aboyante' ||
        (data.douleurAbdo && data.abdoLoc === 'fid') ||
        (data.douleurLombaire && data.fievre) ||
        data.ictere ||
        data.respiration) {
        french = 3;
        frenchRaison = "Urgence relative - Consultation dans la journee";
    }
    
    return {
        ctas: { niveau: ctas, raison: ctasRaison },
        esi: { niveau: esi, raison: esiRaison },
        french: { niveau: french, raison: frenchRaison },
        alertesConstantes: { fc: fcAlerte, fr: frAlerte, ta: taAlerte, glycemie: glycemieAlerte }
    };
}

// === AFFICHAGE RESULTATS AVEC CRITERES COLORES ===
function afficherResultat(resultats, drapeaux, data) {
    const div = document.getElementById('resultat');
    let html = '';
    
    // Determiner niveau global
    let niveau = 'vert';
    if (drapeaux.length > 0) niveau = 'rouge';
    else if (resultats.length > 0 && resultats[0].niveau === 'rouge') niveau = 'rouge';
    else if (resultats.length > 0 && resultats[0].niveau === 'orange') niveau = 'orange';
    else if (resultats.length > 0) niveau = 'jaune';
    
    const niveaux = {
        rouge: { icon: '&#x1F534;', titre: 'URGENCE - Appeler le 15' },
        orange: { icon: '&#x1F7E0;', titre: 'Consultation dans la journee' },
        jaune: { icon: '&#x1F7E1;', titre: 'Consultation sous 24-48h' },
        vert: { icon: '&#x1F7E2;', titre: 'Surveillance a domicile' }
    };
    
    div.className = 'niveau-' + niveau;
    html += `<h3><span style="font-size:1.5em">${niveaux[niveau].icon}</span> ${niveaux[niveau].titre}</h3>`;
    
    // Drapeaux rouges
    if (drapeaux.length > 0) {
        html += '<div class="alerte-rouge"><h4>&#x1F6A8; ALERTES URGENTES</h4>';
        drapeaux.forEach(d => html += `<p><strong>${d.maladie}</strong>: ${d.message}</p>`);
        html += '</div>';
    }
    
    // Pathologies candidates avec criteres colores
    if (resultats.length > 0) {
        html += '<div class="pathologies-probables"><h4>&#x1F50D; Hypotheses diagnostiques</h4>';
        
        resultats.slice(0, 8).forEach((r, idx) => {
            const m = maladiesDB[r.id];
            html += `<div class="patho-card ${idx === 0 ? 'top' : ''}">`;
            
            // Header
            html += '<div class="patho-header">';
            html += `<strong>${getNiveauIcon(r.niveau)} ${r.nom}</strong>`;
            html += `<span class="patho-score">${r.pourcent}%</span>`;
            html += '</div>';
            
            // Description
            html += `<div class="patho-desc">${r.description}</div>`;
            
            // CRITERES ATTENDUS (bleu pale, cercle vert si coche)
            // Dedoupliquer par texte, mais cercler vert si AU MOINS UN critere avec ce texte matche
            const criteresParTexte = {};
            m.criteres.forEach(c => {
                if (!criteresParTexte[c.texte]) criteresParTexte[c.texte] = [];
                criteresParTexte[c.texte].push(c);
            });
            html += '<div><small><strong>Criteres attendus :</strong></small>';
            html += '<div class="criteres-box">';
            for (const [texte, criteres] of Object.entries(criteresParTexte)) {
                const match = criteres.some(c => champEstCoche(data, c));
                html += `<span class="critere-tag critere-attendu ${match ? 'critere-match' : ''}">${texte}</span>`;
            }
            html += '</div></div>';
            
            // EXCLUSIONS (rouge pale, cercle vert si coche = probleme)
            if (m.exclusions && m.exclusions.length > 0) {
                const exclusionsParTexte = {};
                m.exclusions.forEach(e => {
                    if (!exclusionsParTexte[e.texte]) exclusionsParTexte[e.texte] = [];
                    exclusionsParTexte[e.texte].push(e);
                });
                html += '<div style="margin-top:6px"><small><strong>Filtres negatifs :</strong></small>';
                html += '<div class="criteres-box">';
                for (const [texte, exclusions] of Object.entries(exclusionsParTexte)) {
                    const match = exclusions.some(e => champEstCoche(data, e));
                    html += `<span class="critere-tag critere-exclusion ${match ? 'critere-match' : ''}">${texte}</span>`;
                }
                html += '</div></div>';
            }
            
            html += '</div>';
        });
        
        html += '</div>';
    } else {
        html += '<div class="pathologies-probables"><p>Aucune pathologie ne correspond precisement aux symptomes selectionnes.</p></div>';
    }
    
    // Conseils
    html += '<div class="conseils"><h4>&#x1F4A1; Conseils generaux</h4><ul>';
    if (niveau === 'rouge') {
        html += '<li><strong>Appelez le 15 (SAMU)</strong> ou rendez-vous aux urgences</li>';
    } else if (niveau === 'orange') {
        html += '<li>Consultez un medecin aujourd\'hui</li>';
        html += '<li>Si aggravation : appelez le 15</li>';
    } else if (niveau === 'jaune') {
        html += '<li>Prenez rendez-vous avec votre medecin</li>';
        html += '<li>Hydratation et repos en attendant</li>';
    } else {
        html += '<li>Repos et hydratation</li>';
        html += '<li>Paracetamol si fievre ou douleur</li>';
    }
    html += '</ul></div>';
    
    // Triage officiel (CTAS / ESI / SAMU)
    const triageOfficiel = calculerTriageOfficiel(data, drapeaux);
    
    html += '<div class="pathologies-probables" style="margin-top: 20px; background: #f8f9fa; border: 2px solid #6c757d;">';
    html += '<h4>&#x1F4CA; Niveaux de triage (protocoles officiels)</h4>';
    html += '<p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">Classification selon 3 standards internationaux :</p>';
    
    // CTAS
    const ctasColors = ['', '#dc3545', '#fd7e14', '#ffc107', '#28a745', '#17a2b8'];
    const ctasLabels = ['', 'Reanimation', 'Tres urgent', 'Urgent', 'Moins urgent', 'Non urgent'];
    const ctasDelais = ['', 'Immediat', '< 15 min', '< 30 min', '< 60 min', '< 120 min'];
    html += `<div style="display: flex; align-items: center; padding: 10px; margin: 5px 0; background: white; border-radius: 6px; border-left: 4px solid ${ctasColors[triageOfficiel.ctas.niveau]};">`;
    html += `<span style="font-weight: bold; min-width: 120px;">&#x1F1E8;&#x1F1E6; CTAS</span>`;
    html += `<span style="background: ${ctasColors[triageOfficiel.ctas.niveau]}; color: white; padding: 4px 12px; border-radius: 12px; font-weight: bold; margin-right: 10px;">Niveau ${triageOfficiel.ctas.niveau}</span>`;
    html += `<span style="flex: 1;">${ctasLabels[triageOfficiel.ctas.niveau]} (${ctasDelais[triageOfficiel.ctas.niveau]})</span>`;
    html += `</div>`;
    
    // ESI
    const esiColors = ['', '#dc3545', '#fd7e14', '#ffc107', '#28a745', '#17a2b8'];
    const esiLabels = ['', 'Reanimation', 'Haut risque', 'Urgence', 'Peu urgent', 'Non urgent'];
    html += `<div style="display: flex; align-items: center; padding: 10px; margin: 5px 0; background: white; border-radius: 6px; border-left: 4px solid ${esiColors[triageOfficiel.esi.niveau]};">`;
    html += `<span style="font-weight: bold; min-width: 120px;">&#x1F1FA;&#x1F1F8; ESI</span>`;
    html += `<span style="background: ${esiColors[triageOfficiel.esi.niveau]}; color: white; padding: 4px 12px; border-radius: 12px; font-weight: bold; margin-right: 10px;">Niveau ${triageOfficiel.esi.niveau}</span>`;
    html += `<span style="flex: 1;">${esiLabels[triageOfficiel.esi.niveau]}</span>`;
    html += `</div>`;
    
    // French SAMU
    const frenchColors = ['', '#dc3545', '#fd7e14', '#ffc107', '#28a745'];
    const frenchLabels = ['', 'P1 - Urgence absolue', 'P2 - Urgence vraie', 'P3 - Urgence relative', 'P4 - Consultation'];
    html += `<div style="display: flex; align-items: center; padding: 10px; margin: 5px 0; background: white; border-radius: 6px; border-left: 4px solid ${frenchColors[triageOfficiel.french.niveau]};">`;
    html += `<span style="font-weight: bold; min-width: 120px;">&#x1F1EB;&#x1F1F7; SAMU</span>`;
    html += `<span style="background: ${frenchColors[triageOfficiel.french.niveau]}; color: white; padding: 4px 12px; border-radius: 12px; font-weight: bold; margin-right: 10px;">${frenchLabels[triageOfficiel.french.niveau].split(' - ')[0]}</span>`;
    html += `<span style="flex: 1;">${frenchLabels[triageOfficiel.french.niveau].split(' - ')[1] || ''}</span>`;
    html += `</div>`;
    
    html += '<p style="font-size: 0.8em; color: #888; margin-top: 10px; margin-bottom: 0;">&#x26A0; Ces classifications sont indicatives et ne remplacent pas l\'avis medical.</p>';
    html += '</div>';
    
    // Alertes constantes vitales
    const ac = triageOfficiel.alertesConstantes;
    if (ac.fc || ac.fr || ac.ta || ac.glycemie) {
        html += '<div class="pathologies-probables" style="margin-top: 15px; background: #fff3cd; border: 2px solid #ffc107;">';
        html += '<h4>&#x1F4CF; Constantes vitales anormales</h4><ul>';
        if (ac.fc === 'rouge') html += '<li style="color:#dc3545"><strong>FC critique</strong> - Bradycardie/tachycardie severe</li>';
        else if (ac.fc === 'orange') html += '<li style="color:#fd7e14"><strong>FC anormale</strong> - A surveiller</li>';
        if (ac.fr === 'rouge') html += '<li style="color:#dc3545"><strong>FR critique</strong> - Detresse respiratoire</li>';
        else if (ac.fr === 'orange') html += '<li style="color:#fd7e14"><strong>FR elevee</strong> - Polypnee</li>';
        if (ac.ta === 'rouge') html += '<li style="color:#dc3545"><strong>TA critique</strong> - Choc ou HTA severe</li>';
        else if (ac.ta === 'orange') html += '<li style="color:#fd7e14"><strong>TA anormale</strong> - A surveiller</li>';
        if (ac.glycemie === 'rouge') html += '<li style="color:#dc3545"><strong>Glycemie critique</strong> - Hypo/hyperglycemie severe</li>';
        else if (ac.glycemie === 'orange') html += '<li style="color:#fd7e14"><strong>Glycemie anormale</strong> - A controler</li>';
        html += '</ul></div>';
    }
    
    // Surveillance
    html += '<div class="surveillance"><h4>&#x26A0; Reconsulter si :</h4><ul>';
    html += '<li>Fievre > 48-72h ou aggravation</li>';
    html += '<li>Difficultes respiratoires</li>';
    html += '<li>Prostration, somnolence</li>';
    html += '<li>Refus de boire</li>';
    html += '<li>Eruption qui ne s\'efface pas</li>';
    html += '</ul></div>';
    
    div.innerHTML = html;
    div.style.display = 'block';
    div.scrollIntoView({ behavior: 'smooth' });
}

function getNiveauIcon(niveau) {
    const icons = { vert: '&#x1F7E2;', jaune: '&#x1F7E1;', orange: '&#x1F7E0;', rouge: '&#x1F534;' };
    return icons[niveau] || '?';
}

// === EXPORTER SYMPTOMES COCHES ===
function exporterSymptomes() {
    const data = collecterDonnees();
    
    // Labels lisibles pour chaque champ
    const labels = {
        fievre: 'Fievre',
        temp: 'Temperature',
        fievreDuree: 'Duree fievre',
        fatigue: 'Fatigue',
        fatigueLevel: 'Niveau fatigue',
        appetit: 'Perte appetit',
        frissons: 'Frissons/sueurs',
        courbatures: 'Courbatures',
        douleurYeux: 'Douleur derriere yeux',
        paleur: 'Paleur',
        paleurType: 'Type paleur',
        douleurThorax: 'Douleur thoracique',
        hasSpo2: 'SpO2 mesuree',
        spo2Val: 'SpO2',
        hasFc: 'FC mesuree',
        fcAge: 'Tranche age FC',
        fcValue: 'FC',
        hasFr: 'FR mesuree',
        frAge: 'Tranche age FR',
        frValue: 'FR',
        hasTa: 'TA mesuree',
        taSys: 'TA systolique',
        taDia: 'TA diastolique',
        hasGlycemie: 'Glycemie mesuree',
        glycemieVal: 'Glycemie',
        toux: 'Toux',
        touxType: 'Type toux',
        touxDuree: 'Duree toux',
        touxQuinte: 'Signes quintes',
        nez: 'Nez qui coule',
        nezType: 'Type ecoulement',
        gorge: 'Mal de gorge',
        gorgeType: 'Type mal gorge',
        voix: 'Voix enrouee',
        respiration: 'Difficultes respiratoires',
        respiType: 'Type difficulte respi',
        oreille: 'Douleur oreille',
        oreilleEcoul: 'Ecoulement oreille',
        anosmie: 'Perte odorat/gout',
        difficulteParler: 'Difficulte a parler',
        vomissements: 'Vomissements',
        vomiType: 'Type vomissements',
        vomiFreq: 'Frequence vomissements',
        diarrhee: 'Diarrhee',
        diarrheeType: 'Type diarrhee',
        diarrheeCouleur: 'Couleur selles',
        nausees: 'Nausees',
        douleurAbdo: 'Douleur abdominale',
        abdoLoc: 'Localisation douleur',
        abdoCarac: 'Caracteristiques',
        abdoAppend: 'Signes appendice',
        constipation: 'Constipation/arret gaz',
        deshydratation: 'Deshydratation',
        deshSignes: 'Signes deshydratation',
        eruption: 'Eruption cutanee',
        eruptionType: 'Type eruption',
        eruptionLoc: 'Localisation eruption',
        eruptionGratte: 'Demangeaisons',
        eruptionTexture: 'Texture',
        eruptionEvolution: 'Evolution',
        aphtes: 'Aphtes/lesions buccales',
        oedeme: 'Gonflement',
        oedemeLoc: 'Localisation oedeme',
        ictere: 'Jaunisse',
        saignements: 'Saignements spontanes',
        saignSignes: 'Type saignements',
        plaie: 'Plaie/griffure',
        plaieType: 'Type plaie',
        plaieSaignement: 'Saignement plaie',
        plaieLoc: 'Localisation plaie',
        plaieCorpsEtranger: 'Corps etranger',
        plaieSale: 'Plaie souilee',
        plaieMobiliteReduite: 'Perte mobilite/sensibilite',
        cephalee: 'Maux de tete',
        cephaleeType: 'Intensite cephalees',
        raideurNuque: 'Raideur nuque',
        kernig: 'Signe Kernig',
        brudzinski: 'Signe Brudzinski',
        convulsions: 'Convulsions',
        confusion: 'Confusion/somnolence',
        vertiges: 'Vertiges',
        photophobie: 'Gene lumiere',
        visionTrouble: 'Vision trouble/double',
        paupieresTombantes: 'Paupieres tombantes',
        faiblesseMusculaire: 'Faiblesse musculaire',
        paresthesies: 'Fourmillements',
        ganglions: 'Ganglions',
        ganglionsLoc: 'Localisation ganglions',
        yeux: 'Probleme yeux',
        yeuxTypes: 'Type probleme yeux',
        langue: 'Aspect langue',
        langueType: 'Type langue',
        levresFissures: 'Levres fissurees',
        douleurArticulaire: 'Douleurs articulaires',
        articIntensite: 'Intensite douleur artic',
        urinaire: 'Problemes urinaires',
        urinaireTypes: 'Type probleme urinaire',
        urinesCouleur: 'Couleur urines',
        douleurLombaire: 'Douleur lombaire',
        douleurMembre: 'Douleur membre',
        membreSignes: 'Signes membre',
        douleurEpaule: 'Douleur epaule',
        douleurTesticule: 'Douleur testiculaire',
        testiculeDebut: 'Debut douleur testicule',
        testiculeSignes: 'Signes testicule',
        douleurPelvienne: 'Douleur pelvienne',
        pelvienDebut: 'Debut douleur pelvienne',
        metrorragies: 'Saignements vaginaux',
        retardRegles: 'Retard regles',
        grossessePossible: 'Grossesse possible',
        repasSuspect: 'Repas suspect',
        conserveMaison: 'Conserve maison',
        collectivite: 'Cas groupes',
        baignade: 'Baignade riviere',
        drepanocytose: 'Drepanocytose',
        asthme: 'Asthme connu',
        asthmeTriggers: 'Declencheurs asthme',
        immunodepression: 'Immunodeprime',
        zonePalu: 'Zone impaludee',
        paluZone: 'Region palu',
        vaccinStatut: 'Statut vaccinal',
        traumaCrane: 'Trauma cranien',
        traumaPCI: 'Perte connaissance',
        traumaAmnesia: 'Amnesie du choc',
        traumaMembre: 'Trauma membre',
        traumaDeformation: 'Deformation visible',
        traumaOuvert: 'Plaie avec os visible',
        traumaInstabilite: 'Articulation instable',
        traumaCraquement: 'Craquement entendu',
        traumaGonflement: 'Gonflement rapide',
        traumaHematome: 'Hematome',
        traumaImpotence: 'Impossibilite bouger',
        traumaAppuiPossible: 'Appui possible',
        traumaZone: 'Zone touchee',
        traumaMecanisme: 'Mecanisme trauma'
    };
    
    // Filtrer valeurs actives
    const lignes = [];
    
    for (const [key, val] of Object.entries(data)) {
        if (val === null || val === undefined || val === false || val === '') continue;
        if (Array.isArray(val) && val.length === 0) continue;
        
        const label = labels[key] || key;
        let valeur = val;
        
        // Formater les valeurs
        if (val === true) {
            valeur = 'Oui';
        } else if (Array.isArray(val)) {
            valeur = val.join(', ');
        }
        
        // Cas speciaux : plages de temperature
        if (key === 'temp') {
            const plages = {
                '38': '38 - 38.5C',
                '38.5': '38.5 - 39C',
                '39': '39 - 40C',
                '40': '> 40C'
            };
            valeur = plages[val] || val;
        }
        
        lignes.push(label + ' : ' + valeur);
    }
    
    if (lignes.length === 0) {
        alert('Aucun symptome coche.');
        return;
    }
    
    // Construire le texte
    const txt = 'SYMPTOMES OBSERVES\n' +
                '==================\n\n' +
                lignes.join('\n') +
                '\n\n--\nExport Triage Pediatrique - ' + new Date().toLocaleDateString('fr-FR');
    
    navigator.clipboard.writeText(txt).then(() => {
        alert('Copie !\n' + lignes.length + ' symptomes dans le presse-papiers.');
    }).catch(err => {
        prompt('Copier manuellement :', txt);
    });
}

// === RESET ===
function resetForm() {
    document.querySelectorAll('input[type="checkbox"]').forEach(e => e.checked = false);
    document.querySelectorAll('input[type="radio"]').forEach(e => e.checked = false);
    document.querySelectorAll('.sub-options').forEach(e => e.classList.remove('visible'));
    document.getElementById('resultat').style.display = 'none';
}

// === MODE REFERENCE : LISTE DYNAMIQUE ===
function genererListeMaladies() {
    const select = document.getElementById('maladie-select');
    
    // Grouper par categorie (base sur la position dans la DB)
    const categories = {};
    for (const [id, m] of Object.entries(maladiesDB)) {
        // Deduire categorie depuis le nom ou utiliser "Autre"
        let cat = 'Autre';
        if (/rhino|angine|otite|laryngite|bronchite|pneumonie|grippe|covid|coqueluche|epiglottite|abces_retro|ludwig/i.test(id)) cat = 'ORL / Respiratoire';
        else if (/gastro|tiac|appendicite|occlusion|hepatite|invagination|volvulus|pancreatite|ischemie_mesen/i.test(id)) cat = 'Digestif';
        else if (/varicelle|pmb|urticaire|scarlatine|roseole|rougeole|impetigo/i.test(id)) cat = 'Cutane';
        else if (/dengue|chikungunya|leptospirose|palu/i.test(id)) cat = 'Arboviroses / Tropical';
        else if (/meningite|encephalite|guillain|htic|avc/i.test(id)) cat = 'Neurologique';
        else if (/kawasaki|anaphylaxie|sepsis/i.test(id)) cat = 'Urgences pediatriques';
        else if (/cystite|pyelonephrite|torsion_test|geu/i.test(id)) cat = 'Uro-genital';
        else if (/myocardite|pericardite|endocardite/i.test(id)) cat = 'Cardiovasculaire';
        else if (/drepa|pti|crise_vaso/i.test(id)) cat = 'Hematologique';
        else if (/intox|botulisme/i.test(id)) cat = 'Toxicologique';
        else if (/herpes_ocul|zona_ophtal|cellulite_orb|conjonctivite/i.test(id)) cat = 'Ophtalmologique';
        else if (/arthrite_sept/i.test(id)) cat = 'Osteo-articulaire';
        else if (/tc_pci|fracture|entorse|luxation|rupture_ligam/i.test(id)) cat = 'Traumatologie';
        else if (/plaie_simple|plaie_suturer|plaie_hemor|plaie_morsure/i.test(id)) cat = 'Plaies / Griffures';
        else if (/mono|herpangine/i.test(id)) cat = 'Infections diverses';
        
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push({ id, nom: m.nom });
    }
    
    // Generer les optgroups
    for (const [cat, maladies] of Object.entries(categories)) {
        const optgroup = document.createElement('optgroup');
        optgroup.label = cat;
        maladies.sort((a, b) => a.nom.localeCompare(b.nom));
        maladies.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.id;
            opt.textContent = m.nom;
            optgroup.appendChild(opt);
        });
        select.appendChild(optgroup);
    }
}

// === AFFICHER MALADIE (REFERENCE) ===
function afficherMaladie() {
    const select = document.getElementById('maladie-select');
    const detailDiv = document.getElementById('maladie-detail');
    const maladieKey = select.value;
    
    if (!maladieKey) {
        detailDiv.innerHTML = '';
        return;
    }
    
    const m = maladiesDB[maladieKey];
    if (!m) return;
    
    const niveauLabels = {
        vert: '&#x1F7E2; Surveillance a domicile',
        jaune: '&#x1F7E1; Consultation sous 24-48h',
        orange: '&#x1F7E0; Consultation dans la journee',
        rouge: '&#x1F534; URGENCE - Appeler le 15'
    };
    
    let html = '<div class="maladie-detail">';
    html += `<h3>${m.nom}</h3>`;
    html += `<p>${m.description}</p>`;
    html += `<span class="section-niveau niveau-${m.niveau}">${niveauLabels[m.niveau]}</span>`;
    
    // Criteres (symptomes attendus)
    if (m.criteres && m.criteres.length > 0) {
        html += '<div class="maladie-section section-symptomes">';
        html += '<h4>? Symptomes typiques</h4><ul>';
        m.criteres.forEach(c => html += `<li>${c.texte}</li>`);
        html += '</ul></div>';
    }
    
    // Exclusions (symptomes absents)
    if (m.exclusions && m.exclusions.length > 0) {
        html += '<div class="maladie-section section-absents">';
        html += '<h4>? Symptomes habituellement absents</h4><ul>';
        m.exclusions.forEach(e => html += `<li>${e.texte}</li>`);
        html += '</ul></div>';
    }
    
    // Alertes
    if (m.alertes && m.alertes.length > 0) {
        html += '<div class="maladie-section section-alertes">';
        html += '<h4>&#x26A0; Signes d\'alerte</h4><ul>';
        m.alertes.forEach(a => html += `<li>${a}</li>`);
        html += '</ul></div>';
    }
    
    // Conseils
    if (m.conseils && m.conseils.length > 0) {
        html += '<div class="maladie-section section-conseils">';
        html += '<h4>&#x1F4A1; Conseils</h4><ul>';
        m.conseils.forEach(c => html += `<li>${c}</li>`);
        html += '</ul></div>';
    }
    
    // A ne pas faire
    if (m.nonFaire && m.nonFaire.length > 0) {
        html += '<div class="maladie-section section-alertes">';
        html += '<h4>&#x274C; A ne PAS faire</h4><ul>';
        m.nonFaire.forEach(n => html += `<li>${n}</li>`);
        html += '</ul></div>';
    }
    
    html += '</div>';
    detailDiv.innerHTML = html;
}

// ============================================
// MODE SUIVI - GESTION PATIENTS ET CONSTANTES
// ============================================

// Normes pediatriques par age
const NORMES_PEDIATRIQUES = {
    // FC : [min, max] par tranche d'age
    fc: { '6-8': [70, 110], '9-12': [65, 105], '13-15': [60, 100] },
    // FR : [min, max]
    fr: { '6-8': [18, 24], '9-12': [16, 22], '13-15': [12, 20] },
    // TA systolique : [min, max]
    taSys: { '6-8': [90, 115], '9-12': [95, 120], '13-15': [100, 125] },
    taDia: { '6-8': [55, 75], '9-12': [57, 78], '13-15': [60, 80] },
    // SpO2
    spo2: { min: 95 },
    // Temperature
    temp: { min: 36, max: 38 },
    // Glycemie
    glycemie: { min: 0.7, max: 1.1 }
};

function getTrancheAge(age) {
    if (age >= 6 && age <= 8) return '6-8';
    if (age >= 9 && age <= 12) return '9-12';
    return '13-15';
}

// Charger patients depuis localStorage
function getPatients() {
    const data = localStorage.getItem('triagePediatrique_patients');
    return data ? JSON.parse(data) : {};
}

// Sauvegarder patients
function savePatients(patients) {
    localStorage.setItem('triagePediatrique_patients', JSON.stringify(patients));
}

// Initialisation du mode suivi
function initSuivi() {
    const select = document.getElementById('patient-select');
    const patients = getPatients();
    
    // Vider et reconstruire la liste
    select.innerHTML = '<option value="">&#x1F464; Selectionner un patient</option>';
    for (const [id, p] of Object.entries(patients)) {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = `${p.prenom} ${p.initiale}. (${p.age} ans)`;
        select.appendChild(opt);
    }
}

// Ajouter un patient
function ajouterPatient() {
    const prenom = document.getElementById('new-patient-prenom').value.trim();
    const initiale = document.getElementById('new-patient-initiale').value.trim().toUpperCase();
    const age = parseInt(document.getElementById('new-patient-age').value);
    
    if (!prenom) { alert('Prenom requis'); return; }
    if (!initiale) { alert('Initiale requise'); return; }
    if (!age || age < 6 || age > 15) { alert('Ã‚ge entre 6 et 15 ans'); return; }
    
    const patients = getPatients();
    const id = 'p_' + Date.now();
    patients[id] = {
        prenom: prenom,
        initiale: initiale.charAt(0),
        age: age,
        mesures: []
    };
    savePatients(patients);
    
    // Reset champs
    document.getElementById('new-patient-prenom').value = '';
    document.getElementById('new-patient-initiale').value = '';
    document.getElementById('new-patient-age').value = '';
    
    // Rafraichir et selectionner
    initSuivi();
    document.getElementById('patient-select').value = id;
    chargerPatient();
}

// Supprimer le patient selectionne
function supprimerPatient() {
    const select = document.getElementById('patient-select');
    const id = select.value;
    if (!id) { alert('Selectionnez un patient'); return; }
    
    const patients = getPatients();
    const p = patients[id];
    if (!confirm(`Supprimer ${p.prenom} ${p.initiale}. et tout son historique ?`)) return;
    
    delete patients[id];
    savePatients(patients);
    initSuivi();
    chargerPatient();
}

// Charger un patient
function chargerPatient() {
    const select = document.getElementById('patient-select');
    const id = select.value;
    const formContainer = document.getElementById('constantes-form-container');
    const noPatientMsg = document.getElementById('no-patient-msg');
    
    if (!id) {
        formContainer.style.display = 'none';
        noPatientMsg.style.display = 'block';
        return;
    }
    
    formContainer.style.display = 'block';
    noPatientMsg.style.display = 'none';
    
    const patients = getPatients();
    const p = patients[id];
    document.getElementById('patient-nom-display').textContent = `${p.prenom} ${p.initiale}. (${p.age} ans)`;
    
    // Reset formulaire
    resetFormConstantes();
    
    // Afficher historique
    afficherHistorique(p);
}

// Reset formulaire constantes
function resetFormConstantes() {
    ['c-temp', 'c-fc', 'c-fr', 'c-spo2', 'c-ta-sys', 'c-ta-dia', 'c-glycemie', 'c-miction', 'c-hydratation'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    document.querySelectorAll('.eva-face').forEach(f => f.classList.remove('selected'));
    document.getElementById('export-container').innerHTML = '';
}

// Selection EVA
function selectEva(el) {
    document.querySelectorAll('.eva-face').forEach(f => f.classList.remove('selected'));
    el.classList.add('selected');
}

// Enregistrer constantes
function enregistrerConstantes() {
    const select = document.getElementById('patient-select');
    const id = select.value;
    if (!id) return;
    
    const patients = getPatients();
    const p = patients[id];
    
    // Collecter valeurs
    const mesure = {
        timestamp: new Date().toISOString(),
        temp: document.getElementById('c-temp').value || null,
        fc: document.getElementById('c-fc').value || null,
        fr: document.getElementById('c-fr').value || null,
        spo2: document.getElementById('c-spo2').value || null,
        taSys: document.getElementById('c-ta-sys').value || null,
        taDia: document.getElementById('c-ta-dia').value || null,
        glycemie: document.getElementById('c-glycemie').value || null,
        miction: document.getElementById('c-miction').value || null,
        hydratation: document.getElementById('c-hydratation').value || null,
        eva: null
    };
    
    // EVA
    const evaSelected = document.querySelector('.eva-face.selected');
    if (evaSelected) mesure.eva = evaSelected.dataset.val;
    
    // Verifier qu'au moins une valeur
    const hasValue = Object.entries(mesure).some(([k, v]) => k !== 'timestamp' && v !== null && v !== '');
    if (!hasValue) {
        alert('Saisissez au moins une constante');
        return;
    }
    
    // Convertir en nombres
    ['temp', 'fc', 'fr', 'spo2', 'taSys', 'taDia', 'glycemie', 'hydratation', 'eva'].forEach(k => {
        if (mesure[k] !== null && mesure[k] !== '') mesure[k] = parseFloat(mesure[k]);
        else mesure[k] = null;
    });
    
    p.mesures.push(mesure);
    savePatients(patients);
    
    resetFormConstantes();
    afficherHistorique(p);
}

// Evaluer si une constante est hors normes
function evaluerConstante(type, valeur, age) {
    if (valeur === null || valeur === undefined) return '';
    const tranche = getTrancheAge(age);
    
    switch (type) {
        case 'temp':
            if (valeur >= 40) return 'alerte';
            if (valeur >= 38.5) return 'warning';
            if (valeur < 36) return 'warning';
            if (valeur >= 38) return 'warning';
            return 'ok';
        case 'fc':
            const fcNorm = NORMES_PEDIATRIQUES.fc[tranche];
            if (valeur > fcNorm[1] + 30 || valeur < fcNorm[0] - 15) return 'alerte';
            if (valeur > fcNorm[1] || valeur < fcNorm[0]) return 'warning';
            return 'ok';
        case 'fr':
            const frNorm = NORMES_PEDIATRIQUES.fr[tranche];
            if (valeur > frNorm[1] + 10 || valeur < frNorm[0] - 5) return 'alerte';
            if (valeur > frNorm[1] || valeur < frNorm[0]) return 'warning';
            return 'ok';
        case 'spo2':
            if (valeur < 92) return 'alerte';
            if (valeur < 95) return 'warning';
            return 'ok';
        case 'taSys':
            const taSysNorm = NORMES_PEDIATRIQUES.taSys[tranche];
            if (valeur < 80 || valeur > 150) return 'alerte';
            if (valeur < taSysNorm[0] || valeur > taSysNorm[1]) return 'warning';
            return 'ok';
        case 'glycemie':
            if (valeur < 0.5 || valeur > 3) return 'alerte';
            if (valeur < 0.7 || valeur > 1.26) return 'warning';
            return 'ok';
        case 'eva':
            if (valeur >= 8) return 'alerte';
            if (valeur >= 5) return 'warning';
            return 'ok';
        default:
            return '';
    }
}

// Calculer delai depuis derniere miction
function calculerDelaiMiction(mesures) {
    // Trouver la derniere miction enregistree
    for (let i = mesures.length - 1; i >= 0; i--) {
        if (mesures[i].miction) {
            const now = new Date();
            const [h, m] = mesures[i].miction.split(':').map(Number);
            const mictionTime = new Date();
            mictionTime.setHours(h, m, 0, 0);
            
            // Si l'heure est dans le futur, c'etait hier
            if (mictionTime > now) mictionTime.setDate(mictionTime.getDate() - 1);
            
            const diffH = (now - mictionTime) / (1000 * 60 * 60);
            return diffH;
        }
    }
    return null;
}

// Afficher historique
function afficherHistorique(patient) {
    const container = document.getElementById('historique-container');
    const mesures = patient.mesures;
    
    if (mesures.length === 0) {
        container.innerHTML = '<div class="no-data">Aucune mesure enregistree.</div>';
        return;
    }
    
    // Filtrer sur 24h
    const now = new Date();
    const h24ago = new Date(now - 24 * 60 * 60 * 1000);
    const mesures24h = mesures.filter(m => new Date(m.timestamp) >= h24ago);
    
    let html = '<table class="historique-table">';
    html += '<thead><tr>';
    html += '<th>Heure</th><th>T</th><th>FC</th><th>FR</th><th>SpO2</th><th>TA</th><th>Gly</th><th>&#x1F4A7;</th><th>&#x1F6BD;</th><th>EVA</th>';
    html += '</tr></thead><tbody>';
    
    // Afficher du plus recent au plus ancien
    const delaiMiction = calculerDelaiMiction(mesures);
    
    mesures24h.slice().reverse().forEach(m => {
        const dt = new Date(m.timestamp);
        const heure = dt.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        
        html += '<tr>';
        html += `<td>${heure}</td>`;
        html += cellule(m.temp, 'temp', patient.age, 'C');
        html += cellule(m.fc, 'fc', patient.age, '');
        html += cellule(m.fr, 'fr', patient.age, '');
        html += cellule(m.spo2, 'spo2', patient.age, '%');
        html += `<td>${m.taSys && m.taDia ? m.taSys + '/' + m.taDia : '-'}</td>`;
        html += cellule(m.glycemie, 'glycemie', patient.age, '');
        html += `<td>${m.hydratation || '-'}</td>`;
        html += `<td>${m.miction || '-'}</td>`;
        html += cellule(m.eva, 'eva', patient.age, '');
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    
    // Alerte miction > 8h
    if (delaiMiction !== null && delaiMiction > 8) {
        html += `<div style="background:#f8d7da;padding:10px;border-radius:8px;margin-top:10px;color:#721c24;">
            <strong>&#x26A0; Alerte :</strong> Derniere miction il y a ${Math.round(delaiMiction)}h (> 8h)
        </div>`;
    }
    
    // Resume hydratation
    const totalHydrat = mesures24h.reduce((sum, m) => sum + (m.hydratation || 0), 0);
    if (totalHydrat > 0) {
        html += `<div style="background:#d4edda;padding:10px;border-radius:8px;margin-top:10px;color:#155724;">
            &#x1F4A7; Hydratation totale (24h) : <strong>${totalHydrat} mL</strong>
        </div>`;
    }
    
    container.innerHTML = html;
}

function cellule(val, type, age, unite) {
    if (val === null || val === undefined) return '<td>-</td>';
    const status = evaluerConstante(type, val, age);
    let cls = '';
    if (status === 'alerte') cls = 'val-alerte';
    else if (status === 'warning') cls = 'val-warning';
    else if (status === 'ok') cls = 'val-ok';
    return `<td class="${cls}">${val}${unite}</td>`;
}

// Exporter pour medecin
function exporterSuivi() {
    const select = document.getElementById('patient-select');
    const id = select.value;
    if (!id) return;
    
    const patients = getPatients();
    const p = patients[id];
    const tranche = getTrancheAge(p.age);
    
    let txt = `SUIVI PEDIATRIQUE - ${new Date().toLocaleDateString('fr-FR')}\n`;
    txt += `${'='.repeat(50)}\n\n`;
    txt += `Patient : ${p.prenom} ${p.initiale}.\n`;
    txt += `Ã‚ge : ${p.age} ans\n`;
    txt += `Normes FC : ${NORMES_PEDIATRIQUES.fc[tranche].join('-')} bpm\n`;
    txt += `Normes FR : ${NORMES_PEDIATRIQUES.fr[tranche].join('-')} /min\n\n`;
    
    txt += `MESURES (24 dernieres heures)\n`;
    txt += `${'-'.repeat(50)}\n`;
    
    const now = new Date();
    const h24ago = new Date(now - 24 * 60 * 60 * 1000);
    const mesures24h = p.mesures.filter(m => new Date(m.timestamp) >= h24ago);
    
    if (mesures24h.length === 0) {
        txt += 'Aucune mesure sur cette periode.\n';
    } else {
        mesures24h.forEach(m => {
            const dt = new Date(m.timestamp);
            txt += `\n${dt.toLocaleString('fr-FR')}\n`;
            if (m.temp !== null) txt += `  Temperature : ${m.temp}C ${evaluerConstante('temp', m.temp, p.age) !== 'ok' ? '!!' : ''}\n`;
            if (m.fc !== null) txt += `  FC : ${m.fc} bpm ${evaluerConstante('fc', m.fc, p.age) !== 'ok' ? '!!' : ''}\n`;
            if (m.fr !== null) txt += `  FR : ${m.fr}/min ${evaluerConstante('fr', m.fr, p.age) !== 'ok' ? '!!' : ''}\n`;
            if (m.spo2 !== null) txt += `  SpO2 : ${m.spo2}% ${evaluerConstante('spo2', m.spo2, p.age) !== 'ok' ? '!!' : ''}\n`;
            if (m.taSys !== null && m.taDia !== null) txt += `  TA : ${m.taSys}/${m.taDia} mmHg\n`;
            if (m.glycemie !== null) txt += `  Glycemie : ${m.glycemie} g/L ${evaluerConstante('glycemie', m.glycemie, p.age) !== 'ok' ? '!!' : ''}\n`;
            if (m.hydratation !== null) txt += `  Hydratation : ${m.hydratation} mL\n`;
            if (m.miction) txt += `  Derniere miction : ${m.miction}\n`;
            if (m.eva !== null) txt += `  EVA douleur : ${m.eva}/10 ${evaluerConstante('eva', m.eva, p.age) !== 'ok' ? '!!' : ''}\n`;
        });
        
        // Total hydratation
        const totalHydrat = mesures24h.reduce((sum, m) => sum + (m.hydratation || 0), 0);
        txt += `\nTotal hydratation 24h : ${totalHydrat} mL\n`;
        
        // Delai miction
        const delai = calculerDelaiMiction(p.mesures);
        if (delai !== null) {
            txt += `Delai depuis derniere miction : ${Math.round(delai)}h`;
            if (delai > 8) txt += ' !! (>8h)';
            txt += '\n';
        }
    }
    
    txt += `\n${'='.repeat(50)}\n`;
    txt += `Genere par Triage Pediatrique - ${new Date().toLocaleString('fr-FR')}\n`;
    
    // Afficher
    document.getElementById('export-container').innerHTML = `
        <div class="export-box">${txt}</div>
        <button style="margin-top:10px;padding:8px 15px;cursor:pointer;" onclick="copierExport()">&#x1F4CB; Copier</button>
    `;
}

function copierExport() {
    const box = document.querySelector('.export-box');
    if (box) {
        navigator.clipboard.writeText(box.textContent).then(() => {
            alert('Copie dans le presse-papiers !');
        });
    }
}

// Purger historique patient
function purgerPatient() {
    const select = document.getElementById('patient-select');
    const id = select.value;
    if (!id) return;
    
    const patients = getPatients();
    const p = patients[id];
    
    if (!confirm(`Supprimer tout l'historique de ${p.prenom} ${p.initiale}. ? (Le patient sera conserve)`)) return;
    
    p.mesures = [];
    savePatients(patients);
    afficherHistorique(p);
}

// ============================================
// DEBUG: Ctrl+Click pour voir les pathologies liees
// ============================================

// Convertir nom HTML (avec tirets) vers nom JS (camelCase)
function htmlToDbField(htmlName) {
    // Mapping explicite pour les cas speciaux
    const mapping = {
        'temp': 'temp',
        'fievre-duree': 'fievreDuree',
        'fatigue-level': 'fatigueLevel',
        'paleur-type': 'paleurType',
        'douleur-yeux': 'douleurYeux',
        'spo2-val': 'spo2Val',
        'fc-age': 'fcAge',
        'fc-value': 'fcValue',
        'fr-age': 'frAge',
        'fr-value': 'frValue',
        'ta-sys': 'taSys',
        'ta-dia': 'taDia',
        'glycemie-val': 'glycemieVal',
        'toux-type': 'touxType',
        'toux-duree': 'touxDuree',
        'toux-quinte': 'touxQuinte',
        'nez-type': 'nezType',
        'gorge-type': 'gorgeType',
        'respi-type': 'respiType',
        'vomi-type': 'vomiType',
        'vomi-freq': 'vomiFreq',
        'diarrhee-type': 'diarrheeType',
        'diarrhee-couleur': 'diarrheeCouleur',
        'abdo-loc': 'abdoLoc',
        'abdo-carac': 'abdoCarac',
        'abdo-append': 'abdoAppend',
        'desh': 'deshSignes',
        'eruption-type': 'eruptionType',
        'eruption-loc': 'eruptionLoc',
        'eruption-texture': 'eruptionTexture',
        'eruption-evolution': 'eruptionEvolution',
        'oedeme-loc': 'oedemeLoc',
        'saign': 'saignSignes',
        'cephalee-type': 'cephaleeType',
        'ganglions-loc': 'ganglionsLoc',
        'yeux-type': 'yeuxTypes',
        'langue-type': 'langueType',
        'artic-intensite': 'articIntensite',
        'urinaire-types': 'urinaireTypes',
        'urines-couleur': 'urinesCouleur',
        'membre-signes': 'membreSignes',
        'testicule-debut': 'testiculeDebut',
        'testicule-signes': 'testiculeSignes',
        'pelvien-debut': 'pelvienDebut',
        'asthme-trigger': 'asthmeTriggers',
        'palu-zone': 'paluZone',
        'vaccin-statut': 'vaccinStatut',
        'trauma-zone': 'traumaZone',
        'trauma-mecanisme': 'traumaMecanisme',
        'plaie-type': 'plaieType',
        'plaie-saignement': 'plaieSaignement',
        'plaie-loc': 'plaieLoc'
    };
    
    if (mapping[htmlName]) return mapping[htmlName];
    
    // Sinon conversion generique tiret vers camelCase
    return htmlName.replace(/-([a-z])/g, (g) => g[1].toUpperCase());
}

// Trouver toutes les pathologies qui utilisent un champ
function trouverPathologiesPourChamp(champ) {
    const resultats = { criteres: [], exclusions: [] };
    
    for (const [id, m] of Object.entries(maladiesDB)) {
        // Chercher dans criteres
        if (m.criteres) {
            for (const c of m.criteres) {
                if (c.champ === champ) {
                    resultats.criteres.push({
                        id: id,
                        nom: m.nom,
                        niveau: m.niveau,
                        detail: c.texte
                    });
                    break; // Une seule fois par pathologie
                }
            }
        }
        // Chercher dans exclusions
        if (m.exclusions) {
            for (const e of m.exclusions) {
                if (e.champ === champ) {
                    resultats.exclusions.push({
                        id: id,
                        nom: m.nom,
                        niveau: m.niveau,
                        detail: e.texte
                    });
                    break;
                }
            }
        }
    }
    
    return resultats;
}

// Afficher le tooltip
let debugTooltip = null;

function afficherDebugTooltip(e, champ, resultats) {
    // Supprimer tooltip existant
    if (debugTooltip) debugTooltip.remove();
    
    debugTooltip = document.createElement('div');
    debugTooltip.className = 'debug-tooltip';
    
    let html = `<h4>&#x1F50D; Champ : ${champ}</h4>`;
    html += `<div class="champ-info">Ctrl+Click pour debug</div>`;
    
    const total = resultats.criteres.length + resultats.exclusions.length;
    
    if (total === 0) {
        html += `<p class="no-patho">&#x274C; Aucune pathologie n'utilise ce champ !</p>`;
    } else {
        if (resultats.criteres.length > 0) {
            html += `<strong>&#x2705; Criteres (${resultats.criteres.length}) :</strong><ul class="patho-list">`;
            resultats.criteres.forEach(p => {
                html += `<li>${getNiveauIcon(p.niveau)} ${p.nom}</li>`;
            });
            html += '</ul>';
        }
        if (resultats.exclusions.length > 0) {
            html += `<strong>&#x274C; Exclusions (${resultats.exclusions.length}) :</strong><ul class="patho-list">`;
            resultats.exclusions.forEach(p => {
                html += `<li>${getNiveauIcon(p.niveau)} ${p.nom}</li>`;
            });
            html += '</ul>';
        }
    }
    
    debugTooltip.innerHTML = html;
    document.body.appendChild(debugTooltip);
    
    // Positionner pres du curseur
    const x = Math.min(e.clientX + 15, window.innerWidth - 370);
    const y = Math.min(e.clientY + 15, window.innerHeight - 420);
    debugTooltip.style.left = x + 'px';
    debugTooltip.style.top = y + 'px';
}

function masquerDebugTooltip() {
    if (debugTooltip) {
        debugTooltip.remove();
        debugTooltip = null;
    }
}

// Initialiser les event listeners
function initDebugCtrlClick() {
    const modeTriageDiv = document.getElementById('mode-triage');
    if (!modeTriageDiv) return;
    
    // Ecouter Ctrl+Click sur tous les inputs
    modeTriageDiv.addEventListener('click', function(e) {
        if (!e.ctrlKey) return;
        
        const input = e.target.closest('input');
        if (!input) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        // Determiner le champ DB
        let champ = null;
        if (input.type === 'checkbox') {
            champ = input.id || input.name;
        } else if (input.type === 'radio') {
            champ = input.name;
        }
        
        if (!champ) return;
        
        // Convertir vers nom DB
        const champDb = htmlToDbField(champ);
        
        // Chercher les pathologies
        const resultats = trouverPathologiesPourChamp(champDb);
        
        // Afficher
        afficherDebugTooltip(e, champDb, resultats);
    });
    
    // Masquer quand Ctrl relache
    document.addEventListener('keyup', function(e) {
        if (e.key === 'Control') {
            masquerDebugTooltip();
        }
    });
    
    // Masquer si clic ailleurs
    document.addEventListener('click', function(e) {
        if (!e.ctrlKey && debugTooltip) {
            masquerDebugTooltip();
        }
    });
}

// === INIT ===
document.addEventListener('DOMContentLoaded', function() {
    if (typeof maladiesDB !== 'undefined') {
        genererListeMaladies();
    } else {
        console.error('maladiesDB.js non charge');
    }
    // Init suivi si localStorage disponible
    if (typeof localStorage !== 'undefined') {
        initSuivi();
    }
    // Init debug Ctrl+Click
    initDebugCtrlClick();
});
</script>
</body>
</html>
